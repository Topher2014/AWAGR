{
  "title": "Fail2ban (日本語)",
  "url": "https://wiki.archlinux.org/title/Fail2ban_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "関連記事\n\n- Sshguard\n- セキュリティ\n\nFail2ban は、ログファイル (例:/var/log/httpd/error_log) をスキャンし、認証の試行回数が多すぎる、脆弱性のスキャンなど、悪意のある兆候を示す IP を禁止します。一般に、Fail2ban は、次に、次の IP アドレスを拒否するように ファイアウォール ルールを更新するために使用されます。指定された時間だけですが、他の任意のアクション (電子メールの送信など) も設定できます。\n\n- IP を禁止するソフトウェアを使用することで、些細な攻撃は止めることができますが、追加のデーモンとロギングの成功に依存します。\n- fail2ban を sshd などと併用することは、公開鍵認証などが有効になっている場合 には、通常は意味がありません。\n- また、VPN の代わりにもなりません。必要な場合を除き、サービスをインターネットに公開しないでください。\n- さらに、攻撃者があなたの IP アドレスを知っている場合、送信元ヘッダーを偽装したパケットを送信し、あなたの IP アドレスを使用禁止にすることができます。必ず ignoreip で IP を指定してください。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 インストール\n- 2 使い方 2.1 fail2ban-client\n- 3 設定 3.1 jails を有効にする 3.2 警告メールを受信する 3.3 ファイアウォールとサービス\n- 4 ヒントとテクニック 4.1 カスタム SSH jail 4.2 Systemd バックエンド: ジャーナルフィルタリング 4.3 サービスの強化\n- 5 参照\n\n- 2.1 fail2ban-client\n\n- 3.1 jails を有効にする\n- 3.2 警告メールを受信する\n- 3.3 ファイアウォールとサービス\n\n- 4.1 カスタム SSH jail\n- 4.2 Systemd バックエンド: ジャーナルフィルタリング\n- 4.3 サービスの強化\n\n"
    },
    {
      "title": "インストール",
      "level": 2,
      "content": "次のパッケージのいずれかを インストール して下さい:\n\n- fail2ban - 最新の安定バージョン。\n- fail2ban-gitAUR - マスターからの最新のコミット。\n\n"
    },
    {
      "title": "使い方",
      "level": 2,
      "content": "Fail2ban を 設定 し fail2ban.service を 起動/有効化 します:\n\n"
    },
    {
      "title": "fail2ban-client",
      "level": 3,
      "content": "failed2ban-client を使用すると、jail (リロード、再起動、ステータスなど) を監視して、使用可能なすべてのコマンドを表示できます:\n\n```\n$ fail2ban-client\n```\n\n有効なジェイルをすべて表示するには:\n\n```\n# fail2ban-client status\n```\n\nたとえば sshd などの jail のステータスを確認するには:\n\n```\n# fail2ban-client status sshd\n```\n\n```\nStatus for the jail: sshd\n|- Filter\n|  |- Currently failed: 1\n|  |- Total failed:     9\n|  `- Journal matches:  _SYSTEMD_UNIT=sshd.service + _COMM=sshd\n`- Actions\n   |- Currently banned: 1\n   |- Total banned:     1\n   `- Banned IP list:   0.0.0.0\n```\n\n禁止された IP を含むすべての jail のコンパクトバージョンの場合:\n\n```\n# fail2ban-client banned\n```\n\n```\n[{'sshd': ['192.168.100.50']}, {'apache-auth': []}]\n```\n\n"
    },
    {
      "title": "設定",
      "level": 2,
      "content": "アップグレード 中に /etc/fail2ban/jail.conf に対して pacman/Pacnew と Pacsave が作成される可能性があるため、jail.conf(5) § CONFIGURATION FILES FORMAT では、アップグレードを容易にする ために、ユーザーが /etc/fail2ban/jail.local ファイルを 作成 することをお勧めします。\n\nたとえば、デフォルトの禁止期間を 1 日に変更するには、次のようにします:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\nbantime = 1d\n```\n\nまたは、/etc/fail2ban/jail.d ディレクトリの下に別の name.local ファイルを作成します (例:/etc/fail2ban/jail.d/sshd.local\n\nfail2ban.service を 再起動 して設定の変更を適用します。\n\n"
    },
    {
      "title": "jails を有効にする",
      "level": 3,
      "content": "デフォルトでは、すべての jails は無効になっています。enabled = true を使用したい jails に 追加 します。たとえば、OpenSSH jails を有効にする場合:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[sshd]\nenabled = true\n```\n\n参照 Fail2ban#カスタム SSH jail\n\n"
    },
    {
      "title": "警告メールを受信する",
      "level": 3,
      "content": "誰かが禁止されたときに電子メールを受信したい場合は、SMTP クライアント (例:msmtp) を設定し、以下に示すようにデフォルトのアクションを変更する必要があります。\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\ndestemail = yourname@example.com\nsender = yourname@example.com\n\n# to ban & send an e-mail with whois report to the destemail.\naction = %(action_mw)s\n\n# same as action_mw but also send relevant log lines\n#action = %(action_mwl)s\n```\n\n"
    },
    {
      "title": "ファイアウォールとサービス",
      "level": 3,
      "content": "デフォルトでは、Fail2ban は iptables を使用します。ただし、ほとんどの ファイアウォール とサービスの設定は簡単です。たとえば、nftables を使用するには:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\nbanaction = nftables\nbanaction_allports = nftables[type=allports]\n```\n\n他の例については、/etc/fail2ban/action.d/ を参照してください。例:ufw.conf\n\n"
    },
    {
      "title": "カスタム SSH jail",
      "level": 3,
      "content": "/etc/fail2ban/jail.d/sshd.local を編集し、このセクションを追加して、ignoreip の信頼できる IP アドレスのリストを更新します:\n\n```\n/etc/fail2ban/jail.d/sshd.local\n```\n\n```\n[sshd]\nenabled   = true\nfilter    = sshd\nbanaction = iptables\nbackend   = systemd\nmaxretry  = 5\nfindtime  = 1d\nbantime   = 2w\nignoreip  = 127.0.0.1/8\n```\n\n- パスワードの失敗が正しく記録されないかもしれないので、fail2ban の完全な監視を許可するために、/etc/ssh/sshd_config で LogLevel VERBOSE を設定する必要があるかもしれません。\n- Fail2ban はバージョン 0.10 から IPv6 をサポートしています。それに合わせて ファイアウォール を適応してください、例えば ip6tables.service を 起動/有効化 など。\n- (ユニットファイルに LogNamespace=something を追加することで) ジャーナルの名前空間を使用する場合、backend を次のように設定することで、fail2ban にそれらのログを読ませることができます:backend = systemd[journalfiles=\"/var/log/journal/*.something/system.journal\"] のように設定します。\n\n- ufw のような iptables フロントエンドを使用する場合、iptables を使用する代わりに banaction = ufw を使用することができます。\n- また、/etc/shorewall/shorewall.conf の BLACKLIST を ALL に設定すると、IP アドレスを禁止するために追加されたルールは新しい接続だけに影響します。\n\n"
    },
    {
      "title": "Systemd バックエンド: ジャーナルフィルタリング",
      "level": 3,
      "content": "パフォーマンスを向上させるために systemd バックエンドを使用する場合は、journalmatch を使用してフィルターを設定します。たとえば、カーネルレベルのログメッセージのみを解析するには、次のようにします。\n\n```\n/etc/fail2ban/filter.d/fwdrop.local\n```\n\n```\n[Definition]\nfailregex = ^.*DROP_.*SRC=<ADDR> DST=.*$\njournalmatch = _TRANSPORT=kernel\n```\n\nこちらも参照 systemd.journal-fields(7)\n\n"
    },
    {
      "title": "サービスの強化",
      "level": 3,
      "content": "現在、Fail2ban は root として実行する必要があります。したがって、systemd を使用してプロセスを強化することを検討することをお勧めします。\n\nfail2ban.service の ドロップイン 設定ファイルを 作成:\n\n```\n/etc/systemd/system/fail2ban.service.d/override.conf\n```\n\n```\n[Service]\nPrivateDevices=yes\nPrivateTmp=yes\nProtectHome=read-only\nProtectSystem=strict\nReadWritePaths=-/var/run/fail2ban\nReadWritePaths=-/var/lib/fail2ban\nReadWritePaths=-/var/log/fail2ban\nReadWritePaths=-/var/spool/postfix/maildrop\nReadWritePaths=-/run/xtables.lock\nCapabilityBoundingSet=CAP_AUDIT_READ CAP_DAC_READ_SEARCH CAP_NET_ADMIN CAP_NET_RAW\n```\n\nCapabilityBoundingSet パラメータ CAP_DAC_READ_SEARCH を使用すると、Fail2ban にすべてのディレクトリとファイルへの完全な読み取りアクセスが許可されます。CAP_NET_ADMIN と CAP_NET_RAW により、コマンドラインシェル インターフェイスを持つファイアウォール上で Fail2ban を動作させることができます。詳細については、capabilities(7) を参照してください。\n\nProtectSystem=strict を使用すると、ファイルシステム 階層は読み取り専用になり、ReadWritePaths は Fail2ban に必要なパスへの書き込みアクセスを許可します。\n\nCreate /etc/fail2ban/fail2ban.local with the correct logtarget path:\n\n```\n/etc/fail2ban/fail2ban.local\n```\n\n```\n[Definition]\nlogtarget = /var/log/fail2ban/fail2ban.log\n```\n\nroot として /var/log/fail2ban/ ディレクトリを作成します。\n\n最後に、systemd デーモンを 再起動 して実行しユニットの変更を適用し、fail2ban.service を実行します。\n\n"
    },
    {
      "title": "参照",
      "level": 2,
      "content": "- Using a Fail2Ban Jail to Whitelist a User\n- Optimising your Fail2Ban filters\n- Fail2Ban and sendmail\n- Fail2Ban and iptables\n- Fail2Ban 0.8.3 Howto\n- Monitoring the fail2ban log\n\n"
    }
  ]
}