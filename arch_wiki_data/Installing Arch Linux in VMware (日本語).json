{
  "title": "Installing Arch Linux in VMware (日本語)",
  "url": "https://wiki.archlinux.org/title/Installing_Arch_Linux_in_VMware_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "関連記事\n\n- VMware\n- VMWare vCLI のインストール\n\nこの記事では Player (Plus), Fusion, Workstation などの VMware 製品での Arch Linux のインストールを扱います。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 カーネルドライバー\n- 2 VMware Tools vs Open-VM-Tools\n- 3 Open-VM-Tools 3.1 モジュール 3.2 ユーティリティ 3.3 インストール 3.3.1 マルチユーザーターゲット 3.3.2 グラフィカルターゲット 3.4 ウィンドウのリサイズで解像度を更新\n- 4 公式 VMware Tools 4.1 モジュール 4.2 インストール (ゲストから)\n- 5 Xorg の設定\n- 6 ヒントとテクニック 6.1 vmhgfs-fuse ユーティリティによる共有フォルダ 6.1.1 fstab 6.1.2 Systemd 6.2 vmhgfs モジュールによるレガシーな共有フォルダ 6.2.1 起動時に共有フォルダを有効にする 6.2.2 mlocate DB の剪定 6.3 3D アクセラレーション 6.3.1 OpenGL と GLSL のサポート 6.4 時刻同期 6.4.1 時刻のソースとしてホストマシンを使う 6.4.2 時刻のソースとして外部サーバを使う 6.5 準仮想化 SCSI アダプター\n- 7 トラブルシューティング 7.1 マウスの問題 7.1.1 ボタンが機能しない 7.2 ブートの問題 7.2.1 起動時間が遅い 7.2.2 シャットダウンや再起動がハングアップする 7.3 自動スケールの問題 7.4 GNOME3 のレンダリング問題 7.5 ドラッグアンドドロップとコピーアンドペースト 7.6 Workstation 11 で共有 VM として実行するときの問題 7.7 システムのアップグレード後に共有フォルダがマウントされない\n\n- 3.1 モジュール\n- 3.2 ユーティリティ\n- 3.3 インストール 3.3.1 マルチユーザーターゲット 3.3.2 グラフィカルターゲット\n- 3.4 ウィンドウのリサイズで解像度を更新\n\n- 3.3.1 マルチユーザーターゲット\n- 3.3.2 グラフィカルターゲット\n\n- 4.1 モジュール\n- 4.2 インストール (ゲストから)\n\n- 6.1 vmhgfs-fuse ユーティリティによる共有フォルダ 6.1.1 fstab 6.1.2 Systemd\n- 6.2 vmhgfs モジュールによるレガシーな共有フォルダ 6.2.1 起動時に共有フォルダを有効にする 6.2.2 mlocate DB の剪定\n- 6.3 3D アクセラレーション 6.3.1 OpenGL と GLSL のサポート\n- 6.4 時刻同期 6.4.1 時刻のソースとしてホストマシンを使う 6.4.2 時刻のソースとして外部サーバを使う\n- 6.5 準仮想化 SCSI アダプター\n\n- 6.1.1 fstab\n- 6.1.2 Systemd\n\n- 6.2.1 起動時に共有フォルダを有効にする\n- 6.2.2 mlocate DB の剪定\n\n- 6.3.1 OpenGL と GLSL のサポート\n\n- 6.4.1 時刻のソースとしてホストマシンを使う\n- 6.4.2 時刻のソースとして外部サーバを使う\n\n- 7.1 マウスの問題 7.1.1 ボタンが機能しない\n- 7.2 ブートの問題 7.2.1 起動時間が遅い 7.2.2 シャットダウンや再起動がハングアップする\n- 7.3 自動スケールの問題\n- 7.4 GNOME3 のレンダリング問題\n- 7.5 ドラッグアンドドロップとコピーアンドペースト\n- 7.6 Workstation 11 で共有 VM として実行するときの問題\n- 7.7 システムのアップグレード後に共有フォルダがマウントされない\n\n- 7.1.1 ボタンが機能しない\n\n- 7.2.1 起動時間が遅い\n- 7.2.2 シャットダウンや再起動がハングアップする\n\n"
    },
    {
      "title": "カーネルドライバー",
      "level": 2,
      "content": "- vmw_balloon - 物理メモリ管理ドライバー。物理ページを回収して膨らむ\"バルーン\"のように働き、ゲストのページを予約して無効にすることでホストマシンのページを開放して他のゲストに割り当てられるようにします。縮小させることでゲストが使用できる物理メモリを増やすことも可能です。開放された仮想マシンのメモリはゲストを終了することなくホストで再利用することができます。\n- vmw_pvscsi - VMware の Paravirtual SCSI (PVSCSI) HBA のドライバー。\n- vmw_vmci - Virtual Machine Communication Interface。VMCI 仮想デバイスによるホストと仮想環境のゲスト間での高速通信を有効にします。\n- vsock - Virtual Socket Protocol。TCP/IP ソケットプロトコルと似ていて、仮想マシンとハイパーバイザまたはホスト間での通信ができるようにします。\n- vmw_vsock_vmci_transport - 仮想ソケットの VMCI 転送の実装。\n- vmwgfx - 3D アクセラレーションのためのドライバー。VMware SVGA2 仮想ハードウェアのための KMS 有効済み DRM ドライバーです。\n- vmxnet3 - VMware の vmxnet3 仮想イーサネット NIC のドライバー。\n- open-vm-tools 10.0 から fuse ベースの hgfs 実装が追加されており、カーネルのバージョン 4.0 からサポートされています。\n\n"
    },
    {
      "title": "VMware Tools vs Open-VM-Tools",
      "level": 2,
      "content": "2007年に、VMware は VMware Tools の大部分を Open-VM-Tools として LGPL でリリースしました。別途 Arch Linux 用の公式 Tools はありません。\n\n当初は VMware Tools が、時間同期などの機能がある、ネットワークやストレージに最適のドライバを提供していました。しかし現在では、ネットワークや scsi アダプターが linux カーネルの一部になったことで、VMware Tools には追加機能や\"古い\" vmxnet アダプターのサポートだけが求められるようになりました。\n\nVMware Tools と Open-VM-Tools のどちらを使う場合でも xf86-video-vmware のインストールが必要です。\n\n"
    },
    {
      "title": "モジュール",
      "level": 3,
      "content": "open-vm-tools-dkmsAUR パッケージには以下のモジュールが含まれています:\n\n- vmblock - ファイルシステムドライバー。ホストシステムとゲストマシン間のドラッグアンドドロップを有効にします (vmware-vmblock-fuse ユーティリティが取って代わります)。\n- vmci - 仮想マシン通信インターフェイス (VMCI)、同じホストでの仮想マシン同士や仮想マシンとホスト間で高いパフォーマンスを発揮するインターフェイス。\n- vmhgfs - レガシーなファイルシステムドライバー。ホストシステムと仮想マシン間のファイル・ディレクトリ共有を有効にします。\n- vsock - VMCI ソケット。\n- vmsync - 実験的なファイルシステム同期ドライバ。バックアップやスナップショットの作成時にファイルシステムの静止を有効にします。\n- vmxnet - 古い VMXNET ネットワークアダプター用のドライバ。\n\n"
    },
    {
      "title": "ユーティリティ",
      "level": 3,
      "content": "open-vm-tools パッケージには以下のユーティリティが含まれています:\n\n- vmtoolsd - 仮想マシンの状態レポートに反応するサービス。\n- vmware-checkvm - 仮想マシン上でプログラムが起動しているか確認するツール。\n- vmware-toolbox-cmd - 統計などのホストの仮想マシン情報を取得するツール。\n- vmware-user-suid-wrapper - ホストと仮想マシン間でクリップボード共有（コピーペースト）を有効にするツール。\n- vmware-vmblock-fuse - FUSE でホストと仮想マシン間のドラッグ&ドロップを有効にするユーティリティ。\n- vmware-xferlogs - ログやデバッグ情報を仮想マシンのログファイルに記録する。\n- vmhgfs-fuse - vmhgfs 共有フォルダをマウントするユーティリティ。\n\n"
    },
    {
      "title": "インストール",
      "level": 3,
      "content": "公式リポジトリから open-vm-tools を、AUR から open-vm-tools-dkmsAUR をインストールしてください。\n\nOpen-VM-Tools は /etc/arch-release からバージョン情報を読み取りますが、空になっています:\n\n```\n# cat /proc/version > /etc/arch-release\n```\n\n"
    },
    {
      "title": "マルチユーザーターゲット",
      "level": 4,
      "content": "multi-user.target で起動する場合、以下の手順に従って下さい。graphical.target で起動する場合は graphical.target の方のセクションを見て下さい。\n\nvmtoolsd サービスを起動し、必要ならばブート時にそれを有効にしてください:\n\n```\n# systemctl start vmtoolsd\n# systemctl enable vmtoolsd\n```\n\n"
    },
    {
      "title": "グラフィカルターゲット",
      "level": 4,
      "content": "グラフィカル環境を起動する場合、以下の手順に従って VMware ツールを有効化してください。\n\nvmware-vmblock-fuse.service Systemd サービスを有効化してください。\n\nopen-vm-tools-dkmsAUR をインストールした場合は dkms.service Systemd サービスを有効化してください。カーネルのアップデート後に自動的にカーネルモジュールがリコンパイルされます。\n\n上記の設定で上手く動作しない場合は gtkmm3 をインストールしてみてください。\n\n"
    },
    {
      "title": "ウィンドウのリサイズで解像度を更新",
      "level": 3,
      "content": "X の中から /usr/bin/vmware-user-suid-wrapper を 起動 してください。\n\n"
    },
    {
      "title": "モジュール",
      "level": 3,
      "content": "- vmblock - ファイルシステムドライバー。ホストシステムとゲストマシン間のドラッグアンドドロップを有効にします (vmware-vmblock-fuse ユーティリティが取って代わります)。\n- vmci - ホストとゲスト間のハイパフォーマンス通信インターフェイス。\n- vmmon - 仮想マシンモニター。\n- vmnet - ネットワークドライバー。\n- vsock - VMCI ソケット。\n\n"
    },
    {
      "title": "インストール (ゲストから)",
      "level": 3,
      "content": "依存パッケージをインストールしてください: base-devel (ビルド用), net-tools (インストーラが使用する ifconfig 用), linux-headers (カーネルヘッダー)。\n\nインストーラを正しく動作させるために偽の init ディレクトリを作成:\n\n```\n# for x in {0..6}; do mkdir -p /etc/init.d/rc${x}.d; done\n```\n\nインストーラをマウント:\n\n```\n# mount /dev/cdrom /mnt\n```\n\n(/root などに) 展開:\n\n```\n# tar xf /mnt/VMwareTools*.tar.gz -C /root\n```\n\n起動:\n\n```\n# perl /root/vmware-tools-distrib/vmware-install.pl\n```\n\n以下のビルドエラーは無視しても大丈夫です:\n\n- VMNEXT 3 仮想ネットワークカード\n- \"Warning: This script could not find mkinitrd or update-initramfs and cannot remake the initrd file!\"\n- Fuse components not found on the system.\n\nvmware-vmblock-fuse systemd サービスを有効化:\n\n```\n# abs community/open-vm-tools\n# cp /var/abs/community/open-vm-tools/vmware-* /usr/lib/systemd/system\n# systemctl enable vmware-vmblock-fuse.service\n```\n\n仮想マシンを再起動:\n\n```\n# systemctl reboot\n```\n\nログインして VMware Tools を起動:\n\n```\n# /etc/init.d/rc6.d/K99vmware-tools start\n```\n\n"
    },
    {
      "title": "Xorg の設定",
      "level": 2,
      "content": "依存パッケージをインストールしてください: xf86-input-vmmouse, xf86-video-vmware, mesa。\n\ngraphical target で起動している場合ほとんど完了です。/etc/xdg/autostart/vmware-user.desktop が実行されて、仮想マシンでする必要があることはほぼセットアップされます。\n\nしかしながら、multi-user.target で起動している場合、または通常とは異なるセットアップ (例: マルチモニタ) を使っている場合、vmtoolsd.service を有効にする必要があります:\n\n```\n# systemctl enable vmtoolsd\n```\n\nさらに、ドライバーをロードする権限を与えて下さい:\n\n```\n/etc/X11/Xwrapper.config\n```\n\n```\nneeds_root_rights=yes\n```\n\n"
    },
    {
      "title": "vmhgfs-fuse ユーティリティによる共有フォルダ",
      "level": 3,
      "content": "Edit virtual machine settings > Options > Shared Folders > Always enabled を選択して新しい共有を作成してファイルを共有してください。\n\nvmware-hgfsclient コマンドを実行することで共有フォルダが確認できます:\n\n```\n$ vmware-hgfsclient\n```\n\n確認できたらフォルダをマウントします:\n\n```\n# mkdir <shared folders root directory>\n# vmhgfs-fuse -o allow_other -o auto_unmount .host:/<shared_folder> <shared folders root directory>\n```\n\n他の vmhgfs-fuse のマウントオプションは -h フラグを使えば確認できます:\n\n```\n# vmhgfs-fuse -h\n```\n\n共有のルールを追加:\n\n```\n/etc/fstab\n```\n\n```\n.host:/<shared_folder> /home/user1/shares fuse.vmhgfs-fuse defaults 0 0\n```\n\n共有フォルダを作成・マウント:\n\n```\n# mkdir /home/user1/shares\n# mount /home/user1/shares\n```\n\n以下の .service を作成してください:\n\n```\n/etc/systemd/system/<shared folders root directory>-<shared_folder>.service\n```\n\n```\n[Unit]\nDescription=Load VMware shared folders\nRequires=vmware-vmblock-fuse.service\nAfter=vmware-vmblock-fuse.service\nConditionPathExists=.host:/<shared_folder>\nConditionVirtualization=vmware\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=\nExecStart=/usr/bin/vmhgfs-fuse -o allow_other -o auto_unmount .host:/<shared_folder> <shared folders root directory>\n\n[Install]\nWantedBy=multi-user.target\n```\n\n<shared folders root directory> フォルダが存在することを確認してください。フォルダが存在しない場合は作成する必要があります:\n\n```\n# mkdir -p <shared folders root directory>\n```\n\n<shared folders root directory>-<shared_folder>.service マウントターゲットを有効化してください。\n\n全ての共有フォルダを自動的にマウントしたい場合は <shared_folder> は省いてください。\n\n"
    },
    {
      "title": "vmhgfs モジュールによるレガシーな共有フォルダ",
      "level": 3,
      "content": "Edit virtual machine settings > Options > Shared Folders > Always enabled を選択して新しい共有を作成してください。\n\nvmware-hgfsclient コマンドを実行することで共有フォルダを確認できるはずです:\n\n```\n$ vmware-hgfsclient\n```\n\n/etc/fstab に共有フォルダのルールを追加してください:\n\n```\n/etc/fstab\n```\n\n```\n.host:/<shared_folder> /home/user1/shares vmhgfs defaults 0 0\n```\n\n共有フォルダを作成・マウント:\n\n```\n# mkdir /home/user1/shares\n# mount /home/user1/shares\n```\n\n一時的にマウントすることも可能です:\n\n```\n# mount -t vmhgfs .host:/<shared_folder> /home/user1/shares\n```\n\n"
    },
    {
      "title": "起動時に共有フォルダを有効にする",
      "level": 4,
      "content": "共有フォルダを動かすには vmhgfs ドライバがロードされていなければなりません。以下の .service を作成してください:\n\n```\n/etc/systemd/system/mnt-hgfs.mount\n```\n\n```\n[Unit]\nDescription=Load VMware shared folders\nConditionPathExists=.host:/<shared_folder>\nConditionVirtualization=vmware\n\n[Mount]\nWhat=.host:/<shared_folder>\nWhere=/home/user1/shares\nType=vmhgfs\nOptions=defaults,noatime\n\n[Install]\nWantedBy=multi-user.target\n```\n\n```\n/etc/systemd/system/mnt-hgfs.automount\n```\n\n```\n[Unit]\nDescription=Load VMware shared folders\nConditionPathExists=.host:/<shared_folder>\nConditionVirtualization=vmware\n\n[Automount]\nWhere=/home/user1/shares\n\n[Install]\nWantedBy=multi-user.target\n```\n\nマウントターゲットを有効にしてください:\n\n```\n# systemctl enable mnt-hgfs.automount\n```\n\n"
    },
    {
      "title": "mlocate DB の剪定",
      "level": 4,
      "content": "mlocate を使うとき、locate DB で共有ディレクトリをインデックスするのは意味がありません。除去するディレクトリを /etc/updatedb の PRUNEPATHS に追加してください。\n\n"
    },
    {
      "title": "3D アクセラレーション",
      "level": 3,
      "content": "3D アクセラレーションを有効にするには Edit virtual machine settings -> Hardware -> Display から Accelerate 3D graphics のチェックボックスを有効にしてください\n\n"
    },
    {
      "title": "OpenGL と GLSL のサポート",
      "level": 4,
      "content": "新しいカーネルモジュールで OpenGL と GLSL をアップデートすることで、Arch によるバージョンを上書きすることが可能です。\n\n執筆時点で、OpenGL 3.3 と GLSL 3.30 がサポートされています。詳しくは https://bbs.archlinux.org/viewtopic.php?id=202713 を見て下さい。\n\n"
    },
    {
      "title": "時刻同期",
      "level": 3,
      "content": "仮想マシンで時刻同期を設定することは重要です。複数の仮想マシンによって CPU が共有されることにより、物理的なホストに比べて仮想マシンでは時刻の変動が発生しやすいためです。\n\n時刻同期を設定する方法は2つあります: ホストマシンをソースにするか外部のサーバをソースにするかです。\n\n"
    },
    {
      "title": "時刻のソースとしてホストマシンを使う",
      "level": 4,
      "content": "時刻ソースとしてホストを使うには:\n\n```\n# vmware-toolbox-cmd timesync enable\n```\n\nホストマシンがスリープから復帰した後にゲストの時計を同期させるには:\n\n```\n# hwclock --hctosys --localtime\n```\n\n"
    },
    {
      "title": "時刻のソースとして外部サーバを使う",
      "level": 4,
      "content": "NTP を見て下さい。\n\n"
    },
    {
      "title": "準仮想化 SCSI アダプター",
      "level": 3,
      "content": "VMware Paravirtual SCSI (PVSCSI) アダプター はオーバーヘッドが少なく大きなパフォーマンスブーストを得られる VMware ESXi のストレージアダプタです。\n\n次の手順に従って下さい: /etc/mkinitcpio.conf ファイルを開き MODULES 行に以下を追加する:\n\n```\nMODULES=(...vmw_pvscsi...)\n```\n\nその後、次のコマンドを実行:\n\n```\n# mkinitcpio -p linux\n```\n\n仮想マシンをシャットダウンして scsi アダプタータイプを変更してください: VMware Paravirtual。警告が表示されても無視してかまいません。\n\n"
    },
    {
      "title": "マウスの問題",
      "level": 3,
      "content": "マウスに関する以下の問題が発生することがあります:\n\n- カーソルをウィンドウに載せた時に自動グラブ機能が動作しない\n- 入力にラグが発生する\n- アプリケーションによってクリックが認識されない\n- 仮想マシンに入ったり出たりするときにマウスカーソルが飛ぶ\n- マウスの位置がゲスト VM のときの場所に飛ぶ\n\nxf86-input-vmmouse パッケージを削除してみてください。マウスとキーボードの入力は xf86-input-vmmouse と xf86-input-libinput だけで扱えます。\n\n以下の設定を .vmx 設定ファイルに追加してみてください (Mouse position jumps to where it left the guest VM):\n\n```\n~/vmware/<Virtual Machine name>/<Virtual Machine name>.vmx\n```\n\n```\nmouse.vusb.enable = \"TRUE\"\nmouse.vusb.useBasicMouse = \"FALSE\"\nusb.generic.allowHID = \"TRUE\"\n```\n\nVMware は自動的にゲーム用にマウスを最適化します。問題が発生した場合、最適化を無効にするのを推奨します: Edit > Preferences > Input > Optimize mouse for games: Never。\n\nまた、60-libinput.conf で catchall イベントを 無効 にする必要もあるかもしれません:\n\n```\n/usr/share/X11/xorg.conf.d/60-libinput.conf\n```\n\n```\n#Section \"InputClass\"\n#        Identifier \"libinput pointer catchall\"\n#        MatchIsPointer \"on\"\n#        MatchDevicePath \"/dev/input/event*\"\n#        Driver \"libinput\"\n#EndSection\n```\n\n"
    },
    {
      "title": "ボタンが機能しない",
      "level": 4,
      "content": "デフォルトで動作しない場合、mouse.vusb.useBasicMouse = \"FALSE\" を .vmx に追加することで全てのマウスボタンが動作するはずです。\n\n```\n~/vmware/<Virtual Machine name>/<Virtual Machine name>.vmx\n```\n\n```\nmouse.vusb.useBasicMouse = \"FALSE\"\n```\n\n"
    },
    {
      "title": "起動時間が遅い",
      "level": 4,
      "content": "VMWare のメモリ hot-add 機能が有効になっていると以下のエラーが起こることがあります。\n\n- add_memory failed\n- acpi_memory_enable_device() error\n\nmem.hotadd = \"FALSE\" を .vmx に設定することでメモリ hot-add 機能を無効にできます。\n\n```\n~/vmware/<Virtual Machine name>/<Virtual Machine name>.vmx\n```\n\n```\nmem.hotadd = \"FALSE\"\n```\n\n"
    },
    {
      "title": "シャットダウンや再起動がハングアップする",
      "level": 4,
      "content": "vmtoolsd サービスのタイムアウトを変更してください (デフォルトは90秒)。\n\n```\n/etc/systemd/system/vmtoolsd.service.d/timeout.conf\n```\n\n```\n[Service]\nTimeoutStopSec=1\n```\n\n"
    },
    {
      "title": "自動スケールの問題",
      "level": 3,
      "content": "システムサービスを有効にしても解像度が変更されず引き伸ばされる場合、mkinitcpio.conf にモジュールを追加する必要があります。\n\n```\n/etc/mkinitcpio.conf\n```\n\n```\nMODULES=\"vsock vmw_vsock_vmci_transport vmw_balloon vmw_vmci vmwgfx\"\n```\n\n忘れずに次を実行してください:\n\n```\n# mkinitcpio -p linux\n```\n\n"
    },
    {
      "title": "GNOME3 のレンダリング問題",
      "level": 3,
      "content": "UI の一部が Clutter (検索、ドックなど) で消えないという再描写問題を修正するには、以下を編集する必要があります:\n\n```\n/etc/environment\n```\n\n```\nCLUTTER_PAINT=disable-clipped-redraws:disable-culling\n```\n\n"
    },
    {
      "title": "ドラッグアンドドロップとコピーアンドペースト",
      "level": 3,
      "content": "ドラッグアンドドロップ (コピーアンドペースト) 機能を使うには open-vm-tools と gtkmm3 パッケージをインストールする必要があります。\n\nログイン時に /etc/xdg/autostart/vmware-user.desktop によって vmware-user-suid-wrapper を起動しようとしても、gtkmm との関係によって失敗することがあります。FS#43159 を見て下さい。\n\n"
    },
    {
      "title": "Workstation 11 で共有 VM として実行するときの問題",
      "level": 3,
      "content": "Workstation 11 には Arch ゲストを共有 VM として動作させゲストで vmtoolsd が実行しているときに vmware-hostd がクラッシュするというバグが存在しています。バグを回避するための open-vm-tools のパッチが こちら にあります。\n\n"
    },
    {
      "title": "システムのアップグレード後に共有フォルダがマウントされない",
      "level": 3,
      "content": "open-vm-tools にのみ発生する問題です。vmhgfs モジュールは AUR の open-vm-tools-dkmsAUR に入っているため、pacman -Syu コマンドで自動的にアップデートされることはありません。システムのアップグレードをする前に手動で open-vm-tools-dkmsAUR をアップデートするようにしてください。\n\nマウントされなくなったら、共有ファイルシステムの自動マウントを削除して、アップグレードをしてから mkinitcpio -p linux を実行する必要があります。\n\n"
    }
  ]
}