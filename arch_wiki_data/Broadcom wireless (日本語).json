{
  "title": "Broadcom wireless (日本語)",
  "url": "https://wiki.archlinux.org/title/Broadcom_wireless_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "関連記事\n\n- ワイヤレスネットワーク設定\n\nこの記事では Broadcom のワイヤレスネットワークデバイスをインストール・設定する方法を説明しています。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 イントロダクション\n- 2 ドライバーの選択\n- 3 インストール 3.1 brcm80211 3.2 b43/b43legacy 3.2.1 b43/b43legacy カーネルモジュールのロード 3.3 broadcom-wl 3.3.1 wl カーネルモジュールのロード 3.3.2 broadcom-wl をモニターモードに設定\n- 4 トラブルシューティング 4.1 Wi-Fi カードが存在しないかのように扱われる 4.2 カーネルをアップグレードした後に Wi-Fi カードが動作しなくなった又は認識されなくなった (brcmsmac) 4.3 Wi-Fi カードが動作しない又は認識されない (broadcom-wl) 4.4 インターフェイスが取り替わる (broadcom-wl) 4.5 b43 ドライバーと Linux 3.8+ 4.6 コンソールのメッセージを少なくする 4.7 インターフェイスは表示されるのに接続ができない 4.8 b43 が応答しない 4.9 Asus PCE-AC88 のファームウェアが見つからない 4.10 一部のルーターで接続が不安定\n\n- 3.1 brcm80211\n- 3.2 b43/b43legacy 3.2.1 b43/b43legacy カーネルモジュールのロード\n- 3.3 broadcom-wl 3.3.1 wl カーネルモジュールのロード 3.3.2 broadcom-wl をモニターモードに設定\n\n- 3.2.1 b43/b43legacy カーネルモジュールのロード\n\n- 3.3.1 wl カーネルモジュールのロード\n- 3.3.2 broadcom-wl をモニターモードに設定\n\n- 4.1 Wi-Fi カードが存在しないかのように扱われる\n- 4.2 カーネルをアップグレードした後に Wi-Fi カードが動作しなくなった又は認識されなくなった (brcmsmac)\n- 4.3 Wi-Fi カードが動作しない又は認識されない (broadcom-wl)\n- 4.4 インターフェイスが取り替わる (broadcom-wl)\n- 4.5 b43 ドライバーと Linux 3.8+\n- 4.6 コンソールのメッセージを少なくする\n- 4.7 インターフェイスは表示されるのに接続ができない\n- 4.8 b43 が応答しない\n- 4.9 Asus PCE-AC88 のファームウェアが見つからない\n- 4.10 一部のルーターで接続が不安定\n\n"
    },
    {
      "title": "イントロダクション",
      "level": 2,
      "content": "GNU/Linux における自社製品の Wi-Fi カードのサポートについて Broadcom は（悪い意味で）有名でした。最近になるまで、ほとんどの Broadcom のチップは全くサポートがなかったり、ユーザー自身がファームウェアを弄る必要があったのです。当時はリバースエンジニアリングによるドライバー (brcm4xxx, b43 など) によって限られた数のワイヤレスチップだけがサポートされていました。リバースエンジニアリングの b43 ドライバーは 2.6.24 からカーネルに入りました。\n\n2008年の8月に、Broadcom は GNU/Linux で Broadcom の無線ハードウェアをサポートする 802.11 Linux STA ドライバー を公式にリリースします。それらは制限的なライセンスのドライバーでしたが、Broadcom は将来もっとオープンなアプローチを目指すことを約束しました。なお、このドライバーは隠蔽された ESSID では動作しません。\n\n2010年9月、Broadcom は彼らのハードウェアのための完全にオープンソースなドライバーを 最終的にリリース しました。このドライバー、brcm80211 はカーネル 2.6.37 から含まれています。2.6.39 のリリース時に、これらのドライバーは brcmsmac と brcmfmac に名前が変更されています。\n\n執筆時点で、Broadcom Wi-Fi チップセットを使っているユーザーには3つの選択肢が存在します:\n\nTable content:\nドライバー | 説明\nbrcm80211 | オープンソースのカーネルドライバー (推奨)\nb43 | リバースエンジニアリングによるカーネルドライバー\nbroadcom-wl | プロプライエタリな Broadcom STA ドライバー\n\n"
    },
    {
      "title": "ドライバーの選択",
      "level": 2,
      "content": "まず、あなたの使っているカードの PCI-ID を確認してください。コンソールに次のコマンドを入力 (大文字小文字の違いに気をつけて下さい):\n\n```\n$ lspci -vnn -d 14e4:\n```\n\nそれから、あなたのカードを b43 でサポートされている デバイスのリスト と でサポートされているデバイスのリスト を見て確認してください。\n\n"
    },
    {
      "title": "brcm80211",
      "level": 3,
      "content": "brcm80211 ドライバーはカーネルに含まれています。PCI カードには brcmsmac、SDIO デバイスには brcmfmac という名前が付けられています。\n\nこれらのドライバーは起動時に自動的にロードされるためユーザーがやらなくてはならない操作はありません。ドライバーが自動的にロードされない場合は、手動でドライバーをロードしてください。\n\n- brcmfmac は新しいチップセットをサポートしており、AP モードや P2P モード、ハードウェア暗号化などもサポートしています。\n- brcmsmac は BCM4313, BCM43224, BCM43225 などの古いチップセットしかサポートしていません。\n- linux 3.3.1 から、brcmsmac ドライバーは bcma モジュールに依存するようになっています。従って、bcma モジュールをブラックリストに入れてはいけません。\n- wireless.kernel.org によれば brcm80211 は SSB backplane を使っている古い PCI/PCI-E チップをサポートしていません。\n\n"
    },
    {
      "title": "b43/b43legacy",
      "level": 3,
      "content": "このドライバーは 2.6.24 からカーネルにマージされています。\n\n"
    },
    {
      "title": "b43/b43legacy カーネルモジュールのロード",
      "level": 4,
      "content": "あなたの使っているデバイスを こちら で検索してどちらのモジュールが必要なのか確認してください。ここ でコンピュータの機種で検索することもできます。問題が発生しないようにもう片方のモジュールはブラックリストに入れます (b43 または b43legacy)。ブラックリスト化の方法は、カーネルモジュール#ブラックリスト を参照。\n\nAUR から b43-firmwareAUR, b43-firmware-classicAUR, b43-firmware-legacyAUR[リンク切れ: パッケージが存在しません] のどれか適切なパッケージをインストールしてください。\n\n- BCM4306 rev.3, BCM4311, BCM4312 は b43-firmware だと問題が発生します。b43-firmware-classicAUR を使って下さい。\n- BCM4331 は b43-firmware-classic だと問題が発生します。b43-firmwareAUR を使って下さい。\n\nb43 によってサポートされているデバイスの低電圧版を使っている場合、特別なファームウェアをインストールする必要があります。低電圧版のチップを使っているのかどうかは lspci | grep Broadcom | grep LP-PHY を実行することですぐに確認できます。ファームウェアのインストールは、下で説明しているように 適切なパッケージ をダウンロードして b43-fwcutter を使うか、このインストールスクリプトを使用することで可能です。\n\nLP-PHY ファームウェアをインストールするには、以下を実行:\n\n```\n$ curl -LO http://downloads.openwrt.org/sources/broadcom-wl-4.178.10.4.tar.bz2\n$ tar xjf broadcom-wl-4.178.10.4.tar.bz2\n$ cd broadcom-wl-4.178.10.4/linux\n# b43-fwcutter -w /lib/firmware wl_apsta.o\n```\n\nファームウェアをインストールしたら、デバイスを設定することができるようになります。\n\n"
    },
    {
      "title": "broadcom-wl",
      "level": 3,
      "content": "制限ライセンスのドライバーは以下のパッケージで使うことができます:\n\n- 標準パッケージ: broadcom-wl\n- DKMS パッケージ: broadcom-wl-dkms\n\n"
    },
    {
      "title": "wl カーネルモジュールのロード",
      "level": 4,
      "content": "他の使用可能なモジュールが存在しない場合、wl モジュールを手動でロードする必要があります。wl モジュールをロードする前に、b43 など他のモジュールを取り除いて下さい、おそらく自動的にロードされています:\n\n```\n# rmmod b43\n```\n\nssb がロードされている場合も、アンロードしてください:\n\n```\n# rmmod ssb\n```\n\nwl モジュールをロード:\n\n```\n# modprobe wl\n```\n\nwl モジュールは lib80211 または lib80211_crypt_tkip を自動的にロードします。lsmod でロードされているか確認してください。ロードされていない場合は、2つのモジュールのどちらかを追加してください:\n\n```\n# modprobe lib80211\n```\n\nまたは:\n\n```\n# modprobe lib80211_crypt_tkip\n```\n\nBroadcom から直接ドライバーをインストールしたときは、依存関係を更新する必要があるかもしれません:\n\n```\n# depmod -a\n```\n\n起動時にモジュールがロードされるようにする方法は、カーネルモジュールを見て下さい。\n\n/etc/modprobe.d/modprobe.conf で使わないモジュールを (干渉しないように) ブラックリストに入れることができます。モジュールをブラックリスト化する方法は、カーネルモジュール#ブラックリスト を見て下さい。\n\n"
    },
    {
      "title": "broadcom-wl をモニターモードに設定",
      "level": 4,
      "content": "broadcom-wl をモニターモードに設定するには /proc/brcm_monitor0) を 1 に設定してください:\n\n```\n# echo 1 > /proc/brcm_monitor0\n```\n\nprism0 という名前の新しいネットワークインターフェイスが作成されます。\n\nモニターモードで使うときは新しく作成されたネットワークインターフェイスを使うようにしてください。\n\n"
    },
    {
      "title": "Wi-Fi カードが存在しないかのように扱われる",
      "level": 3,
      "content": "Broadcom BCM43241 などの新しいカードを使っているユーザーは lspci や lsusb でカードの情報が何も表示されないという問題に遭遇することがあります。\n\n"
    },
    {
      "title": "カーネルをアップグレードした後に Wi-Fi カードが動作しなくなった又は認識されなくなった (brcmsmac)",
      "level": 3,
      "content": "カーネルが brcmsmac モジュールの代わりに bcma モジュールを使用することで起こります。解決方法は bcma モジュールをブラックリストに入れることです。方法は、カーネルモジュール#ブラックリスト を見て下さい。\n\n"
    },
    {
      "title": "Wi-Fi カードが動作しない又は認識されない (broadcom-wl)",
      "level": 3,
      "content": "適切なモジュールがロードされているか確認してください。不要なモジュールが自動的にロードされないように brcm80211, b43, ssb カーネルモジュールをブラックリスト化させる必要があるかもしれません。ブラックリストの方法については、カーネルモジュール#ブラックリスト を参照。\n\nモジュールの依存関係が更新されたか確認:\n\n```\n# depmod -a\n```\n\n- ip addr で無線インターフェイスが表示されることを確認。\n- iwconfig や ip addr でデバイスが表示されるようにするにはマシンを再起動する必要があるかもしれません。\n- 最近カーネルをアップグレードしていた場合は、新しくインストールしたカーネルで broadcom-wl パッケージを再ビルドしてモジュールを更新する必要があります。\n\n"
    },
    {
      "title": "インターフェイスが取り替わる (broadcom-wl)",
      "level": 3,
      "content": "broadcom-wl ドライバーのユーザーは Ethernet と Wi-Fi のインターフェイスが変わってしまう問題が起こることがあります。解決方法は ネットワーク#デバイス名 を見て下さい。\n\n"
    },
    {
      "title": "b43 ドライバーと Linux 3.8+",
      "level": 3,
      "content": "b43 ドライバーは Linux 3.8 から重大な問題を抱えています、すなわちアクセスポイントを表示したり接続することができません。\n\n解決方法: 上記を参照して、最新の broadcom-wl ドライバー (バージョン 6+) を試してみて下さい。\n\n"
    },
    {
      "title": "コンソールのメッセージを少なくする",
      "level": 3,
      "content": "起動中に、以下のような無駄に長くてうっとおしいメッセージが断続的に流れることがあります:\n\n```\nphy0: brcms_ops_bss_info_changed: arp filtering: enabled true, count 0 (implement)\nphy0: brcms_ops_bss_info_changed: qos enabled: false (implement)\nphy0: brcms_ops_bss_info_changed: arp filtering: enabled true, count 1 (implement)\nenabled, active\n```\n\nこのメッセージは /etc/systemd/journald.conf の MaxLevelConsole を設定するなど、通常の方法で消すことはできません。メッセージを消すためには、dmesg がコンソールにメッセージを表示するレベルを低く設定する必要があります。シンプルな systemd サービスを作ることでこの設定を起動時に行うことが可能です。\n\n/etc/systemd/system/ に brcms_suppression.service というような名前のファイルを作成してください:\n\n```\nbrcms_suppression.service\n```\n\n```\n[Unit]\nDescription=Broadcom console message suppression script\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/bin/sh -c 'dmesg -n 3'\n\n[Install]\nWantedBy=multi-user.target\n```\n\n他の systemd サービスと同じように、次のコマンドで有効にします:\n\n```\n# systemctl enable brcms_suppression\n```\n\n"
    },
    {
      "title": "インターフェイスは表示されるのに接続ができない",
      "level": 3,
      "content": "以下をカーネルコマンドラインに追加:\n\n```\nb43.allhwsupport=1\n```\n\n"
    },
    {
      "title": "b43 が応答しない",
      "level": 3,
      "content": "b43 ドライバーの電源管理は BCM43228 チップ (やその他の Broadcom チップセット) で想定に少しだけ誤差があって、カーネルログに \"(Reason: 3=DEAUTH_LEAVING)\" を残して切断してしまうことがあります。電源管理を無効化することで解決します。一時的に修正するには、root で次を実行: iw <interface> set power_save off。\n\nこのコマンドで解決した場合は、udev ルールを新しく追加することで修正を永続的にできます:\n\n```\n/etc/udev/rules.d/70-b43.rules\n```\n\n```\nACTION==\"add\", SUBSYSTEM==\"net\", ATTR{address}==\"your_mac_address\", RUN+=\"/usr/bin/iw dev %k set power_save off\"\n```\n\n"
    },
    {
      "title": "Asus PCE-AC88 のファームウェアが見つからない",
      "level": 3,
      "content": "brcmfmac4366c-pcie.bin ファームウェアを展開する方法は [1] を見てください。\n\n"
    },
    {
      "title": "一部のルーターで接続が不安定",
      "level": 3,
      "content": "問題が解決しない場合、linux-lts をインストールしたりドライバーのバージョンを下げてみてください。\n\n"
    }
  ]
}