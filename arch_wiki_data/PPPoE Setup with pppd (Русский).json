{
  "title": "PPPoE Setup with pppd (Русский)",
  "url": "https://wiki.archlinux.org/title/PPPoE_Setup_with_pppd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "ppp (Paul's PPP Package) — пакет с открытым исходным кодом, который реализует протокол соединения точка-точка (PPP) для систем Linux и Solaris. Пакет предоставляет демон pppd, который может быть использован вместе с xl2tpd, pptpd и netctl.\n\nПротоколы 3G, L2TP и PPPoE работают на основе PPP, поэтому они также могут контролироваться ppp.\n\n"
    },
    {
      "title": "Установка",
      "level": 2,
      "content": "Установите пакет ppp.\n\n"
    },
    {
      "title": "PPPoE",
      "level": 3,
      "content": "Создайте файл настроек соединения:\n\n```\n/etc/ppp/peers/имя_соединения\n```\n\n```\nplugin pppoe.so\n# rp_pppoe_ac 'имя концентратора доступа'\n# rp_pppoe_service 'имя службы PPPoE'\n\n# сетевой интерфейс\neth0\n# ваш логин\nname \"имя_пользователя\"\nusepeerdns\npersist\n# раскомментируйте, если вам нужен автодозвон \"по требованию\"\n#demand\n#idle 180\ndefaultroute\nhide-password\nnoauth\n```\n\nЕсли задана опция usepeerdns, при соединении pppd создаст файл /etc/ppp/resolv.conf с полученными адресами DNS-серверов. По умолчанию скрипт /etc/ppp/ip-up.d/00-dns.sh перемещает этот файл в /etc/resolv.conf, чтобы система могла использовать эти DNS-серверы. Если это поведение является нежелательным (например, установлен локальный кэширующий DNS), отредактируйте /etc/ppp/ip-up.d/00-dns.sh под ваши нужды.\n\nДобавьте запись с паролем соединения в /etc/ppp/pap-secrets или /etc/ppp/chap-secrets, в зависимости от типа аутентификации, используемого вашим провайдером.\n\nПо возможности используйте chap, так как он безопаснее (здесь можно почитать о том, как работает chap). Однако, если вы не уверены, можно добавить запись в оба файла, pppd выберет нужный самостоятельно. Запись выглядит следующим образом:\n\n```\nимя_пользователя * пароль\n```\n\nИмя пользователя должно совпадать с именем, указанным в опции name. Оно также используется для аутентификации, если не переопределено другим значением с помощью опции user.\n\nТеперь вы можете попробовать установить соединение командой:\n\n```\n# pppd call имя_соединения\n```\n\nили\n\n```\n# pon имя_соединения\n```\n\nгде имя_соединения — имя файла настроек, созданного в /etc/ppp/peers.\n\nЧтобы убедиться, что соединение PPPoE установлено, проверьте вывод pppd в системном логе:\n\n```\n# journalctl -b --grep=pppd\n```\n\nПри успешном соединении вы увидите что-то наподобие следующих строк:\n\n```\nJul 09 22:42:33 localhost pppd[239]: Plugin rp-pppoe.so loaded.\nJul 09 22:42:33 localhost pppd[239]: RP-PPPoE plugin version 3.8p compiled against pppd 2.4.6\nJul 09 22:42:33 localhost network[184]: RP-PPPoE plugin version 3.8p compiled against pppd 2.4.6\nJul 09 22:42:33 localhost pppd[239]: pppd 2.4.6 started by root, uid 0\nJul 09 22:42:39 localhost pppd[239]: PPP session is 292\nJul 09 22:42:39 localhost pppd[239]: Connected to a0:f3:e4:4f:e3:b0 via interface enp4s0\nJul 09 22:42:39 localhost pppd[239]: Using interface ppp0\nJul 09 22:42:39 localhost pppd[239]: Connect: ppp0 <--> enp4s0\nJul 09 22:42:39 localhost pppd[239]: CHAP authentication succeeded: CHAP authentication success\nJul 09 22:42:39 localhost pppd[239]: CHAP authentication succeeded\nJul 09 22:42:39 localhost pppd[239]: peer from calling number A0:F3:E4:4F:E3:B0 authorized\nJul 09 22:42:39 localhost pppd[239]: Cannot determine ethernet address for proxy ARP\nJul 09 22:42:39 localhost pppd[239]: local  IP address 10.6.2.137\nJul 09 22:42:39 localhost pppd[239]: remote IP address 10.6.1.1\nJul 09 22:42:39 localhost pppd[239]: primary   DNS address 10.6.1.1\nJul 09 22:42:39 localhost pppd[239]: secondary DNS address 210.21.196.6\n```\n\nФайл настроек /etc/ppp/peers/provider используется по умолчанию, если при вызове pppd не было указано имя файла. Вместо явного указания имени файла настроек программе pppd вы также можете просто добавить символическую ссылку на свой файл:\n\n```\n# ln -s /etc/ppp/peers/имя_соединения /etc/ppp/peers/provider\n```\n\nТеперь можно устанавливать соединение одной командой\n\n```\n# pon\n```\n\nЧтобы разорвать соединение, выполните\n\n```\n# poff имя_соединения\n```\n\n"
    },
    {
      "title": "Простой мастер настройки",
      "level": 3,
      "content": "pppconfigAUR предоставляет текстовый интерфейс, основанный на dialog, для лёгкой конфигурации pppd. Для использования просто запустите команду pppconfig от имени root и следуйте дальнейшим инструкциям.\n\n```\n# pppconfig --dialog\n```\n\nПолученную конфигурацию можно подключать и отключать с помощью команд pon и poff как описано выше.\n\n"
    },
    {
      "title": "Запуск pppd при старте системы",
      "level": 3,
      "content": "- Настройте модуль ppp_generic для загрузки во время запуска. Инструкции можно найти на странице Модуль ядра#systemd.\n- Включите службу ppp@имя_соединения.service.\n\n"
    },
    {
      "title": "Автодозвон",
      "level": 3,
      "content": "Если pppd запущен, вы можете выполнить сброс соединения, отправив процессу сигнал SIGHUP:\n\n```\n# export PPPD_PID=$(pidof pppd)\n# kill -s HUP $PPPD_PID\n```\n\nПосле разрыва соединение будет вновь установлено.\n\n"
    },
    {
      "title": "Используя cron",
      "level": 4,
      "content": "Выполните следующие шаги от имени суперпользователя.\n\nСоздайте файл скрипта (например, pppd_redial.sh) со следующим содержимым:\n\n```\n#!/bin/bash\n\nmessage=\"Restarting the PPP connection @:\" $(date)\npppd_id=$(pidof pppd)\n\nkill -s HUP $pppd_id\necho $message\n```\n\nСохраните файл и сделайте его исполняемым.\n\nТеперь создайте задачу для cron, используя команду crontab -e. Если появляется ошибка, убедитесь, что установлена переменная окружения EDITOR. По команде откроется редактор — добавьте в него строку, указав правильный путь до вашего скрипта перезапуска соединения:\n\n```\n0 4 * * * /bin/bash /root/pppd_redial.sh\n```\n\nСохраните файл и убедитесь, что служба cronie работает. Если это не так, включите и запустите службу cronie.\n\nТеперь ваше соединение будет перезапускаться каждый день в 4 утра.\n\n"
    },
    {
      "title": "Используя таймер systemd",
      "level": 4,
      "content": "Также вы можете настроить таймер systemd для выполнения ежедневного перезапуска соединения. Просто создайте файлы .service и .timer с одинаковыми именами:\n\n```\nppp-redial.timer\n```\n\n```\n[Unit]\nDescription=Reconnect PPP connections daily\n\n[Timer]\nOnCalendar=*-*-* 05:00:00\n\n[Install]\nWantedBy=multi-user.target\n```\n\n```\nppp-redial.service\n```\n\n```\n[Unit]\nDescription=Reconnect PPP connections\n\n[Service]\nType=simple\nExecStart=/usr/bin/poff -r\n```\n\nТеперь просто включите и запустите таймер, и systemd будет выполнять сброс соединения каждый день в указанное время.\n\n"
    },
    {
      "title": "Маршрут по умолчанию",
      "level": 3,
      "content": "При запуске pppd пытается добавить свой системный маршрут по умолчанию (default route). Если перед запуском уже был установлен такой маршрут, pppd не станет его обновлять, и новые соединения во внешнюю сеть направляться не будут. При этом в /var/log/errors.log вы увидите что-то наподобие:\n\n```\npppd[nnnn]: not replacing existing default route via xxx.xxx.xxx.xxx\n```\n\nЕсли это поведение нежелательно, и xxx.xxx.xxx.xxx — совсем не то, что вам нужно, вы можете создать простой скрипт в /etc/ppp/ip-pre-up.d/ с таким содержимым (не забудьте сделать его исполняемым):\n\n```\n/etc/ppp/ip-pre-up.d/10-route-del-default.sh\n```\n\n```\n#!/bin/sh\n/usr/bin/route del default\n```\n\nПерезапустите службу pppd.\n\n"
    },
    {
      "title": "Маскарадинг работает, но некоторые сайты не открываются",
      "level": 3,
      "content": "Проблема выражается в том, что соединение есть, но часть сайтов и сервисов не работают, если вы используете ваш компьютер в роли маршрутизатора для других компьютеров. Дело в том, что размер MTU (Maximum Transmission Unit — максимальное количество байт данных в одном пакете) в PPPoE равен 1492 байтам, что меньше, чем используют большинство сайтов (1500). Ваш маршрутизатор отправляет серверу специальный пакет ICMP 3:4 (сообщение о том, что нужно переразбиение данных), запрашивая меньший MTU, но сетевые экраны многих сайтов блокируют это сообщение.\n\nПроблема решается добавлением правила с PMTU clamping в iptables:\n\n```\n# iptables -I FORWARD -o ppp0 -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu\n```\n\nОднако, по некоторой причине, это правило может не попадать в вывод iptables-save. Если у вас тот случай, когда iptables-restore не восстанавливает правило после перезапуска, попробуйте следующее решение.\n\nСоздайте файл службы systemd:\n\n```\npmtu-clamping.service\n```\n\n```\n[Unit]\nDescription=PMTU clamping for pppoe\nRequires=iptables.service\nAfter=iptables.service\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/iptables -I FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu\n\n[Install]\nWantedBy=multi-user.target\n```\n\nИ включите эту службу.\n\n"
    },
    {
      "title": "Не удаётся загрузить модуль ядра ppp_generic",
      "level": 3,
      "content": "Проблема выражается в том, что при запуске процесс pppd не может найти соответствующий модуль:\n\n```\nCouldn't open the /dev/ppp device: No such device or address\nPlease load the ppp_generic kernel module.\n```\n\nДля решения создайте файл /etc/modprobe.d/ppp.conf, содержащий строку:\n\n```\nalias char-major-108 ppp_generic\n```\n\nПосле перезагрузки проблема должна решиться.\n\n"
    }
  ]
}