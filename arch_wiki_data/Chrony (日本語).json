{
  "title": "Chrony (日本語)",
  "url": "https://wiki.archlinux.org/title/Chrony_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "この記事は、NTP クライアントとサーバーの代替である、Chrony の設定と起動の方法について記述しています。Chrony はローミングや、ネットワークに接続している時間が限られるシステムに向いています。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 インストール\n- 2 設定 2.1 NTP サーバー 2.2 chronyd にインターネット接続が確立されたことを知らせる 2.3 For intermittently running desktops\n- 3 使用方法 3.1 chronyd の起動 3.2 システムクロックとハードウェアクロックを同期させる\n- 4 ネットワーク状態の通知 4.1 NetworkManager 4.2 netctl\n- 5 参照\n\n- 2.1 NTP サーバー\n- 2.2 chronyd にインターネット接続が確立されたことを知らせる\n- 2.3 For intermittently running desktops\n\n- 3.1 chronyd の起動\n- 3.2 システムクロックとハードウェアクロックを同期させる\n\n- 4.1 NetworkManager\n- 4.2 netctl\n\n"
    },
    {
      "title": "インストール",
      "level": 2,
      "content": "chrony パッケージをインストールしてください。\n\n"
    },
    {
      "title": "設定",
      "level": 2,
      "content": "最小限の設定ファイルは以下のようになります (ホストネームの代わりに IP アドレスを使用):\n\n```\n/etc/chrony.conf\n```\n\n```\nserver 1.2.3.4 offline\nserver 5.6.7.8 offline\nserver 9.10.11.12 offline\ndriftfile /etc/chrony.drift\nrtconutc\nrtcsync\n```\n\n"
    },
    {
      "title": "NTP サーバー",
      "level": 3,
      "content": "まず /etc/chrony.conf にマシンが同期するサーバーを設定する必要があります。NTP サーバーは strata と呼ばれる多数の階層でクラス分けされています。独立したソースとされるデバイスは stratum 0 ソース、stratum 0 デバイスに直接接続しているサーバーは stratum 1 ソース、stratum 1 ソースに接続しているデバイスは stratum 2 ソースというふうに分類されます。\n\nサーバーの stratum は正確性や信頼性を表しているわけではないことに注意してください。一般的に時刻同期に使われるのは stratum 2 のサーバーです。どのサーバーに接続するのかまだ決めてない場合、pool.ntp.org サーバー (別リンク) を使って一番地理的に近いサーバープールを選んでください。\n\n設定例:\n\n```\nserver 0.pool.ntp.org iburst\nserver 1.pool.ntp.org iburst\nserver 2.pool.ntp.org iburst\nserver 3.pool.ntp.org iburst\n```\n\n起動時にコンピュータがインターネットに接続しない場合、offline オプションを使うことが推奨されます。サーバーに接続できるようになるまで chrony に接続を試みないようにすることができます:\n\n```\nserver 0.pool.ntp.org offline\nserver 1.pool.ntp.org offline\nserver 2.pool.ntp.org offline\nserver 3.pool.ntp.org offline\n```\n\n接続が確立されるまで DNS 解決は利用できないため、ホストネームのかわりに IP アドレスを使ったり、/etc/hosts ファイルでホストネームに対して IP アドレスを指定すると良いでしょう。\n\n"
    },
    {
      "title": "chronyd にインターネット接続が確立されたことを知らせる",
      "level": 3,
      "content": "インターネットに接続したら、以下のコマンドを実行:\n\n```\n# chronyc\nchronyc> online\n200 OK\nchronyc> exit\n```\n\nactivity オプションを使うことで状態を表示できます:\n\n```\n# chronyc activity\n200 OK\n3 sources online\n0 sources offline\n0 sources doing burst (return to online)\n0 sources doing burst (return to offline)\n0 sources with unknown address\n```\n\nコマンドを実行すると Chrony はあらかじめ設定された時刻サーバーに接続して必要であれば時刻を更新します。インターネットに接続しなくなったことを通知するには、以下のコマンドを実行:\n\n```\n# chronyc offline\n200 OK\n\n# chronyc activity\n200 OK\n0 sources online\n3 sources offline\n0 sources doing burst (return to online)\n0 sources doing burst (return to offline)\n0 sources with unknown address\n```\n\nnetworkmanager や connman のディスパッチャサービスを使うことでオンライン・オフラインの状態を自動的に管理することができます。下を見てください。\n\n最後に、/usr/share/doc/chrony/chrony.txt のユーザーガイドを覚えておいてください、疑問がでたときに役にたつはずです。オンラインから読むこともできます [1]。関連する man ページも参照しましょう: man {chrony|chronyc|chronyd|chrony.conf}。\n\n"
    },
    {
      "title": "For intermittently running desktops",
      "level": 3,
      "content": "The configuration described here is not really suited well for intermittently running desktops. A machine running Arch Linux for five years, accumulated a 300 s error within the RTC. After a reboot it took chrony a long time to adjust this difference.\n\n```\n/etc/sysconfig/chronyd\n```\n\n```\nOPTIONS='-r -s'\n```\n\n```\n/etc/chrony.conf\n```\n\n```\ndumponexit\ndumpdir /var/lib/chrony\nrtcfile /var/lib/chrony/rtc\n```\n\nThis keeps, interestingly, the RTC still out-of-date, but after each re-start, chrony adjusts the accumulated error of the RTC and the system time is quite synchronous to NTP even shortly after a start.\n\n"
    },
    {
      "title": "chronyd の起動",
      "level": 3,
      "content": "パッケージには chronyd.service が含まれています。詳しくは systemd を参照してください。\n\n"
    },
    {
      "title": "システムクロックとハードウェアクロックを同期させる",
      "level": 3,
      "content": "起動中に起動時刻をハードウェアクロック (RTC) から読み込みシステム時刻がセットされます。そして chrony デーモンが動いている間、数分毎に同期されます。ハードウェアクロックの時刻がズレていると、システム時刻も数分のあいだ時刻がズレることになります。この場合ハードウェアクロックをリセットする必要があります。\n\nchronyc を使うことで強制的にシステム時刻をハードウェアに同期させることができます:\n\n```\n# chronyc\nchronyc> trimrtc\n200 OK\nchronyc> quit\n```\n\nRTC とシステム時刻の差は数マイクロ秒以内になるはずです。すぐ後に完全に同期されます。\n\n"
    },
    {
      "title": "ネットワーク状態の通知",
      "level": 2,
      "content": "chrony.conf でプールを offline で指定した場合、ネットワーク状態が変わったことを chrony に通知する必要があります。\n\nネットワーク状態を chrony に通知する方法としては chronyc を使用する方法と、使用しているネットワーク設定マネージャのディスパッチャを使用する方法があります。\n\n"
    },
    {
      "title": "NetworkManager",
      "level": 3,
      "content": "NetworkManager の dispatcher スクリプトを使うことで、ネットワークの接続によって chronyd をオンライン/オフラインモードに切り替えることができます。AUR から networkmanager-dispatcher-chronyAUR をインストールして使うことができます。\n\n"
    },
    {
      "title": "netctl",
      "level": 3,
      "content": "AUR から netctl-dispatcher-chronyAUR をインストールしてください。netctl にフックが追加され接続時に自動的に実行されます。\n\n"
    },
    {
      "title": "参照",
      "level": 2,
      "content": "- 時刻 (コンピュータの時刻同期に関する情報が揃っています)\n- http://chrony.tuxfamily.org/\n- http://www.ntp.org/\n- http://support.ntp.org/\n- http://www.pool.ntp.org/\n- http://www.eecis.udel.edu/~mills/ntp/html/index.html\n- http://www.akadia.com/services/ntp_synchronize.html\n\n"
    }
  ]
}