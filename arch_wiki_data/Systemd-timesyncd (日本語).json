{
  "title": "Systemd-timesyncd (日本語)",
  "url": "https://wiki.archlinux.org/title/Systemd-timesyncd_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "関連記事\n\n- systemd-networkd\n- systemd\n- システム時刻\n\nsystemd メーリングリスト より:\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 設定\n- 2 使い方 2.1 起動して有効化 2.2 サービスをチェック 2.3 冗長チェック 2.4 デフォルト以外の設定を表示する 2.5 ログを見る\n- 3 参照\n\n- 2.1 起動して有効化\n- 2.2 サービスをチェック\n- 2.3 冗長チェック\n- 2.4 デフォルト以外の設定を表示する\n- 2.5 ログを見る\n\n"
    },
    {
      "title": "設定",
      "level": 2,
      "content": "systemd で利用可能な systemd-timesyncd.service を 起動/有効化 します。 起動すると、systemd-timesyncd は /etc/systemd/timesyncd.conf から設定ファイルを読み取ります。これは次のようになります。\n\n```\n/etc/systemd/timesyncd.conf\n```\n\n```\n[Time]\n#NTP=\n#FallbackNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org\n#RootDistanceMaxSec=5\n#PollIntervalMinSec=32\n#PollIntervalMaxSec=2048\n```\n\n時刻サーバーを追加したり変更するには、適当な行をアンコメントして、空白で区切られたホスト名か IP を記述してください。例えば、NTP プールプロジェクト によって提供されているサーバーやデフォルトの Arch のサーバーを使うことができます (こちらも NTP プールプロジェクトによって提供されています):\n\n```\n/etc/systemd/timesyncd.conf\n```\n\n```\n[Time]\nNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org\nFallbackNTP=0.pool.ntp.org 1.pool.ntp.org 0.jp.pool.ntp.org\n```\n\n構成を確認するには、timedatectl show-timesync --all を使用します。\n\n```\n$ timedatectl show-timesync --all\n```\n\n```\nLinkNTPServers=\nSystemNTPServers=\nFallbackNTPServers=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org\nServerName=0.arch.pool.ntp.org\nServerAddress=103.47.76.177\nRootDistanceMaxUSec=5s\nPollIntervalMinUSec=32s\nPollIntervalMaxUSec=34min 8s\nPollIntervalUSec=1min 4s\nNTPMessage={ Leap=0, Version=4, Mode=4, Stratum=2, Precision=-21, RootDelay=177.398ms, RootDispersion=142.196ms, Reference=C342F10A, OriginateTimestamp=Mon 2018-07-16 13:53:43 +08, ReceiveTimestamp=Mon 2018-07-16 13:53:43 +08, TransmitTimestamp=Mon 2018-07-16 13:53:43 +08, DestinationTimestamp=Mon 2018-07-16 13:53:43 +08, Ignored=no PacketCount=1, Jitter=0 }\nFrequency=22520548\n```\n\nデーモンの設定だけでなく、systemd-networkd の設定の NTP= オプションを使ったり、動的に、DHCP サーバーを使うことで提供される NTP サーバーもあります。\n\n使用される NTP サーバーは以下のルールによって決まります:\n\n- systemd-networkd.service(8) の設定や DHCP によるインターフェイスごとの NTP サーバーが優先されます。\n- /etc/systemd/timesyncd.conf に定義された NTP サーバーは実行時にインターフェイスごとのリストに追加され、デーモンはサーバーのどれかが応答するまで通信を行います。\n- 以上の手順を踏んでも NTP サーバーの情報がまったく得られなかったとき、FallbackNTP= に定義された NTP サーバーのホスト名や IP アドレスが使われます。\n\n- サービスは、同期ごとおよび 60 秒ごとにローカルファイル /var/lib/systemd/timesync/Clock に書き込みます。この場所はハードコーディングされているため、変更できません。\n- この書き込みは、読み取り専用のルートパーティションを実行したり、SD カードへの書き込みを最小限に抑えようとした場合に問題となる可能性があります。\n- 書き込み回数は、PollIntervalMinSec=1d や SaveIntervalSec=infinity のような構成で最小限に抑えることができます。\n\n"
    },
    {
      "title": "起動して有効化",
      "level": 3,
      "content": "systemd-timesyncd サービスは systemd 213 から利用することができます。サービスを起動・有効化するには:\n\n```\n# timedatectl set-ntp true\n```\n\n"
    },
    {
      "title": "サービスをチェック",
      "level": 3,
      "content": "同期プロセスが著しく遅くなる可能性があります。これは予想されることです。問題があると判断する前に、しばらく待つ必要があります。サービスのステータスを確認するには、次を使用します:\n\n```\n$ timedatectl status\n```\n\n```\nLocal time: Thu 2015-07-09 18:21:33 CEST\n           Universal time: Thu 2015-07-09 16:21:33 UTC\n                 RTC time: Thu 2015-07-09 16:21:33\n                Time zone: Europe/Amsterdam (CEST, +0200)\nSystem clock synchronized: yes\n              NTP service: active\n          RTC in local TZ: no\n```\n\n"
    },
    {
      "title": "冗長チェック",
      "level": 3,
      "content": "詳細なサービス情報を表示するには、 timedatectl timesync-status を使います:\n\n```\n$ timedatectl timesync-status\n```\n\n```\nServer: 103.47.76.177 (0.arch.pool.ntp.org)\nPoll interval: 2min 8s (min: 32s; max 34min 8s)\n         Leap: normal\n      Version: 4\n      Stratum: 2\n    Reference: C342F10A\n    Precision: 1us (-21)\nRoot distance: 231.856ms (max: 5s)\n       Offset: -19.428ms\n        Delay: 36.717ms\n       Jitter: 7.343ms\n Packet count: 2\n    Frequency: +267.747ppm\n```\n\n"
    },
    {
      "title": "デフォルト以外の設定を表示する",
      "level": 3,
      "content": "デフォルト以外の設定オプションセットと、それらのオプションの派生元のファイルを確認するには、次を使用します:\n\n```\n$ systemd-analyze cat-config systemd/timesyncd.conf --tldr\n```\n\n```\n# /etc/systemd/timesyncd.conf\n[Time]\n\n# /etc/systemd/timesyncd.conf.d/local.conf\n[Time]\nNTP=0.nl.pool.ntp.org 1.nl.pool.ntp.org 2.nl.pool.ntp.org 3.nl.pool.ntp.org\nRootDistanceMaxSec=0.1\nPollIntervalMinSec=1d\nPollIntervalMaxSec=4w\nSaveIntervalSec=infinity\n```\n\n"
    },
    {
      "title": "ログを見る",
      "level": 3,
      "content": "過去 24 時間のログに記録されたイベントを表示するには、次を使用します:\n\n```\n# journalctl -u systemd-timesyncd --no-hostname --since \"1 day ago\"\n```\n\n```\nJan 19 15:14:20 systemd[1]: Stopping Network Time Synchronization...\nJan 19 15:14:20 systemd[1]: systemd-timesyncd.service: Deactivated successfully.\nJan 19 15:14:20 systemd[1]: Stopped Network Time Synchronization.\nJan 19 15:14:20 systemd[1]: Starting Network Time Synchronization...\nJan 19 15:14:20 systemd[1]: Started Network Time Synchronization.\nJan 19 15:14:20 systemd-timesyncd[1023]: Contacted time server 178.215.228.24:123 (0.nl.pool.ntp.org).\nJan 19 15:14:20 systemd-timesyncd[1023]: Initial clock synchronization to Fri 2024-01-19 15:14:20.393865 CET.\n```\n\n"
    },
    {
      "title": "参照",
      "level": 2,
      "content": "- フォーラム: systemd-timesyncd is not syncing time\n- フォーラム: Using systemd-timesync instead of NTP\n- Git Sourcecode of timesyncd\n- systemd-timesyncd(8)\n- timesyncd.conf(5)\n\n"
    }
  ]
}