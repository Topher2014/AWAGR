{
  "title": "Dm-crypt (Español)/Encrypting a non-root file system (Español)",
  "url": "https://wiki.archlinux.org/title/Dm-crypt_(Espa%C3%B1ol)/Encrypting_a_non-root_file_system_(Espa%C3%B1ol)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Note: **2019-09-19** \n\nLos siguientes son ejemplos de encriptación de un sistema de archivos secundario, es decir, no raíz, con dm-crypt.\n\n"
    },
    {
      "title": "Descripción general",
      "level": 2,
      "content": "El cifrado de un sistema de archivos secundario generalmente protege solo los datos confidenciales, mientras deja el sistema operativo y los archivos de programa sin cifrar. Esto es útil para cifrar un medio externo, como una unidad USB, de modo que se pueda mover a diferentes equipos de forma segura. También se podría optar por encriptar conjuntos de datos por separado según quién tenga acceso a ellos.\n\nComo dm-crypt es una capa de cifrado de nivel de bloque, solo cifra dispositivos completos, #Partición completa y #Dispositivo loop. Para cifrar archivos individuales se requiere una capa de cifrado de nivel de sistema de archivos, como eCryptfs o EncFS. Consulte Disk encryption (Español) para obtener información general sobre cómo proteger datos privados.\n\n"
    },
    {
      "title": "Partición",
      "level": 2,
      "content": "Este ejemplo cubre el cifrado de la partición /home, pero se puede aplicar a cualquier otra partición no raíz comparable que contenga datos de usuario.\n\nPrimero asegúrese de que la partición esté vacía (sin un sistema de archivos asociado). Elimine la partición y cree una vacía si tiene un sistema de archivos. Luego prepare la partición borrándola con seguridad, vea Dm-crypt (Español)/Drive preparation (Español)#Borrar de forma segura la unidad de disco duro.\n\nCree la partición que contendrá el contenedor cifrado.\n\nLuego configure el encabezado LUKS con:\n\n```\n# cryptsetup opciones luksFormat --type luks2 dispositivo\n```\n\nSustituya dispositivo por la partición creada anteriormente. Vea Dm-crypt (Español)/Device encryption (Español)#Opciones de cifrado para la modalidad LUKS para conocer los detalles disponibles para opciones.\n\nPara obtener acceso a la partición cifrada, desbloquéala con el mapeador de dispositivos, utilizando:\n\n```\n# cryptsetup open dispositivo nombre\n```\n\nDespués de desbloquear la partición, estará disponible en /dev/mapper/nombre. Ahora crea un sistema de archivos de su elección con:\n\n```\n# mkfs.sistema_de_archivos /dev/mapper/nombre\n```\n\nMonte el sistema de archivos en /home, o si solo un usuario tiene acceso en /home/nombre_de_usuario, vea #Montaje y desmontaje manual.\n\n"
    },
    {
      "title": "Montaje y desmontaje manual",
      "level": 3,
      "content": "Para montar la partición:\n\n```\n# cryptsetup open dispositivo nombre\n# mount -t sistema_de_archivos /dev/mapper/nombre /mnt/home\n```\n\nPara desmontarla:\n\n```\n# umount /mnt/home\n# cryptsetup close nombre\n```\n\n"
    },
    {
      "title": "Desbloqueo y montaje automatizados",
      "level": 3,
      "content": "Existen tres soluciones diferentes para automatizar el proceso de desbloqueo de la partición y el montaje del sistema de archivos.\n\n"
    },
    {
      "title": "En el momento del arranque",
      "level": 4,
      "content": "Utilizando el archivo de configuración /etc/crypttab, el desbloqueo ocurre en el momento del arranque mediante el análisis automático de systemd. Esta es la solución recomendada si desea utilizar una partición común para todas las particiones «home» de los usuarios o montar automáticamente otro dispositivo de bloques cifrado.\n\nConsulte Dm-crypt (Español)/System configuration (Español)#crypttab para obtener referencias y Dm-crypt (Español)/System configuration (Español)#Montaje en el momento del arranque para ver un ejemplo de configuración.\n\n"
    },
    {
      "title": "En el inicio de sesión del usuario",
      "level": 4,
      "content": "Utilizando pam_exec es posible desbloquear (cryptsetup open) la partición en el inicio de sesión del usuario: esta es la solución recomendada si desea tener el directorio «home» de un solo usuario en una partición. Vea dm-crypt (Español)/Mounting at login (Español).\n\nTambién es posible desbloquear el inicio de sesión del usuario con pam_mount.\n\n"
    },
    {
      "title": "Dispositivo loop",
      "level": 2,
      "content": "Hay dos métodos para usar un dispositivo loop como un contenedor cifrado, uno que usa directamente losetup y otro no.\n\n"
    },
    {
      "title": "Sin losetup",
      "level": 3,
      "content": "La utilización de losetup directamente se puede evitar completamente haciendo lo siguiente [1]:\n\n```\n# dd if=/dev/urandom of=key.img bs=20M count=1\n# cryptsetup --align-payload=1 luksFormat key.img\n```\n\nAntes de ejecutar cryptsetup, mire primero las opciones de cifrado para la modalidad LUKS y los algoritmos de cifrado y modalidades de operación para seleccionar la configuración adicional deseada.\n\nLas instrucciones para abrir el dispositivo y el sistema de archivos son las mismas que para #Partición.\n\nTener un archivo demasiado pequeño le dará un error Requested offset is beyond real size of device /dev/loop0, pero, como referencia aproximada, la creación de un archivo 4 MiB lo encriptará con éxito. [2]\n\nIfSi se crea un archivo más grande, dd de /dev/urandom se detendrá después de 32 MiB, requiriendo la opción iflag=fullblock para completar la escritura. [3]\n\nEl procedimiento de montar y desmontar manualmente es equivalente a #Montaje y desmontaje manual.\n\n"
    },
    {
      "title": "Con losetup",
      "level": 3,
      "content": "Un dispositivo de looppermite asignar un dispositivo de bloques a un archivo con la herramienta estándar losetup de util-linux. El archivo puede contener un sistema de archivos, que se puede usar como cualquier otro sistema de archivos. Muchos usuarios conocen TrueCrypt como una herramienta para crear contenedores cifrados. Casi la misma funcionalidad se puede lograr con un sistema de archivos loopback cifrado con LUKS y es el que se muestra en el siguiente ejemplo.\n\nPrimero, comience creando un contenedor cifrado, utilizando un generador de números aleatorios apropiado:\n\n```\n# dd if=/dev/urandom of=/bigsecret bs=1M count=10\n```\n\nEsto creará el archivo bigsecret con un tamaño de 10 megabytes.\n\nA continuación, cree el nodo del dispositivo /dev/loop0,de modo que podamos montar/usar nuestro contenedor:\n\n```\n# losetup /dev/loop0 /bigsecret\n```\n\nA partir de ahora, el procedimiento es el mismo que para #Partición, excepto por el hecho de que el contenedor ya está asignado al azar y no necesitará otro borrado seguro.\n\n"
    },
    {
      "title": "Desmontar y montar manualmente",
      "level": 4,
      "content": "Para desmontar el contenedor:\n\n```\n# umount /mnt/secret\n# cryptsetup close secret\n# losetup -d /dev/loop0\n```\n\nPara montar el contenedor de nuevo:\n\n```\n# losetup /dev/loop0 /bigsecret\n# cryptsetup open /dev/loop0 secret\n# mount -t ext4 /dev/mapper/secret /mnt/secret\n```\n\n"
    }
  ]
}