{
  "title": "Samba (日本語)",
  "url": "https://wiki.archlinux.org/title/Samba_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Table content:\nこの記事あるいはセクションは翻訳の途中です。 ノート: 翻訳が古くなっています。 (議論: トーク:Samba#)\n\n関連記事\n\n- Active Directory integration\n- Samba/Active Directory ドメインコントローラ\n- NFS\n\nSamba は SMB/CIFS ネットワークプロトコルの再実装であり、NFS の代わりになるものとして Linux と Windows システム間でのファイルやプリンターの共有を容易にします。Samba の設定は簡単で操作もわかりやすいと言うユーザーもいますが、新規ユーザーの多くは複雑で直感的でないメカニズムが手を余らせることになります。この記事では Samba をセットアップする手順を説明します。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 サーバーの設定 1.1 smb.conf 1.2 共有を作成する 1.3 サービスを起動する 1.4 ユーザー定義共有を作成する 1.5 ユーザーを追加する 1.6 ユーザーを一覧する 1.7 samba ユーザーのパスワードを変更する 1.8 必要なポート 1.9 サンプル設定 1.10 高度な設定 1.10.1 スループットを向上させる\n- 2 クライアントの設定 2.1 公開されている共有の確認 2.2 NetBIOS/WINS ホストネーム 2.3 手動マウント 2.3.1 共有パスワードの保存 2.4 自動マウント 2.4.1 マウントエントリ 2.4.2 systemd ユニット 2.4.3 smbnetfs 2.4.3.1 デーモン 2.4.4 autofs 2.5 ファイルマネージャの設定 2.5.1 GNOME Files, Nemo, Caja, Thunar, PCManFM 2.5.2 KDE 2.5.3 他のグラフィカル環境\n- 3 ヒントとテクニック 3.1 セキュリティを高めるために SMB1 プロトコルを無効化 3.2 パフォーマンスを改善する 3.3 プリンター共有を無効化 3.4 Samba 共有で特定のファイル拡張子をブロック 3.5 ネットワーク共有の探知 3.6 Windows コンピュータの遠隔操作 3.7 ユーザー名やパスワードが不要なファイル共有 3.8 CUPS を無効にして Samba をビルド\n- 4 トラブルシューティング 4.1 Samba SMB/CIFS サーバーが起動できない 4.2 AppArmor におけるパーミッションの問題 4.3 ファイルを上書きできない、パーミッションエラー 4.4 ゲストパーミッションで Samba 共有を作成しても Windows クライアントがパスワードを要求する 4.5 Windows 7 の接続の問題 - mount error(12): cannot allocate memory 4.6 Windows 10 1709 以上で接続に問題が発生する - \"Windows cannot access\" 0x80004005 4.7 Error: Failed to retrieve printer list: NT_STATUS_UNSUCCESSFUL 4.8 フォルダの共有ができなくなる 4.9 \"Failed to retrieve share list from server\" というエラーでネットワークを閲覧できない 4.10 ネットワークを閲覧すると空のフォルダが表示される 4.11 Protocol negotiation failed: NT_STATUS_INVALID_NETWORK_RESPONSE 4.12 Connection to SERVER failed: (Error NT_STATUS_UNSUCCESSFUL) 4.13 Connection to SERVER failed: (Error NT_STATUS_CONNECTION_REFUSED) 4.14 Protocol negotiation failed: NT_STATUS_CONNECTION_RESET 4.15 正しいはずなのにパスワードエラーが発生する (error 1326) 4.16 Windows の予約文字のマッピング 4.17 Mount error: Host is down\n- 5 参照\n\n- 1.1 smb.conf\n- 1.2 共有を作成する\n- 1.3 サービスを起動する\n- 1.4 ユーザー定義共有を作成する\n- 1.5 ユーザーを追加する\n- 1.6 ユーザーを一覧する\n- 1.7 samba ユーザーのパスワードを変更する\n- 1.8 必要なポート\n- 1.9 サンプル設定\n- 1.10 高度な設定 1.10.1 スループットを向上させる\n\n- 1.10.1 スループットを向上させる\n\n- 2.1 公開されている共有の確認\n- 2.2 NetBIOS/WINS ホストネーム\n- 2.3 手動マウント 2.3.1 共有パスワードの保存\n- 2.4 自動マウント 2.4.1 マウントエントリ 2.4.2 systemd ユニット 2.4.3 smbnetfs 2.4.3.1 デーモン 2.4.4 autofs\n- 2.5 ファイルマネージャの設定 2.5.1 GNOME Files, Nemo, Caja, Thunar, PCManFM 2.5.2 KDE 2.5.3 他のグラフィカル環境\n\n- 2.3.1 共有パスワードの保存\n\n- 2.4.1 マウントエントリ\n- 2.4.2 systemd ユニット\n- 2.4.3 smbnetfs 2.4.3.1 デーモン\n- 2.4.4 autofs\n\n- 2.4.3.1 デーモン\n\n- 2.5.1 GNOME Files, Nemo, Caja, Thunar, PCManFM\n- 2.5.2 KDE\n- 2.5.3 他のグラフィカル環境\n\n- 3.1 セキュリティを高めるために SMB1 プロトコルを無効化\n- 3.2 パフォーマンスを改善する\n- 3.3 プリンター共有を無効化\n- 3.4 Samba 共有で特定のファイル拡張子をブロック\n- 3.5 ネットワーク共有の探知\n- 3.6 Windows コンピュータの遠隔操作\n- 3.7 ユーザー名やパスワードが不要なファイル共有\n- 3.8 CUPS を無効にして Samba をビルド\n\n- 4.1 Samba SMB/CIFS サーバーが起動できない\n- 4.2 AppArmor におけるパーミッションの問題\n- 4.3 ファイルを上書きできない、パーミッションエラー\n- 4.4 ゲストパーミッションで Samba 共有を作成しても Windows クライアントがパスワードを要求する\n- 4.5 Windows 7 の接続の問題 - mount error(12): cannot allocate memory\n- 4.6 Windows 10 1709 以上で接続に問題が発生する - \"Windows cannot access\" 0x80004005\n- 4.7 Error: Failed to retrieve printer list: NT_STATUS_UNSUCCESSFUL\n- 4.8 フォルダの共有ができなくなる\n- 4.9 \"Failed to retrieve share list from server\" というエラーでネットワークを閲覧できない\n- 4.10 ネットワークを閲覧すると空のフォルダが表示される\n- 4.11 Protocol negotiation failed: NT_STATUS_INVALID_NETWORK_RESPONSE\n- 4.12 Connection to SERVER failed: (Error NT_STATUS_UNSUCCESSFUL)\n- 4.13 Connection to SERVER failed: (Error NT_STATUS_CONNECTION_REFUSED)\n- 4.14 Protocol negotiation failed: NT_STATUS_CONNECTION_RESET\n- 4.15 正しいはずなのにパスワードエラーが発生する (error 1326)\n- 4.16 Windows の予約文字のマッピング\n- 4.17 Mount error: Host is down\n\n"
    },
    {
      "title": "サーバーの設定",
      "level": 2,
      "content": "Samba を使ってファイルを共有するには、samba パッケージをインストールしてください。\n\n"
    },
    {
      "title": "smb.conf",
      "level": 3,
      "content": "Samba サーバーの設定は /etc/samba/smb.conf で行います。ファイルが存在しないと smbd は起動に失敗します。\n\nこちら にあるデフォルトの Samba 設定ファイルを /etc/samba/smb.conf にコピーしてください:\n\n```\n# wget \"https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD\" -O /etc/samba/smb.conf\n```\n\n利用可能なオプションは smb.conf(5) の man ページを参照してください。また、testparm(1) コマンドを実行することで samba 設定ファイルが正しいかどうか確認できます。\n\n"
    },
    {
      "title": "共有を作成する",
      "level": 3,
      "content": "/etc/samba/smb.conf を編集して、Share Definitions セクションまでスクロールしてください。デフォルトの設定では、それぞれのユーザーのホームディレクトリに共有を自動で作成します。ただし、users ワイルドカードを追加しないとユーザーはログインすることができません:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n...\n[homes]\n   comment = Home Directories\n   browseable = no\n   writable = yes\n   valid users = %S\n```\n\nsmb.conf の workgroup は使用する Windows のワークグループと同じ値に設定してください (デフォルト: WORKGROUP)。\n\n"
    },
    {
      "title": "サービスを起動する",
      "level": 3,
      "content": "SMB の基本的なファイル共有をするには、smb と nmb サービスを起動してください。詳しくは smbd(8) と nmbd(8) のマニュアルページを見て下さい。\n\n"
    },
    {
      "title": "ユーザー定義共有を作成する",
      "level": 3,
      "content": "\"Usershares\" は root 以外のユーザーで共有の定義を追加、変更、および削除できるようにする機能です。\n\n次のコマンドは /var/lib/samba に usershares ディレクトリを作成します:\n\n```\n# mkdir -p /var/lib/samba/usershares\n```\n\n次のコマンドは sambashare グループを作成します:\n\n```\n# groupadd -r sambashare\n```\n\n次のコマンドは root に作成したディレクトリの所有者とグループを変更します:\n\n```\n# chown root:sambashare /var/lib/samba/usershares\n```\n\n次のコマンドは usershares ディレクトリのパーミッションを変更して sambashare グループのユーザーがファイルを読み書き・実行できるようにします:\n\n```\n# chmod 1770 /var/lib/samba/usershares\n```\n\nsmb.conf 設定ファイルに以下の変数を設定します:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n...\n[global]\n  usershare path = /var/lib/samba/usershares\n  usershare max shares = 100\n  usershare allow guests = yes\n  usershare owner only = yes\n  ...\n```\n\nsambashare グループにあなたのユーザーを追加してください、your_username はあなたの linux ユーザーの名前に置き換えてください:\n\n```\n# gpasswd sambashare -a your_username\n```\n\nsmb.service と nmb.service サービスを再起動します。\n\n一度ログアウトして再ログインしてください。これで GUI を使って samba 共有を設定することができます。例えば、Thunar でディレクトリを右クリックしてネットワーク上に共有することが可能です。エラー You are not the owner of the folder が表示されるときは、システムを再起動してみてください。\n\n"
    },
    {
      "title": "ユーザーを追加する",
      "level": 3,
      "content": "Samba は Linux ユーザーアカウントを必要とします。既存のユーザーアカウントを使用することもできますし、新しくユーザーを作成することもできます。\n\nユーザー名は Linux 環境と共有しますが、パスワードは Linux のユーザーアカウントと Samba で異なります。samba_user は Samba ユーザーアカウントに置き換えてください:\n\n```\n# pdbedit -a -u samba_user\n```\n\nサーバーロール によっては、Samba ユーザーアカウントの既存のファイルのパーミッションと属性を変更する必要があります。\n\n新規ユーザーだけが Samba のファイルサーバー共有にリモートからアクセスできるようにしたい場合、他のログインオプションを制限します：\n\n- シェルを無効化 - usermod --shell /usr/bin/nologin --lock username。\n- SSH ログインを無効化 - /etc/ssh/sshd_conf を編集して AllowUsers オプションを変更。\n\nシステムの堅牢化についてはセキュリティを見てください。\n\n"
    },
    {
      "title": "ユーザーを一覧する",
      "level": 3,
      "content": "Samba のユーザーは pdbedit(8) コマンドで確認できます:\n\n```\n# pdbedit -L -v\n```\n\n"
    },
    {
      "title": "samba ユーザーのパスワードを変更する",
      "level": 3,
      "content": "ユーザーのパスワードを変更するには、smbpasswd を使って下さい:\n\n```\n# smbpasswd samba_user\n```\n\n"
    },
    {
      "title": "必要なポート",
      "level": 3,
      "content": "ファイアウォールを使う場合は、必要なポートを開くことを忘れないでください (通常は、137-139 + 445)。必要なポートのリストは次を参照: Samba port usage。\n\n"
    },
    {
      "title": "サンプル設定",
      "level": 3,
      "content": "設定オプションの詳しい説明は smb.conf(5) を見て下さい。オンライン版は こちら になります。\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n  deadtime = 60 ; This is useful to stop a server's resources being exhausted by a large number of inactive connections\n  disable netbios = yes ; Disable netbios announcing\n  dns proxy = no ; nmbd spawns a second copy of itself to do the DNS name lookup requests on 'yes'\n  hosts allow = 192.168.1. 127. 10. ; This parameter is a comma, space, or tab delimited set of hosts which are permitted to access a service\n  invalid users = root ; This is a list of users that should not be allowed to login to this service\n  security = user ; Use as standalone file server\n  map to guest = Bad User ; Means user logins with an invalid password are rejected, or allow guest login and mapped into the guest account\n  max connections = 100 ; Number of simultaneous connections to a service to be limited\n  workgroup = WORKGROUP ; Workgroup the server will appear to be in when queried by clients\n\n  ; Uncomment the following lines to disable printer support\n  ;load printers = no\n  ;printing = bsd\n  ;printcap name = /dev/null\n  ;disable spoolss = yes\n\n  ; Default permissions for all shares  \n  inherit owner = yes ; Take the ownership of the parent directory when creating files/folders\n  create mask = 0664 ; Create file mask\n  directory mask = 0775 ; Create director mask\n  force create mode = 0664 ; Force create file mask\n  force directory mode = 0775 ; Force create directory mask\n\n; Private Share\n[private] ; translate into: \\\\server\\private\n  comment = My Private Share ; Seen next to a share when a client queries the server\n  path = /path/to/data ; Directory to which the user of the service is to be given access\n  read only = no ; An inverted synonym to writeable.\n  valid users = user1 user2 @group1 @group2; restrict a service to a particular set of users and/or groups\n\n; Public Share\n;[public]\n; comment = My Public Share\n; path = /path/to/public\n; read only = yes\n; guest ok = yes; No password required to connect to the service\n```\n\n設定の変更を適用するために smb や nmb サービスを再起動してください。\n\n"
    },
    {
      "title": "スループットを向上させる",
      "level": 4,
      "content": "ほとんどのユーザにとってデフォルトの設定で十分なはずです。しかし、'ソケットオプション'を正しく設定することでパフォーマンスが向上する可能性がありますが、設定を間違うと同じくらいパフォーマンスが低下してしまう可能性があります。大きな変更を加える前に効果をテストしてください。\n\n以下のオプションを適用する前に smb.conf(5) man ページを読んでください。\n\n以下の設定は /etc/samba/smb.conf の [global] セクションに追加する必要があります。\n\ndeadtime を設定することで、大量の非アクティブな接続によってサーバのリソースが浪費されることを防ぐことができます:\n\n```\ndeadtime = 30\n```\n\nsendfile を使うことで、システムの CPU をより効率的に使用することができ、Samba をより高速化できます:\n\n```\nuse sendfile = yes\n```\n\nmin receivefile size を設定することで、ネットワークソケットのバッファからファイルシステムのバッファキャッシュへのゼロコピーの直接書き込みが可能になります。パフォーマンスが向上する場合がありますが、ユーザによるテストが推奨されます:\n\n```\nmin receivefile size = 16384\n```\n\n受信側と送信側のバッファサイズを増やし、ソケット最適化フラグを使用することで、スループットが向上するかもしれません。フラグは一部のネットワークで問題を引き起こす場合があるので、それぞれのフラグをテストすることが推奨されます:\n\n```\nsocket options = IPTOS_LOWDELAY TCP_NODELAY IPTOS_THROUGHPUT SO_RCVBUF=131072 SO_SNDBUF=131072\n```\n\n"
    },
    {
      "title": "クライアントの設定",
      "level": 2,
      "content": "FTP ライクなコマンドラインインターフェイスを使うには smbclient をインストールします。よく使うコマンドは smbclient(1) を見てください。\n\n公開されている共有の確認などをする必要がない場合、/usr/bin/mount.cifs が含まれている cifs-utils だけをインストールしてください。\n\nデスクトップ環境によっては、GUI で設定することができます。ファイルマネージャを使用する方法はファイルマネージャの設定を見てください。\n\n- smbclient は /etc/samba/smb.conf ファイルを必要とします。touch で空のファイルを作成するか、あるいはデフォルトの smb.conf からコピーしてください。\n- cifs-utils や smbclient をインストールしたら、cifs カーネルモジュールをロードするか再起動が必要です。\n\n"
    },
    {
      "title": "公開されている共有の確認",
      "level": 3,
      "content": "以下のコマンドでパブリックな共有を確認できます:\n\n```\n$ smbclient -L hostname -U%\n```\n\nもしくは、smbtree を実行して共有のツリー図を表示します。コンピュータが多数接続されているネットワークでは推奨しませんが、共有名が正しいかどうか確認するのに役立ちます:\n\n```\n$ smbtree -N\n```\n\n-N (-no-pass) はパスワードを要求しないオプションです。\n\n"
    },
    {
      "title": "NetBIOS/WINS ホストネーム",
      "level": 3,
      "content": "ホストネームを解決するには winbind を起動・有効化する必要があります。\n\nsmbclient パッケージに WINS を使用してホストネームを解決するドライバーが含まれています。有効にするには、/etc/nsswitch.conf の \"hosts\" 行に wins を追加してください。\n\n"
    },
    {
      "title": "手動マウント",
      "level": 3,
      "content": "共有のマウントポイントを作成:\n\n```\n# mkdir /mnt/mountpoint\n```\n\nmount.cifs タイプを使って共有をマウントします。下で示しているオプションが全て必要・推奨というわけではありません:\n\n```\n# mount -t cifs //SERVER/sharename /mnt/mountpoint -o username=username,password=password,uid=username,gid=group,workgroup=workgroup,ip=serverip,iocharset=utf8\n```\n\nマウントポイントがユーザーの制御下にあるディレクトリ (例: ユーザーのホームディレクトリ) の場合、users マウントオプションを追加することでユーザーにマウントを許可できます。\n\nSERVER\n\nsharename\n\nmountpoint\n\n-o [options]\n\n- 最後に / を使うのは止めて下さい。//SERVER/sharename/ は動作しません。\n- マウントが不安定で、途切れたりフリーズする場合、vers= オプションを使って他の SMB プロトコルバージョンを有効にしてみてください。例えば、Windows Vista のマウントには vers=2.0 を使ってみて下さい。\n- シャットダウン時に cifs でマウントしたネットワーク共有のタイムアウトが発生する場合、WPA supplicant#ネットワーク共有 (cifs) をマウントしたときにシャットダウン時に起こる問題を参照。\n\n"
    },
    {
      "title": "共有パスワードの保存",
      "level": 4,
      "content": "誰でも読み取れるファイルにパスワードを保存することは推奨しません。credentials ファイルを作成するのが安全です:\n\n```\n/path/to/credentials/share\n```\n\n```\nusername=myuser\npassword=mypass\n```\n\nマウントコマンドの username=myuser,password=mypass を credentials=/path/to/credentials/share に置き換えてください。\n\ncredential ファイルは root からしか読込・書込できないように設定するべきです:\n\n```\n# chmod 600 /path/to/credentials/share\n```\n\n"
    },
    {
      "title": "マウントエントリ",
      "level": 4,
      "content": "以下は認証が必要な cifs マウントエントリの例です:\n\n```\n/etc/fstab\n```\n\n```\n//SERVER/sharename /mnt/mountpoint cifs username=myuser,password=mypass 0 0\n```\n\nサービスの起動を高速化するために、x-systemd.automount オプションをエントリに追加してください:\n\n```\n/etc/fstab\n```\n\n```\n//SERVER/SHARENAME /mnt/mountpoint cifs credentials=/path/to/smbcredentials/share,x-systemd.automount 0 0\n```\n\n"
    },
    {
      "title": "systemd ユニット",
      "level": 4,
      "content": "/etc/systemd/system に新しい .mount ファイルを作成してください。例: mnt-myshare.mount。\n\n- Requires= は使用しているネットワーク設定に置き換えてください。\n- What= は共有パスに置き換えてください。\n- Where= は共有をマウントするパスに置き換えてください。\n- Options= は共有のマウントオプションです。\n\n```\n/etc/systemd/system/mnt-myshare.mount\n```\n\n```\n[Unit]\nDescription=Mount Share at boot\nRequires=systemd-networkd.service\nAfter=network-online.target\nWants=network-online.target\n\n[Mount]\nWhat=//server/share\nWhere=/mnt/myshare\nOptions=credentials=/etc/samba/creds/myshare,iocharset=utf8,rw,x-systemd.automount\nType=cifs\nTimeoutSec=30\n\n[Install]\nWantedBy=multi-user.target\n```\n\nmnt-myshare.mount を使用するにはユニットを起動します。有効化すると起動時に共有がマウントされます。\n\n"
    },
    {
      "title": "smbnetfs",
      "level": 4,
      "content": "まず、マウントしたい共有が全て見れるかどうか確認してください:\n\n```\n$ smbtree -U remote_user\n```\n\n見れない場合、/etc/samba/smb.conf 内の次の行を見つけて修正してください:\n\n```\ndomain master = auto\n```\n\nそして smb と nmb サービスを再起動してください。\n\n全てが問題なく動作するようになったら、smbnetfs パッケージをインストールしてください。\n\n次に、次の行を /etc/fuse.conf に追加して:\n\n```\nuser_allow_other\n```\n\nfuse カーネルモジュールをロードしてください:\n\n```\n# modprobe fuse\n```\n\nさらに /etc/smbnetfs/.smb ディレクトリをホームディレクトリにコピーします:\n\n```\n$ cp -a /etc/smbnetfs/.smb ~\n```\n\nそして smb.conf へのリンクを作成してください:\n\n```\n$ ln -sf /etc/samba/smb.conf ~/.smb/smb.conf\n```\n\n共有フォルダにアクセスするのにユーザー名とパスワードが必要な場合は、~/.smb/smbnetfs.auth を編集して以下のように一つ以上エントリを含めて下さい:\n\n```\n~/.smb/smbnetfs.auth\n```\n\n```\nauth\t\t\t\"hostname\" \"username\" \"password\"\n```\n\n必要な場合、smbnetfs によってマウントする特定のホストのエントリを追加することも可能です。詳しくは ~/.smb/smbnetfs.conf に書いてあります。\n\nDolphin や Nautilus ファイルマネージャを使用する場合、以下を ~/.smb/smbnetfs.conf に追加することで \"Disk full\" エラーを表示しないようにすることができます。デフォルトでは smbnetfs は空き容量が0バイトだと報告します:\n\n```\n~/.smb/smbnetfs.conf\n```\n\n```\nfree_space_size 1073741824\n```\n\n設定が完了したら、次を実行する必要があります:\n\n```\n$ chmod 600 ~/.smb/smbnetfs.*\n```\n\n設定に問題があると、smbnetfs は insecure config file permissions とエラーを吐きます。\n\n最後に、Samba ネットワークを指定したディレクトリにマウントするために、次を実行してください:\n\n```\n$ smbnetfs mount_point\n```\n\nArch Linux パッケージは smbnetfs にシステム共通のオペレーションモードを追加しています。有効にするには、/etc/smbnetfs/.smb ディレクトリで上記の修正を行う必要があります。\n\nそして、smbnetfs デーモンを通常通りに起動・有効化できます。システム共通のマウントポイントは /mnt/smbnet/ になります。\n\n"
    },
    {
      "title": "autofs",
      "level": 4,
      "content": "Linux におけるカーネルベースの自動マウントの情報は Autofs を見て下さい。\n\n"
    },
    {
      "title": "GNOME Files, Nemo, Caja, Thunar, PCManFM",
      "level": 4,
      "content": "GNOME Files, Nemo, Caja, Thunar, PCManFM で samba 共有にアクセスするには gvfs-smb パッケージをインストールしてください。\n\nCtrl+l を押してロケーションバーに smb://servername/share と入力して共有にアクセスします。\n\nマウントされた共有はファイルシステムで /run/user/your_UID/gvfs や ~/.gvfs にあるように見えます。\n\n"
    },
    {
      "title": "KDE",
      "level": 4,
      "content": "KDE には Samba 共有をブラウズするための機能が内蔵されています。したがってパッケージの追加は必要ありません。ただし、KDE システム設定で GUI を使うには、kdenetwork-filesharing パッケージをインストールしてください。\n\nDolphin でアクセスした時に \"Time Out\" エラーが表示される場合、smb.conf で次の行をアンコメント・編集してください:\n\n```\nname resolve order = lmhosts bcast host wins\n```\n\nこのページ を参照。\n\n"
    },
    {
      "title": "他のグラフィカル環境",
      "level": 4,
      "content": "有用なプログラムは多数ありますが、プログラムのパッケージを作成しなくてはなりません。Arch のパッケージビルドシステムを使ってパッケージを作れます。インストールするのに特定の環境を必要としないために簡単に持ち運ぶことができます。\n\n- pyneighborhoodAUR は公式リポジトリから利用できます。\n- Xffm の LinNeighborhood, RUmba, xffm-samba プラグインは公式リポジトリにも AUR にもありません。公式にはサポートされていない（もしくは非公式サポートすらない）ため、動作がおかしかったり全く動かなかったりします。\n\n"
    },
    {
      "title": "セキュリティを高めるために SMB1 プロトコルを無効化",
      "level": 3,
      "content": "SMB1 プロトコルのセキュリティは問題があるため、大抵のクライアントは SMB2 以上をサポートしています。SMB1 プロトコルによるサーバーへの接続を拒否することでセキュリティを向上できます:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\nserver min protocol = SMB2\n```\n\n"
    },
    {
      "title": "パフォーマンスを改善する",
      "level": 3,
      "content": "```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n        server multi channel support = yes\n        socket options = IPTOS_THROUGHPUT SO_KEEPALIVE\n        deadtime = 30\n        use sendfile = Yes\n        write cache size = 262144\n        min receivefile size = 16384\n        aio read size = 16384\n        aio write size = 16384\n        nt pipe support = no\n```\n\n"
    },
    {
      "title": "プリンター共有を無効化",
      "level": 3,
      "content": "プリンターを共有したくない場合、以下の設定を使ってください:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n        load printers = no\n```\n\n使用する Samba のバージョンによっては、printcap name = /dev/null と disable spools = yes オプションによってさらにリソースを節約できます。\n\n"
    },
    {
      "title": "Samba 共有で特定のファイル拡張子をブロック",
      "level": 3,
      "content": "Samba にはファイルの拡張子など、特定のパターンを使ってファイルをブロックするオプションが存在します。このオプションを使うことでウイルスが繁殖するのを防いだり、特定のファイルで容量が食われるのを防ぐことができます。オプションの詳細は smb.conf(5) を見て下さい。\n\n```\n/etc/samba/smb.conf\n```\n\n```\n...\n[myshare]\n  comment = Private\n  path = /mnt/data\n  read only = no\n  veto files = /*.exe/*.com/*.dll/*.bat/*.vbs/*.tmp/*.mp3/*.avi/*.mp4/*.wmv/*.wma/\n```\n\n"
    },
    {
      "title": "ネットワーク共有の探知",
      "level": 3,
      "content": "ローカルネットワーク上の他のシステムについて何も知らない場合、smbnetfs などの自動化ツールも使えないときは、以下の方法で Samba の共有を手動で調べることができます。\n\n1. まず pacman を使って nmap と smbclient パッケージをインストール。\n\n2. nmap で開いているポートを確認:\n\n```\n# nmap -p 139 -sT \"192.168.1.*\"\n```\n\n上記の例では 192.168.1.* の範囲の IP アドレスとポート 139 をスキャンします。以下のような結果が得られます:\n\n```\n$ nmap -sT \"192.168.1.*\"\n```\n\n```\nStarting nmap 3.78 ( http://www.insecure.org/nmap/ ) at 2005-02-15 11:45 PHT\nInteresting ports on 192.168.1.1:\n(The 1661 ports scanned but not shown below are in state: closed)\nPORT     STATE SERVICE\n139/tcp  open  netbios-ssn\n5000/tcp open  UPnP\n\nInteresting ports on 192.168.1.5:\n(The 1662 ports scanned but not shown below are in state: closed)\nPORT     STATE SERVICE\n6000/tcp open  X11\n\nNmap run completed -- 256 IP addresses (2 hosts up) scanned in 7.255 seconds\n```\n\n最初の結果は他のシステムです。2番目の結果はスキャンを実行したクライアントです。\n\n3. ポート 139 が開いているシステムが見つかったので、nmblookup(1) を使って NetBIOS の名前をチェック:\n\n```\n$ nmblookup -A 192.168.1.1\n```\n\n```\nLooking up status of 192.168.1.1\n        PUTER           <00> -         B <ACTIVE>\n        HOMENET         <00> - <GROUP> B <ACTIVE>\n        PUTER           <03> -         B <ACTIVE>\n        PUTER           <20> -         B <ACTIVE>\n        HOMENET         <1e> - <GROUP> B <ACTIVE>\n        USERNAME        <03> -         B <ACTIVE>\n        HOMENET         <1d> -         B <ACTIVE>\n        MSBROWSE        <01> - <GROUP> B <ACTIVE>\n```\n\n<20> を見て下さい。これはホストがサービスを開いていることを示します。\n\n4. smbclient を使って PUTER で共有されているサービスを確認します。パスワードの入力が求められたら、エンターを押すとリストが表示されます:\n\n```\n$ smbclient -L \\\\PUTER\n```\n\n```\nSharename       Type      Comment\n---------       ----      -------\nMY_MUSIC        Disk\nSHAREDDOCS      Disk\nPRINTER$        Disk\nPRINTER         Printer\nIPC$            IPC       Remote Inter Process Communication\n\nServer               Comment\n---------            -------\nPUTER\n\nWorkgroup            Master\n---------            -------\nHOMENET               PUTER\n```\n\n"
    },
    {
      "title": "Windows コンピュータの遠隔操作",
      "level": 3,
      "content": "Samba には Windows と対話するためのツールが含まれています。リモートデスクトップで Windows コンピュータにアクセスできない場合に便利です。以下に例を示します。\n\nコメントとシャットダウンコマンドを送信:\n\n```\n$ net rpc shutdown -C \"comment\" -I IPADDRESS -U USERNAME%PASSWORD\n```\n\n-C とコメントを -f に変えることで強制的にシャットダウンさせることができます。再起動させるには、-C や -f の後に -r を追加します。\n\nサービスを停止・起動:\n\n```\n$ net rpc service stop SERVICENAME -I IPADDRESS -U USERNAME%PASSWORD\n```\n\n利用可能な net rpc コマンドを全て確認するには:\n\n```\n$ net rpc\n```\n\n"
    },
    {
      "title": "ユーザー名やパスワードが不要なファイル共有",
      "level": 3,
      "content": "/etc/samba/smb.conf を編集して以下の行を追加してください:\n\n```\nmap to guest = Bad User\n```\n\n上記の行は以下の行の後ろに追加します:\n\n```\nsecurity = user\n```\n\n共有データを特定のインターフェイスに制限するため以下の行を:\n\n```\n;   interfaces = 192.168.12.2/24 192.168.13.2/2\n```\n\n以下のように置き換えてください:\n\n```\ninterfaces = lo eth0\nbind interfaces only = true\n```\n\n任意で共有にアクセスするアカウントを編集します。以下の行を編集してください:\n\n```\n;   guest account = nobody\n```\n\n例:\n\n```\nguest account = pcguest\n```\n\nそれから以下のようにユーザーを作成します:\n\n```\n# useradd -c \"Guest User\" -d /dev/null -s /bin/false pcguest\n```\n\npcguest ユーザーのパスワードは \"\" (空) に設定してください。\n\n最後に共有ディレクトリを作成 (書き込みを許可したい場合は writable = yes としてください):\n\n```\n[Public Share]\npath = /path/to/public/share\navailable = yes\nbrowsable = yes\npublic = yes\nwritable = no\n```\n\n"
    },
    {
      "title": "CUPS を無効にして Samba をビルド",
      "level": 3,
      "content": "Samba Wiki より:\n\nCUPS を無効化するには PKGBUILD を修正する必要があります。depends と makedepends から libcups を消して cups や印刷に関する行を無くしてください。4.1.9-1 の PKGBUILD の場合、169・170・236行目が該当します:\n\n```\nmkdir -p ${pkgdir}/usr/lib/cups/backend\nln -sf /usr/bin/smbspool ${pkgdir}/usr/lib/cups/backend/smb\ninstall -d -m1777 ${pkgdir}/var/spool/samba\n```\n\n"
    },
    {
      "title": "Samba SMB/CIFS サーバーが起動できない",
      "level": 3,
      "content": "/var/cache/samba/ のパーミッションが正しく設定されているか確認して smb.service を再起動してください:\n\n```\n# chmod 0755 /var/cache/samba/msg\n```\n\n"
    },
    {
      "title": "AppArmor におけるパーミッションの問題",
      "level": 3,
      "content": "共有パスをホームディレクトリ以外に設定した場合、/etc/apparmor.d/local/usr.sbin.smbd でホワイトリストに指定してください。例:\n\n```\n/etc/apparmor.d/local/usr.sbin.smbd\n```\n\n```\n/data/** lrwk,\n```\n\n"
    },
    {
      "title": "ファイルを上書きできない、パーミッションエラー",
      "level": 3,
      "content": "以下の方法を試してみてください:\n\n- /etc/fstab のエントリに nodfs マウントオプションを追加。\n- サーバーの /etc/samba/smb.conf の [global] セクションに msdfs root = no を追加。\n\n"
    },
    {
      "title": "ゲストパーミッションで Samba 共有を作成しても Windows クライアントがパスワードを要求する",
      "level": 3,
      "content": "/etc/samba/smb.conf の global セクションに map to guest を設定してください:\n\n```\nmap to guest = Bad User\n```\n\n"
    },
    {
      "title": "Windows 7 の接続の問題 - mount error(12): cannot allocate memory",
      "level": 3,
      "content": "Windows 7 には既知のバグが存在し、Linux では全く問題ない cifs 共有であっても mount error(12): cannot allocate memory が発生します。以下のように Windows のレジストリキーを設定することで修正できます:\n\n- HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\LargeSystemCache (set to 1)\n- HKLM\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\\Size (set to 3)\n\nもしくは、管理者モードでコマンドプロンプトを起動して以下を実行してください:\n\n```\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management\" /v \"LargeSystemCache\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\" /v \"Size\" /t REG_DWORD /d 3 /f\n```\n\n設定を適用するには以下のどれかを実行する必要があります:\n\n- Windows の再起動\n- services.msc でサーバーサービスを再起動\n- コマンドプロンプトから次を実行: net stop lanmanserver と net start lanmanserver。サーバーは停止後に自動的に再起動します。\n\nオリジナルの記事 。\n\n"
    },
    {
      "title": "Windows 10 1709 以上で接続に問題が発生する - \"Windows cannot access\" 0x80004005",
      "level": 3,
      "content": "Windows 10 バージョン 1709 を使っている一部のマシンで発生するエラーです。このエラーは SMB1 が無効になっていることとは関係がなく、Microsoft によってセキュアでないゲストログインが一部で無効化されたことが原因です。\n\n解決するには、グループポリシーエディタ (gpedit.msc) を開いて Computer configuration\\administrative templates\\network\\Lanman Workstation > Enable insecure guest logons を有効にしてください。もしくは、レジストリの以下の値を変更してください:\n\n```\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\LanmanWorkstation\\Parameters]\n\"AllowInsecureGuestAuth\"=dword:1\n```\n\n"
    },
    {
      "title": "Error: Failed to retrieve printer list: NT_STATUS_UNSUCCESSFUL",
      "level": 3,
      "content": "ホームユーザーで Samba をサーバーや NAS とのファイル共有のためだけに使っている場合、Samba によるプリンターの共有は必要ないと思うかもしれません。そのような場合、以下の行を /etc/samba/smb.conf に追加することでエラーが発生しないようにできます:\n\n```\nload printers = No\nprinting = bsd\nprintcap name = /dev/null\ndisable spoolss = Yes\n```\n\nSamba サービス smb.service を再起動してログを確認してください:\n\n```\n# cat /var/log/samba/smbd.log\n```\n\nエラーが表示されなくなったはずです。\n\n"
    },
    {
      "title": "フォルダの共有ができなくなる",
      "level": 3,
      "content": "Dolphin (ファイルマネージャ) でフォルダを共有したときに、最初は問題なく共有できたのに、Dolphin を再起動すると共有フォルダの共有アイコンが消えてしまい、ターミナル (Konsole) に以下のような出力がされることがあります:\n\n```\n‘net usershare’ returned error 255: net usershare: usershares are currently disabled\n```\n\nこの問題を修正するには、#ユーザー定義共有を作成するに書かれているように usershare を有効にしてください。\n\n"
    },
    {
      "title": "\"Failed to retrieve share list from server\" というエラーでネットワークを閲覧できない",
      "level": 3,
      "content": "(学校や大学、ホテルなどの) ローカルネットワークが信頼できないためにファイアウォール (iptables) を使っている場合、次のような理由が考えられます: smbclient がローカルネットワークを閲覧するとき udp ポート 137 でブロードキャストリクエストが送信されます。ネットワーク上のサーバーはクライアントに返答しますが、返答の送信元アドレスが送信先アドレスと食い違うため、iptables は返答を \"ESTABLISHED\" や \"RELATED\" と認識できず、パケットをドロップします。iptables の設定に以下を追加することで解決できます:\n\n```\niptables -t raw -A OUTPUT -p udp -m udp --dport 137 -j CT --helper netbios-ns\n```\n\n"
    },
    {
      "title": "ネットワークを閲覧すると空のフォルダが表示される",
      "level": 3,
      "content": "Samba を正しく設定しても、gvfs ベースのファイルマネージャ (Nautilus, PCManFM など) を使用して Windows 共有のネットワークを見ても空のフォルダしか表示されません。Samba 4.7 でデフォルトプロトコルが変更されたためにファイルブラウザで問題が発生するようになっています。一時的な解決策として smb.conf 設定ファイルに以下のパラメータを追加してください:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n...\n[global]\n  client max protocol = NT1\n  ...\n```\n\n"
    },
    {
      "title": "Protocol negotiation failed: NT_STATUS_INVALID_NETWORK_RESPONSE",
      "level": 3,
      "content": "おそらくクライアントが共有にアクセスする権限がありません。クライアントの IP アドレスが /etc/samba/smb.conf の hosts allow = 行に記述されているか確認してください。\n\n"
    },
    {
      "title": "Connection to SERVER failed: (Error NT_STATUS_UNSUCCESSFUL)",
      "level": 3,
      "content": "おそらく smbclient に間違ったサーバー名を指定しています。サーバー名を確認するには、サーバーで hostnamectl を実行して \"Transient hostname\" の行を見て下さい。\n\n"
    },
    {
      "title": "Connection to SERVER failed: (Error NT_STATUS_CONNECTION_REFUSED)",
      "level": 3,
      "content": "サーバーが起動していることを確認してください。共有ディレクトリが存在していること、アクセスできることを確認してください。\n\n"
    },
    {
      "title": "Protocol negotiation failed: NT_STATUS_CONNECTION_RESET",
      "level": 3,
      "content": "おそらく SMB1 プロトコルが使えないようにサーバーが設定されています。/etc/samba/smb.conf に client max protocol = SMB2 オプションを追加してください。もしくは smbclient に引数として -m SMB2 を指定してください。\n\n"
    },
    {
      "title": "正しいはずなのにパスワードエラーが発生する (error 1326)",
      "level": 3,
      "content": "Samba 4.5 ではデフォルトで NTLMv1 認証が無効になっています。クライアントに最新のバージョンをインストールしてサポートされていないクライアントのアクセスは拒否することが推奨されています。\n\nそれでも NTLMv2 をサポートしていない古いクライアント (例: Windows XP) を使う必要がある場合、NTLMv1 を有効化することができます (セキュリティの観点から非推奨の設定です):\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n   lanman auth = yes\n   ntlm auth = yes\n```\n\nNTLMv1 を有効にしたことで NTLMv2 クライアントが認証できなくなった場合、クライアントに以下のファイルを作成してください:\n\n```\n/home/user/.smb/smb.conf\n```\n\n```\n[global]\n   sec = ntlmv2\n   client ntlmv2 auth = yes\n```\n\n上記の設定は mount.cifs でマウントされた samba の共有にも影響します。Samba 4.5 にアップグレードしてマウントできなくなった場合、mount コマンドに sec=ntlmssp オプションを追加してください。例:\n\n```\n# mount.cifs //server/share /mnt/point -o sec=ntlmssp,...\n```\n\n詳しくは mount.cifs(8) を見てください。3.8 未満のカーネルでは sec=ntlm がデフォルトでしたが、3.8 から sec=ntlmssp に変更されています。\n\n"
    },
    {
      "title": "Windows の予約文字のマッピング",
      "level": 3,
      "content": "カーネル 3.18 から cifs モジュールはデフォルトで \"mapposix\" オプションを使用します [2]。unix 拡張を使って Samba のデフォルト設定で共有をマウントした場合、Windows の7個の予約文字 : \\ * < > ? | が含まれているファイルやディレクトリにアクセスできなくなります。以下の方法で解決することができます:\n\n- cifs の nomapposix マウントオプションを使用する:\n\n```\n# mount.cifs //server/share /mnt/point -o nomapposix\n```\n\n- fruit を使って mapposix (\"SFM\", Services for Mac) 文字を適切な文字にマッピングするように Samba を設定:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n   vfs objects = catia fruit\n   fruit:encoding = native\n```\n\n- catia を使って禁則文字を手動でマッピング:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[global]\n   vfs objects = catia\n   catia:mappings = 0x22:0xf022, 0x2a:0xf02a, 0x2f:0xf02f, 0x3a:0xf03a, 0x3c:0xf03c, 0x3e:0xf03e, 0x3f:0xf03f, 0x5c:0xf05c, 0x7c:0xf07c, 0x20:0xf020\n```\n\ncatia や fruit を使用する方法には出力不可文字でファイルがフィルタリングされるという欠点があります。\n\n"
    },
    {
      "title": "Mount error: Host is down",
      "level": 3,
      "content": "Synology NAS サーバーの共有フォルダをマウントしようとしたときに発生するエラーです。vers=1.0 マウントオプションを使うことで解決します。\n\n"
    },
    {
      "title": "参照",
      "level": 2,
      "content": "- Samba: An Introduction\n- Samba 公式サイト\n\n"
    }
  ]
}