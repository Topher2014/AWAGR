{
  "title": "Dnscrypt-proxy (Русский)",
  "url": "https://wiki.archlinux.org/title/Dnscrypt-proxy_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Ссылки по теме\n\n- Domain name resolution (Русский)\n\ndnscrypt-proxy — это DNS-прокси с поддержкой зашифрованных протоколов DNS over HTTPS и DNSCrypt, что позволяет предотвратить атаки «человек посередине» и подслушивание. dnscrypt-proxy также совместим с DNSSEC.\n\n"
    },
    {
      "title": "Установка",
      "level": 2,
      "content": "Установите пакет dnscrypt-proxy.\n\n"
    },
    {
      "title": "Запуск",
      "level": 3,
      "content": "Служба может быть запущена одним из двух взаимоисключающих способов (т.е. только один из этих двух юнитов может быть включен):\n\n1. С помощью systemd-службы dnscrypt-proxy.service. Тогда должна быть настроена опция listen_addresses (напр. listen_addresses = ['127.0.0.1:53', '[::1]:53']) в файле конфигурации.\n1. Или с помощью сокетной активации через dnscrypt-proxy.socket. Тогда опция listen_addresses должна быть пустой (напр. listen_addresses = [ ]) в файле конфигурации, так как systemd сам позаботится о настройке сокета.\n\n- Тогда должна быть настроена опция listen_addresses (напр. listen_addresses = ['127.0.0.1:53', '[::1]:53']) в файле конфигурации.\n\n- Тогда опция listen_addresses должна быть пустой (напр. listen_addresses = [ ]) в файле конфигурации, так как systemd сам позаботится о настройке сокета.\n\n"
    },
    {
      "title": "Выберите распознаватели",
      "level": 3,
      "content": "Если оставить опцию server_names закомментированной в файле /etc/dnscrypt-proxy/dnscrypt-proxy.toml, то dnscrypt-proxy выберет самый быстрый сервер из источников, прописанных в секции [sources] [3]. Эти списки скачиваются, проверяются и автоматически обновляются [4]. Таким образом, ручная настройка определённого набора серверов необязательна.\n\nЧтобы вручную задать набор используемых серверов, раскомментируйте опцию server_names в файле /etc/dnscrypt-proxy/dnscrypt-proxy.toml и пропишите в ней один или несколько серверов. Например, чтобы использовать серверы Cloudflare:\n\n```\nserver_names = ['cloudflare', 'cloudflare-ipv6']\n```\n\nПолный список распознавателей (resolvers) расположен на странице апстрима или Github. Если dnscrypt-proxy успешно запускался ранее в системе, список также будет расположен в файле /var/cache/dnscrypt-proxy/public-resolvers.md. Посмотрите описание серверов, которые проверяют DNSSEC, не ведут логи и не занимаются цензурой. Эти требования могут быть настроены глобально с помощью опций require_dnssec, require_nolog и require_nofilter.\n\n"
    },
    {
      "title": "Отключите любые службы, слушающие порт 53",
      "level": 3,
      "content": "Чтобы проверить наличие программ, использующих порт 53, выполните:\n\n```\n$ ss -lp 'sport = :domain'\n```\n\nNote: **The factual accuracy of this article or section is disputed.** The factual accuracy of this article or section is disputed.\n\nThe factual accuracy of this article or section is disputed.\n\nЕсли вывод содержит что-то помимо строки с названием столбцов, вам нужно отключить все службы, использующие порт 53. Один из распространённых виновников — systemd-resolved.service(NetworkManager#Unit dbus-org.freedesktop.resolve1.service not found), но другие менеджеры сети также могут иметь аналогичные компоненты. Можно продолжать, если приведённая выше команда не выводит ничего кроме этой строки:\n\n```\nNetid               State                 Recv-Q                Send-Q                                 Local Address:Port                                   Peer Address:Port\n```\n\n"
    },
    {
      "title": "Измените resolv.conf",
      "level": 3,
      "content": "Note: **This article or section needs expansion.** This article or section needs expansion.\n\nThis article or section needs expansion.\n\nИзмените файл resolv.conf и замените ваш текущий адрес распознавателя на localhost с опциями [5]:\n\n```\nnameserver ::1\nnameserver 127.0.0.1\noptions edns0 single-request-reopen\n```\n\nДругие программы могут перезаписывать этот файл; подробнее см. Domain name resolution (Русский)#Перезапись файла /etc/resolv.conf.\n\n"
    },
    {
      "title": "Запустите systemd-службу",
      "level": 3,
      "content": "Наконец, запустите/включите юнит dnscrypt-proxy.service или dnscrypt-proxy.socket в зависимости от выбранного вами ранее способа запуска.\n\n"
    },
    {
      "title": "Проверьте работоспособность dnscrypt-proxy",
      "level": 3,
      "content": "Откройте в браузере DnsLeakTest и выполните «Extended test». Если результат отображает серверы, которые вы выбрали в файле конфигурации, это означает, что dnscrypt-proxy работает; в противном случае что-то пошло не так.\n\n"
    },
    {
      "title": "Настройка локального кэша DNS",
      "level": 3,
      "content": "Если встроенная возможность кэширования не используется, рекомендуется запускать dnscrypt-proxy как сервер пересылки (forwarder) для локального кэша DNS; иначе любой запрос будет приводить к его отправке на вышестоящий распознаватель. Должна работать любая кэширующая программа. В таком случае вам нужно настроить её в дополнение к dnscrypt-proxy.\n\n"
    },
    {
      "title": "Изменение порта",
      "level": 4,
      "content": "В случае пересылки запросов из локального кеша DNS dnscrypt-proxy должен слушать порт отличный от стандартного 53, так как DNS-кэш сам будет слушать этот порт и обращаться к dnscrypt-proxy на другом порту. В этом разделе для примера используется порт 53000 (так как порт больше 1024, dnscrypt-proxy необязательно запускать от имени root).\n\nЕсть два метода изменения порта в зависимости от того, каким способом вы запускаете службу:\n\nСокет\n\nИзмените dnscrypt-proxy.socket, добавив следующее:\n\n```\n[Socket]\nListenStream=\nListenDatagram=\nListenStream=127.0.0.1:53000\nListenStream=[::1]:53000\nListenDatagram=127.0.0.1:53000\nListenDatagram=[::1]:53000\n```\n\nКогда запрос перенаправляется из DNS-кэша на порт 53000, dnscrypt-proxy.socket автоматически запустит dnscrypt-proxy.service.\n\nСлужба\n\nИзмените опцию listen_addresses в файле /etc/dnscrypt-proxy/dnscrypt-proxy.toml:\n\n```\nlisten_addresses = ['127.0.0.1:53000', '[::1]:53000']\n```\n\n"
    },
    {
      "title": "Примеры настройки локального кэша DNS",
      "level": 4,
      "content": "Приведённые настройки должны работать с dnscrypt-proxy, предполагая, что он слушает порт 53000.\n\nНастройте Unbound как вам нужно (см. Unbound (Русский)#Локальный DNS сервер) и добавьте следующие строки в конце секции server в файле /etc/unbound/unbound.conf:\n\n```\ndo-not-query-localhost: no\nforward-zone:\n  name: \".\"\n  forward-addr: ::1@53000\n  forward-addr: 127.0.0.1@53000\n```\n\nПерезапустите unbound.service для применения изменений.\n\nНастройте dnsmasq как локальный кэш DNS. Базовая конфигурация для работы с dnscrypt-proxy:\n\n```\n/etc/dnsmasq.conf\n```\n\n```\nno-resolv\nserver=::1#53000\nserver=127.0.0.1#53000\nlisten-address=::1,127.0.0.1\n```\n\nЕсли вы настроили dnscrypt-proxy на использование распознавателя с включенной проверкой DNSSEC, включите её и в dnsmasq тоже:\n\n```\n/etc/dnsmasq.conf\n```\n\n```\nconf-file=/usr/share/dnsmasq/trust-anchors.conf\ndnssec\n```\n\nПерезапустите dnsmasq.service для применения изменений.\n\nУстановите pdnsd. Базовая конфигурация для работы с dnscrypt-proxy:\n\n```\n/etc/pdnsd.conf\n```\n\n```\nglobal {\n    perm_cache = 1024;\n    cache_dir = \"/var/cache/pdnsd\";\n    run_as = \"pdnsd\";\n    server_ip = 127.0.0.1;\n    status_ctl = on;\n    query_method = udp_tcp;\n    min_ttl = 15m;       # Хранить кэшированные записи не менее 15 минут.\n    max_ttl = 1w;        # Не более 1 недели.\n    timeout = 10;        # Глобальный таймаут (10 секунд).\n    neg_domain_pol = on;\n    udpbufsize = 1024;   # Повышение лимита размера UDP-сообщений.\n}\n\nserver {\n    label = \"dnscrypt-proxy\";\n    ip = 127.0.0.1;\n    port = 53000;\n    timeout = 4;\n    proxy_only = on;\n}\n\nsource {\n    owner = localhost;\n    file = \"/etc/hosts\";\n}\n```\n\nПерезапустите pdnsd.service для применения изменений.\n\n"
    },
    {
      "title": "Включение EDNS0",
      "level": 3,
      "content": "Note: **This article or section needs expansion.** This article or section needs expansion.\n\nThis article or section needs expansion.\n\nEDNS позволяет, помимо других вещей, разрешить указать клиенту, насколько большим может быть UDP-ответ.\n\nДобавьте следующую строку в /etc/resolv.conf:\n\n```\noptions edns0\n```\n\n"
    },
    {
      "title": "Проверка EDNS0",
      "level": 4,
      "content": "Используйте DNS Reply Size Test Server, запустите утилиту drill для отправки TXT-запроса для адреса rs.dns-oarc.net:\n\n```\n$ drill rs.dns-oarc.net TXT\n```\n\nЕсли EDNS0 поддерживается, «answer section» будет содержать примерно такой вывод:\n\n```\nrst.x3827.rs.dns-oarc.net.\nrst.x4049.x3827.rs.dns-oarc.net.\nrst.x4055.x4049.x3827.rs.dns-oarc.net.\n\"2a00:d880:3:1::a6c1:2e89 DNS reply size limit is at least 4055 bytes\"\n\"2a00:d880:3:1::a6c1:2e89 sent EDNS buffer size 4096\"\n```\n\n"
    }
  ]
}