{
  "title": "Fsck (Русский)",
  "url": "https://wiki.archlinux.org/title/Fsck_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Ссылки по теме\n\n- Ext4\n- Btrfs\n- fstab (Русский)\n\nfsck (file system check) — утилита для проверки и восстановления файловых систем Linux. Проверка файловых систем разных физических дисков выполняется параллельно, что позволяет значительно её ускорить (см. fsck(8)).\n\nПроцесс загрузки Arch включает в себя процедуру fsck, поэтому проверка файловых систем на всех носителях выполняется автоматически при каждой загрузке. По этой причине обычно нет необходимости выполнять её через командную строку.\n\n"
    },
    {
      "title": "Механизм",
      "level": 3,
      "content": "Существует два возможных варианта:\n\n1. mkinitcpio предоставляет хук fsck для проверки корневой файловой системы перед монтированием. Корневой раздел должен быть смонтирован на запись и чтение (параметр ядра rw) [1].\n1. systemd проверяет все файловые системы, которым задано значение fsck больше 0 (либо параметром fstab, либо в пользовательском файле юнита). Корневая файловая система изначально должна быть смонтирована только на чтение (параметр ядра ro), и лишь позже перемонтирована на чтение-запись в fstab. Имейте в виду, что опция монтирования defaults подразумевает rw.\n\nРекомендуется по умолчанию использовать первый вариант. Если вы устанавливали систему в соответствии с руководством, то использоваться будет именно он. Если вы хотите вместо этого использовать вариант 2, то удалите хук fsck из mkinitcpio.conf и задайте параметр ядра ro. Кроме того, параметром ядра fsck.mode=skip можно полностью отключить fsck для обоих вариантов.\n\n"
    },
    {
      "title": "Принудительная проверка",
      "level": 3,
      "content": "Если вы используете base-хук mkinitcpio, то можно принудительно выполнять fsck во время загрузки, задав параметр ядра fsck.mode=force. Проверена будет каждая файловая система на машине.\n\nВ качестве альтернативы можно воспользоваться службой systemd systemd-fsck@.service(8), которая проверит все настроенные файловые системы, которые не были проверены в initramfs. Тем не менее, проверка корневой файловой системы этим способом может стать причиной задержки в время загрузки, поскольку файловая система будет перемонтироваться.\n\n"
    },
    {
      "title": "Восстановление повреждённых блоков",
      "level": 3,
      "content": "Следующая команда позволяет восстановить повреждённые участки файловых систем ext2/ext3/ext4 и FAT:\n\n```\n# fsck -a\n```\n\n"
    },
    {
      "title": "Интерактивное восстановление повреждённых блоков",
      "level": 3,
      "content": "Полезно в том случае, если файлы на загрузочном разделе были изменены, а журнал не обновился соответствующим образом. В этом случае размонтируйте загрузочный раздел и выполните:\n\n```\n# fsck -r диск\n```\n\n"
    },
    {
      "title": "Изменение частоты проверки",
      "level": 3,
      "content": "По умолчанию fsck проверяет файловую систему каждые 30 загрузок (вычисляется отдельно для каждого раздела). Чтобы изменить частотку проверок, выполните:\n\n```\n# tune2fs -c 20 /dev/sda1\n```\n\nЗдесь 20 — число загрузок между проверками. Если задать значение 1, то проверка будет выполняться при каждой загрузке, а значение 0 отключит сканирование.\n\nТекущую частоту проверок и опции монтирования конкретного раздела можно узнать командой:\n\n```\n# dumpe2fs -h /dev/sda1 | grep -i 'mount count'\n```\n\n"
    },
    {
      "title": "Параметры fstab",
      "level": 3,
      "content": "fstab — файл системных настроек, который используется для передачи ядру Linux информации о том, какие разделы (файловые системы) монтировать и в какие точки дерева файловой системы.\n\nЗаписи в /etc/fstab выглядят примерно следующим образом.\n\n```\n/dev/sda1   /         ext4      defaults       0  1\n/dev/sda2   /other    ext4      defaults       0  2\n/dev/sda3   /win      ntfs-3g   defaults       0  0\n```\n\nШестое поле каждой строки (выделено) — опция fsck:\n\n- 0 — не проверять.\n- 1 — файловая система (раздел), которая должна быть проверена первой; для корневого раздела (/) должно использоваться именно это значение.\n- 2 — прочие файловые системы, которые должны быть проверены.\n\n"
    },
    {
      "title": "Не запускается fsck для отдельного раздела /usr",
      "level": 3,
      "content": "1. Убедитесь, что используются соответствующие хуки в /etc/mkinitcpio.conf, а также что вы не забыли пересоздать initramfs после последнего редактирования этого файла.\n1. Проверьте fstab! Только корневому разделу должен быть задан параметр 1 в последнем поле, все остальные разделы должны иметь либо 2, либо 0. Также проверьте файл на наличие иных опечаток.\n\n"
    },
    {
      "title": "ext2fs: no external journal",
      "level": 3,
      "content": "Иногда (например, из-за внезапного отключения питания) файловые системы ext(3/4) могут повредиться так сильно, что восстановить их обычным способом не удастся. Как правило, при этом fsck выводит сообщение о том, что не удалось найти журнал (no external journal). В этом случае выполните команды ниже.\n\nОтмонтируйте раздел от соответствующего каталога:\n\n```\n# umount каталог\n```\n\nЗапишите на раздел новый журнал:\n\n```\n# tune2fs -j /dev/раздел\n```\n\nЗапустите fsck, чтобы восстановить раздел:\n\n```\n# fsck -p /dev/раздел\n```\n\n"
    }
  ]
}