{
  "title": "Systemd (Русский)/Journal",
  "url": "https://wiki.archlinux.org/title/Systemd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)/Journal",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "systemd использует журнал (journal), собственную систему ведения логов, в связи с чем больше не требуется запускать отдельный демон логирования. Для чтения логов используйте команду journalctl(1).\n\nВ Arch Linux каталог /var/log/journal/ — это часть пакета systemd и по умолчанию (когда в конфигурационном файле /etc/systemd/journald.conf параметру Storage= задано значение auto) журнал записывается именно в /var/log/journal/. Если каталог будет удалён, systemd не пересоздаст его автоматически и вместо этого будет вести журнал в /run/systemd/journal без сохранения между перезагрузками. Однако каталог будет пересоздан, если добавить Storage=persistent в journald.conf и перезапустить systemd-journald.service (или перезагрузиться).\n\nСообщения в журнале классифицируются по уровню приоритета и категории (Facility). Классификация записей соответствует классическому протоколу Syslog (RFC 5424).\n\n"
    },
    {
      "title": "Уровни приоритета",
      "level": 2,
      "content": "Коды важности syslog (в systemd называются приоритетами) используются для пометки важности сообщений RFC 5424.\n\nTable content:\nЗначение | Важность | Ключевое слово | Описание | Примеры\n0 | Emergency | emerg | Cистема не работоспособна | Серьёзный баг в ядре, дамп памяти systemd.Данный уровень не должен использоваться приложениями.\n1 | Alert | alert | Cистема требует немедленного вмешательства | Отказ важной подсистемы. Потеря данных. kernel: BUG: unable to handle kernel paging request at ffffc90403238ffc.\n2 | Critical | crit | Cостояние системы критическое | Аварийные отказы, дампы памяти. Например, знакомое сообщение:systemd-coredump[25319]: Process 25310 (plugin-containe) of user 1000 dumped coreОтказ основных приложений системы, например, X11.\n3 | Error | err | Cообщения об ошибках | Сообщение о некритической ошибке:kernel: usb 1-3: 3:1: cannot get freq at ep 0x84,systemd[1]: Failed unmounting /var.,libvirtd[1720]: internal error: Failed to initialize a valid firewall backend\n4 | Warning | warning | Предупреждения о возможных проблемах | В некорневой файловой системе остался всего 1 ГБ свободного места.org.freedesktop. Notifications[1860]: (process:5999): Gtk-WARNING **: Locale not supported by C library. Using the fallback 'C' locale.\n5 | Notice | notice | Cообщения о нормальных, но важных событиях | systemd[1]: var.mount: Directory /var to mount over is not empty, mounting anyway,gcr-prompter[4997]: Gtk: GtkDialog mapped without a transient parent. This is discouraged\n6 | Informational | info | Информационные сообщения | lvm[585]: 7 logical volume(s) in volume group \"archvg\" now active\n7 | Debug | debug | Отладочные сообщения | kdeinit5[1900]: powerdevil: Scheduling inhibition from \":1.14\" \"firefox\" with cookie 13 and reason \"screen\"\n\nВышеуказанные правила являются рекомендацией и окончательное решение остаётся за разработчиком приложения. Всегда возможно, что сообщение будет выше или ниже ожидаемого уровня.\n\n"
    },
    {
      "title": "Категории",
      "level": 2,
      "content": "Коды категорий (facility) syslog используются для указания типа программы, добавляющего сообщение в лог RFC 5424.\n\nTable content:\nКод категории | Ключевое слово | Описание | Информация\n0 | kern | Сообщения ядра\n1 | user | Сообщения программного обеспечения пользователя\n2 | mail | Почтовая система | Архаический POSIX всё ещё поддерживается и иногда используется (см. mail(1) для получения более подробной информации)\n3 | daemon | Системные службы | Все демоны, включая systemd и его подсистемы\n4 | auth | Сообщения безопасности (авторизации) | См. также код 10\n5 | syslog | Собственные сообщения syslogd | Для реализаций syslogd (не используется в systemd, см. код 3)\n6 | lpr | Подсистема печати (архаическая подсистема)\n7 | news | Подсистема новостных групп (архаическая подсистема)\n8 | uucp | Подсистема UUCP (архаическая подсистема)\n9 |  | clock daemon | systemd-timesyncd\n10 | authpriv | Сообщения безопасности (авторизации) | См. также код 4\n11 | ftp | Служба FTP\n12 | - | Подсистема NTP\n13 | - | Журнал аудита\n14 | - | Аварийный журнал\n15 | cron | Служба планирования\n16 | local0 | Локальное использование 0 (local0)\n17 | local1 | Локальное использование 1 (local1)\n18 | local2 | Локальное использование 2 (local2)\n19 | local3 | Локальное использование 3 (local3)\n20 | local4 | Локальное использование 4 (local4)\n21 | local5 | Локальное использование 5 (local5)\n22 | local6 | Локальное использование 6 (local6)\n23 | local7 | Локальное использование 7 (local7)\n\nПолезные категории для наблюдения: 0, 1, 3, 4, 9, 10, 15.\n\n"
    },
    {
      "title": "Фильтрация вывода",
      "level": 2,
      "content": "journalctl позволяет фильтровать вывод по определённым полям. Если должно быть отображено большое количество сообщений или необходима фильтрация большого промежутка времени, то вывод команды может занять значительное время.\n\nПримеры:\n\n- Показать сообщения с момента текущей загрузки системы: # journalctl -b Также пользователи часто интересуются сообщениями предыдущей загрузки (например, если произошёл невосстановимый сбой системы). Это возможно, если задать параметр флагу -b: journalctl -b -0 покажет сообщения с момента текущей загрузки, journalctl -b -1 — предыдущей загрузки, journalctl -b -2 — следующей за предыдущей и т.д. Для просмотра полного описания смотрите страницу справочного руководства journalctl(1), поддерживается и более мощная семантика.\n- Добавить пояснения к сообщениям логов из каталога сообщений, где это возможно: # journalctl -x Обратите внимание, что эту возможность лучше не использовать, когда излишние комментарии нежелательны — например, при добавлении копии логов в сообщение о баге или письмо в поддержку. Вывести существующие пункты каталога можно командой journalctl --list-catalog.\n- Показать сообщения, начиная с определённой даты (и, опционально, времени): # journalctl --since=\"2012-10-30 18:17:16\"\n- Показать сообщения за последние 20 минут: # journalctl --since \"20 min ago\"\n- Следить за появлением новых сообщений: # journalctl -f\n- Показать сообщения конкретного исполняемого файла: # journalctl /usr/lib/systemd/systemd\n- Показать сообщения конкретного процесса: # journalctl _PID=1\n- Показать сообщения конкретного юнита: # journalctl -u man-db.service\n- Показать сообщения от пользовательской службы конкретного юнита: $ journalctl --user -u dbus\n- Показать кольцевой буфер ядра: # journalctl -k\n- Показать сообщения только с приоритетами error, critical и alert: # journalctl -p err..alert Также можно использовать числа, например, journalctl -p 3..1. Если указать одно число/уровень приоритета, например, journalctl -p 3, то также будут показаны сообщения и с более высоким приоритетом (от 0 до 3, в данном случае).\n- Показать эквивалент auth.log используя фильтрацию категорий syslog: # journalctl SYSLOG_FACILITY=10\n- Если в каталоге с журналами (по умолчанию /var/log/journal) очень много данных, то фильтрация вывода journalctl может занять несколько минут. Процесс можно значительно ускорить с помощью опции --file, указав journalctl только самый свежий журнал: # journalctl --file /var/log/journal/*/system.journal -f\n\n```\n# journalctl -b\n```\n\n```\n# journalctl -x\n```\n\n```\n# journalctl --since=\"2012-10-30 18:17:16\"\n```\n\n```\n# journalctl --since \"20 min ago\"\n```\n\n```\n# journalctl -f\n```\n\n```\n# journalctl /usr/lib/systemd/systemd\n```\n\n```\n# journalctl _PID=1\n```\n\n```\n# journalctl -u man-db.service\n```\n\n```\n$ journalctl --user -u dbus\n```\n\n```\n# journalctl -k\n```\n\n```\n# journalctl -p err..alert\n```\n\n```\n# journalctl SYSLOG_FACILITY=10\n```\n\n```\n# journalctl --file /var/log/journal/*/system.journal -f\n```\n\nДля получения дополнительной информации смотрите страницы справочного руководства journalctl(1), systemd.journal-fields(7) или пост в блоге Леннарта Пёттеринга.\n\nNote: Если убрать опцию S, будет достигнут требуемый результат. Например, запустите journalctl, как показано здесь:\n\nЕсли убрать опцию S, будет достигнут требуемый результат. Например, запустите journalctl, как показано здесь:\n\n```\n$ SYSTEMD_LESS=FRXMK journalctl\n```\n\n```\n$ strings /mnt/arch/var/log/journal/af4967d77fba44c6b093d0e9862f6ddd/system.journal | grep -i message\n```\n\n"
    },
    {
      "title": "Ограничение размера журнала",
      "level": 2,
      "content": "Если журнал сохраняется при перезагрузке, его размер по умолчанию ограничен значением в 10% от объема соответствующей файловой системы (и максимально может достигать 4 ГиБ). Например, для каталога /var/log/journal, расположенном на корневом разделе в 20 ГиБ, максимальный размер журналируемых данных составит 2 ГиБ. На разделе же 50 ГиБ журнал сможет занять до 4 ГиБ. Текущие пределы для вашей системы можно узнать из логов systemd-journald:\n\n```\n# journalctl -b -u systemd-journald\n```\n\nМаксимальный объем постоянного журнала можно задать вручную, раскомментировав и отредактировав следующий параметр:\n\n```\n/etc/systemd/journald.conf\n```\n\n```\nSystemMaxUse=50M\n```\n\nТакже возможно использование конфигурационных сниппетов вместо редактирования глобального файла конфигурации. В таком случае поместите переопределения в разделе [Journal]:\n\n```\n/etc/systemd/journald.conf.d/00-journal-size.conf\n```\n\n```\n[Journal]\nSystemMaxUse=50M\n```\n\nПерезапустите systemd-journald.service для применения изменений.\n\nДля получения дополнительной информации обратитесь к странице справочного руководства journald.conf(5).\n\n"
    },
    {
      "title": "Ограничение размера для юнита",
      "level": 3,
      "content": "Отредактируйте файл юнита службы, которую вы хотите настроить (например, sshd), добавив параметр LogNamespace=ssh в раздел [Service].\n\nЗатем создайте файл journald@ssh.conf, скопировав содержимое файла /etc/systemd/journald.conf. Отредактируйте его, задав необходимое значение SystemMaxUse.\n\nПерезапустите юнит, чтобы включилась новая служба журнала systemd-journald@ssh.service. Логи службы из определённого \"пространства имён\" можно увидеть командой journalctl --namespace ssh.\n\nПодробнее о пространствах имён журнала см. systemd-journald.service(8) § JOURNAL NAMESPACES.\n\n"
    },
    {
      "title": "Очистка файлов журнала вручную",
      "level": 2,
      "content": "Файлы журнала можно удалить из директории /var/log/journal/, к примеру, с помощью rm или journalctl для удаления части журналов по определённым критериям. Например:\n\n- Удалять заархивированные файлы журнала, пока занимаемое ими место не составит менее 100 МиБ: # journalctl --vacuum-size=100M\n- Ограничить все файлы журнала хранением данных только за последние две недели: # journalctl --vacuum-time=2weeks\n\n```\n# journalctl --vacuum-size=100M\n```\n\n```\n# journalctl --vacuum-time=2weeks\n```\n\nДля получения дополнительной информации, обратитесь к journalctl(1).\n\n"
    },
    {
      "title": "Journald вместе с syslog",
      "level": 2,
      "content": "Совместимость с классической реализацией syslog можно обеспечить, перенаправляя все сообщения systemd через сокет /run/systemd/journal/syslog. Для работы демона syslog с журналом, следует привязать его к данному сокету вместо /dev/log (официальное сообщение).\n\nДля перенаправления данных в сокет, в journald.conf по умолчанию задан параметр ForwardToSyslog=no, чтобы избежать перегрузки на систему, так как rsyslog или syslog-ng самостоятельно получают сообщения из журнала.\n\nСмотрите Syslog-ng#Overview и Syslog-ng#syslog-ng and systemd journal или rsyslog для получения подробной информации о конфигурировании.\n\n"
    },
    {
      "title": "Перенаправление журнала в /dev/tty12",
      "level": 2,
      "content": "Создайте drop-in каталог /etc/systemd/journald.conf.d и файл fw-tty12.conf в нём со следующим содержимым:\n\n```\n/etc/systemd/journald.conf.d/fw-tty12.conf\n```\n\n```\n[Journal]\nForwardToConsole=yes\nTTYPath=/dev/tty12\nMaxLevelConsole=info\n```\n\nЗатем перезапустите службу systemd-journald.\n\n"
    },
    {
      "title": "Выбор журнала для просмотра",
      "level": 2,
      "content": "Иногда необходимо проверить логи другой системы, например, загружаясь с работоспособной системы для восстановления неисправной. В таком случае примонтируйте диск, к примеру, в /mnt и укажите путь журнала с помощью флага -D/--directory следующим образом:\n\n```\n# journalctl -D /mnt/var/log/journal -e\n```\n\n"
    },
    {
      "title": "Доступ к журналу как пользователь",
      "level": 2,
      "content": "По умолчанию обычные пользователи могут читать только свой собственный пользовательский журнал. Чтобы дать доступ на чтение системного журнала обычному пользователю, добавьте его в группу systemd-journal. Для групп adm и wheel также предоставляется доступ на чтение.\n\nПодробнее смотрите journalctl(1) § DESCRIPTION и Пользователи и группы#Пользовательские группы.\n\n"
    }
  ]
}