{
  "title": "Nouveau (日本語)",
  "url": "https://wiki.archlinux.org/title/Nouveau_(%E6%97%A5%E6%9C%AC%E8%AA%9E)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "関連記事\n\n- NVIDIA\n- Xorg\n- Bumblebee\n\nこの記事では、NVIDIA カード向けのリバースエンジニアリングされたオープンソースドライバー Nouveau のインストールと設定を説明しています。上流のプロプライエタリな nvidia ドライバ及びオープンソースな nvidia-open ドライバについては、NVIDIA を参照してください。\n\n使用中のカードのコードネームを見つけてください(より詳細なリストは Wikipedia にあります)。サポートされている機能の機能表と比較してください。\n\n"
    },
    {
      "title": "目次",
      "level": 2,
      "content": "- 1 インストール 1.1 Mesa NVK Vulkan Driver を使う\n- 2 ロード 2.1 早期 KMS\n- 3 ヒントとテクニック 3.1 NVIDIA ドライバーをインストールしたままにしておく 3.2 最新の開発パッケージをインストールする 3.3 デュアルディスプレイ 3.4 コンソールの解像度を設定する 3.5 電源管理 3.5.1 ファンの制御 3.6 Optimus 3.7 垂直同期\n- 4 トラブルシューティング 4.1 MSI の無効化 4.2 間違った出力端子が検出される問題 4.2.1 カーネルパラメータ 4.2.2 Xorg の設定 4.2.3 Xrandr 4.3 カーネルのエラーメッセージを吐いてランダムにフリーズする 4.4 Flat Panel Table Invalid\n\n- 1.1 Mesa NVK Vulkan Driver を使う\n\n- 2.1 早期 KMS\n\n- 3.1 NVIDIA ドライバーをインストールしたままにしておく\n- 3.2 最新の開発パッケージをインストールする\n- 3.3 デュアルディスプレイ\n- 3.4 コンソールの解像度を設定する\n- 3.5 電源管理 3.5.1 ファンの制御\n- 3.6 Optimus\n- 3.7 垂直同期\n\n- 3.5.1 ファンの制御\n\n- 4.1 MSI の無効化\n- 4.2 間違った出力端子が検出される問題 4.2.1 カーネルパラメータ 4.2.2 Xorg の設定 4.2.3 Xrandr\n- 4.3 カーネルのエラーメッセージを吐いてランダムにフリーズする\n- 4.4 Flat Panel Table Invalid\n\n- 4.2.1 カーネルパラメータ\n- 4.2.2 Xorg の設定\n- 4.2.3 Xrandr\n\n"
    },
    {
      "title": "インストール",
      "level": 2,
      "content": "mesa パッケージをインストールしてください。これは 3D アクセラレーションのための DRI ドライバを提供します。\n\n- 32ビットアクセラレーションサポートが必要な場合は、multilib リポジトリから lib32-mesa パッケージもインストールしてください。\n- (Xorg で 2D アクセラレーションを提供する) DDX ドライバが必要な場合、xf86-video-nouveau パッケージをインストールしてください。\n\nハードウェアビデオアクセラレーション も参照してください。\n\n"
    },
    {
      "title": "Mesa NVK Vulkan Driver を使う",
      "level": 3,
      "content": "NVK を使用するには、カーネルのバージョンが 6.7 以上であり、バージョン 24.1 以上の mesa をインストールしておく必要があります。\n\nNVK を有効化する前に、以下のパッケージ (及びこれらの lib32 版と DKMS 版) を全てアンインストールする必要があります:\n\n- nvidia、nvidia-open、nvidia-lts、nvidia-betaAUR\n- nvidia-settings、nvidia-utils\n- egl-wayland\n\nハイブリッドグラフィックのノート PC やデュアル GPU のシステムでは、/etc/modprobe.d の設定で Nouveau が GPU マネージャによってブラックリスト化されていないことを確認してください。\n\n次に、vulkan-nouveau (必要であれば lib32-vulkan-nouveau も) をインストールしてください。\n\n必要であればカーネルパラメータに nouveau.config=NvGspRm=1 を追加してください。Ada Lovelace 及びそれより新しいカードにおいてはデフォルトでこのオプションが有効化されています。FreeDeskTop.org のノートを参照してください。\n\n最後に、システムを再起動してください。\n\n正しく動作していることを確認するには、vulkan-tools パッケージの vulkaninfo を使うことができます。システムの NVIDIA GPU が NVK ドライバを使用していると報告するはずです。\n\n```\n$ vulkaninfo\n```\n\n```\n...\nGPU id : 0 (NVIDIA GeForce RTX 3050 Ti Laptop GPU (NVK GA107)):\n       Surface type = VK_KHR_wayland_surface\n       Formats: count = 8\n...\n```\n\n"
    },
    {
      "title": "ロード",
      "level": 2,
      "content": "システムの起動時に Nouveau のカーネルモジュールは自動的にロードされるはずです。ロードされない場合は:\n\n- カーネルパラメータに nomodeset や vga= を設定していないことを確認してください。Nouveau はカーネルモードセッティングを要求します。\n- また、/etc/modprobe.d/ や /usr/lib/modprobe.d/ の中で modprobe のブラックリストによって Nouveau が無効になっていないことを確認してください。\n- 上記全てを確認しても nouveau がロードされない場合は dmesg で opcode エラーが起こってないか確認してください。nouveau.config=NvBios=PRAMIN をカーネルパラメータに追加することでモジュールのアンロードを防ぐことができます [1]。\n- /etc/X11/xorg.conf ファイルまたは /etc/X11/xorg.conf.d/ 内の任意のファイルが存在し、nvidia ドライバを参照しているかどうかを確認してください。おそらく、このファイルの名前を変更したほうが良いでしょう。\n\n"
    },
    {
      "title": "早期 KMS",
      "level": 3,
      "content": "カーネルモード設定 (KMS; Kernel Mode Setting) は、nouveau ドライバによってサポートされており、mkinitcpio v32 からブートの早期段階で有効化されるようになっています (このバージョンからデフォルトで kms フックが含まれています)。他の環境で KMS をブートプロセスの可能な限り早い段階で有効化する方法については、カーネルモード設定#KMS の早期開始 を参照してください。\n\n"
    },
    {
      "title": "NVIDIA ドライバーをインストールしたままにしておく",
      "level": 3,
      "content": "Table content:\nこの記事またはセクションの正確性には問題があります。 理由: /usr/lib/ 内のファイルを編集しても、パッケージのアップグレード時に上書きされてしまいます。 (議論: トーク:Nouveau#)\n\nプロプライエタリの NVIDIA ドライバーをインストールしたままにしておきたいが、Nouveau ドライバーも使いたい(そして OpenGL を使用していない)場合、以下の手順に従ってください:\n\n/etc/modprobe.d/nouveau_blacklist.conf または /usr/lib/modprobe.d/nvidia-utils.conf 内の nouveau のブラックリストを以下のようにコメントアウトしてください:\n\n```\n#blacklist nouveau\n```\n\n他の設定ファイルにおいても、プロプライエタリなドライバを優先させるような行をコメントアウトしておく必要がある場合があります。例としては、systemd-modules-load の /usr/lib/modules-load.d/nvidia-utils.conf と Udev の /usr/lib/udev/rules.d/60-nvidia.rules です。以下のコマンドで、ドライバのどのファイルがインストールされているかを確認してください:\n\n```\n# pacman -Ql nvidia-utils | grep conf\n```\n\nそして、nvidia- という接頭辞が付くサービスを無効化していることを確認してください。そのようなサービスはブート時に nvidia-modprobe を呼び出して NVIDIA のカーネルモジュールをロードするかもしれません。例えば:\n\n```\n$ systemctl status nvidia-persistenced.service\n```\n\nXorg を使用する場合は、以下の内容で /etc/X11/xorg.conf.d/20-nouveau.conf ファイルを作成して Xorg に NVIDIA の代わりに nouveau をロードするよう指定してください:\n\n```\nSection \"Device\"\n    Identifier \"Nvidia card\"\n    Driver \"nouveau\"\nEndSection\n```\n\n再起動して変更を反映させてください。そしてカーネルメッセージを見て正しくロードされていることを確認してください:\n\n```\n# dmesg\n```\n\n"
    },
    {
      "title": "最新の開発パッケージをインストールする",
      "level": 3,
      "content": "最新の Nouveau の改善を得るには:\n\n- linux-gitAUR\n- libdrm-gitAUR\n- lib32-libdrm-gitAUR\n- lib32-mesa-gitAUR\n- mesa-gitAUR\n- xf86-video-nouveau-gitAUR\n\n"
    },
    {
      "title": "デュアルディスプレイ",
      "level": 3,
      "content": "RandR を使用してマルチモニタのセットアップする方法は マルチディスプレイ#RandR を見てください。\n\n"
    },
    {
      "title": "コンソールの解像度を設定する",
      "level": 3,
      "content": "video= カーネルラインオプションを使うことで nouveau に解像度を渡すことができます(カーネルモード設定 を参照してください)。\n\n"
    },
    {
      "title": "電源管理",
      "level": 3,
      "content": "nouveau ドライバーには正しい電源管理機能が実装されていないため、グラフィックカードの周波数は低い状態でロックされてパフォーマンスが思うほど出ない場合があります。カードによっては GPU のオーバークロックが実験的にサポートされています (Nouveau の電源管理についてのページ を見てください)。カーネル 4.5 から /sys/kernel/debug/dri/*/pstate の debugfs インターフェイスを使って制御できるようになっています。\n\n例えば、システム上の1番目のカードで利用可能な電源状態と現在の設定を確認するには、以下を実行してください:\n\n```\n# cat /sys/kernel/debug/dri/0/pstate\n```\n\nインターフェイスに書き込むことで特定の電源状態を手動で設定/強制することもできます:\n\n```\n# echo pstate > /sys/kernel/debug/dri/0/pstate\n```\n\n"
    },
    {
      "title": "ファンの制御",
      "level": 4,
      "content": "カードで実装されていれば、/sys を使ってファンの制御を設定できます:\n\n```\n$ find /sys -name pwm1_enable\n/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/hwmon/hwmon1/pwm1_enable\n$ readlink /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/driver\n../../../../bus/pci/drivers/nouveau\n```\n\npwm1_enable は 0, 1, 2 に設定できます。それぞれ NONE, MANUAL, AUTO を意味します。ファン制御を手動で設定する場合、pwm1 を設定する必要があります。例えば 40 にすれば速度が 40% になります。\n\nudev ルールを使って設定することもできます:\n\n```\n$ cat /etc/udev/rules.d/50-nouveau-hwmon.rules\nACTION==\"add\", SUBSYSTEM==\"hwmon\", DRIVERS==\"nouveau\", ATTR{pwm1_enable}=\"2\"\n```\n\nソース:\n\n- https://floppym.blogspot.de/2013/07/fan-control-with-nouveau.html\n- https://web.archive.org/web/20141031191559/https://kalgan.cc/blog/posts/Controlling_nVidia_cards_fans_with_nouveau_in_Debian/\n\n"
    },
    {
      "title": "Optimus",
      "level": 3,
      "content": "ラップトップで Optimus (ラップトップに2つの GPU を載せている場合はハイブリッドグラフィック) を使う方法は2つあります: bumblebee と PRIME\n\n"
    },
    {
      "title": "垂直同期",
      "level": 3,
      "content": "Xorg コンポジタは Nouveau で問題が起きやすくなっています。他のコンポジタと異なり、Picom はちらつきを起こさないようにするためのオプションが多数存在します。上手く動作する設定例:\n\n```\n$ picom -b --unredir-if-possible --backend xr_glx_hybrid --vsync --use-damage --glx-no-stencil\n```\n\n"
    },
    {
      "title": "トラブルシューティング",
      "level": 2,
      "content": "drm.debug=14 や log_buf_len=16M をカーネルパラメータに追加してビデオデバッグを有効にしてください。\n\nXorg の詳細ログを作成する:\n\n```\n$ startx -- -logverbose 9 -verbose 9\n```\n\nロードされているビデオモジュールのパラメータと値を見る:\n\n```\n$ modinfo -p video\n```\n\n"
    },
    {
      "title": "MSI の無効化",
      "level": 3,
      "content": "モジュールがロードされなかったり X サーバーが起動しない場合、カーネルパラメータに nouveau.config=NvMSI=0 を追加してみてください。\n\nソース: https://bugs.freedesktop.org/show_bug.cgi?id=78441\n\n"
    },
    {
      "title": "間違った出力端子が検出される問題",
      "level": 3,
      "content": "nouveau ドライバーでは\"幻影\"の出力端子が検出されることがあります。例えば、LVDS-1 しか存在しないのに VGA-1 と LVDS-1 が接続されていると表示されることがあります。\n\nディスプレイに影響して画面が崩れたり、ノートパソコンで蓋を閉じた時にスリープされない問題が生じます。\n\n"
    },
    {
      "title": "カーネルパラメータ",
      "level": 4,
      "content": "ブートローダーのカーネルパラメータで問題の出力端子 (以下の例では VGA-1) を無効化することで解決できます。以下のように追加してください:\n\n```\nvideo=VGA-1:d\n```\n\nd = disable です。\n\nnouveau カーネルモジュールには TV 出力の検知を無効化するオプションがあります[2]:\n\n```\ntv_disable = 1\n```\n\n"
    },
    {
      "title": "Xorg の設定",
      "level": 4,
      "content": "/etc/X11/xorg.conf.d/20-nouveau.conf に以下を追加することで Xorg で幻影の出力端子を無効化することもできます:\n\n```\nSection \"Monitor\"\nIdentifier \"VGA-1\"\nOption \"Ignore\" \"1\"\nEndSection\n```\n\nソース: https://web.archive.org/web/20170118202740/http://gentoo-en.vfose.ru/wiki/Nouveau#Phantom_and_unpopulated_output_connector_issues\n\n"
    },
    {
      "title": "Xrandr",
      "level": 4,
      "content": "Xrandr で出力端子を無効化することができます:\n\n```\n$ xrandr --output VGA-1 --off\n```\n\nこの設定を xinit に記述することもできます。\n\n"
    },
    {
      "title": "カーネルのエラーメッセージを吐いてランダムにフリーズする",
      "level": 3,
      "content": "特定の Nvidia チップを Nouveau で使用するとシステムがランダムにフリーズして大量のカーネルメッセージを吐くことがあります。メッセージは dmesg で確認できます。その場合、nouveau.noaccel=1 カーネルパラメータを追加してみてください。詳しくは Fedora:Common kernel problems#Systems with nVidia adapters using the nouveau driver lock up randomly を参照。\n\n注意点として、nouveau.noaccel=1 カーネルパラメータを使用すると、iGPU が存在しない場合や、iGPU が工場出荷時に無効化されている場合に、Wayland で CPU 使用率がほぼ 100% になるかもしれません。この場合、X11 セッションに切り替えるか、LIBGL_ALWAYS_SOFTWARE=1 環境変数を設定して Wayland の OpenGL ハードウェアアクセラレーションを完全に無効化することができます。\n\nQT_XCB_FORCE_SOFTWARE_OPENGL=1 環境変数を使って Qt アプリケーションの OpenGL アクセラレーションを無効化するという方法もあります。\n\n"
    },
    {
      "title": "Flat Panel Table Invalid",
      "level": 3,
      "content": "最新のチップセットを使用する NVIDIA グラフィックカードは起動時に問題を起こすことがあります。例えば X11 が起動しなかったり lspci が永遠にフリーズします [3][4][5][6][7]。\n\nライブディストリビューションやインストールメディアが壊れることもあります。問題は lspci を実行するか systemd のジャーナルをチェックすることで確認できます:\n\n```\nnouveau E[     DRM]Pointer to flat panel table invalid\n```\n\n以下のカーネルパラメータを使って Nouveau ドライバーを無効化することで起動するようになるかもしれません:\n\n```\nmodprobe.blacklist=nouveau\n```\n\n起動したら以下のコマンドで Nouveau ドライバーをロードしてください:\n\n```\nmodprobe nouveau\n```\n\nこれでシステムが正しく動作するはずです。 他の Nvidia グラフィックカードを持っていて、念の為に問題のカードを無効化したい場合:\n\n```\n$ echo 1 > /sys/bus/pci/devices/[card device id]/remove\n```\n\n"
    }
  ]
}