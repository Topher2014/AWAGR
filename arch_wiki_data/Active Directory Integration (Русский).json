{
  "title": "Active Directory Integration (Русский)",
  "url": "https://wiki.archlinux.org/title/Active_Directory_Integration_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Ссылки по теме\n\n- Samba (Русский)\n- Samba/Контроллер домена Active Directory\n- SOGo\n\nОсновной задачей системных администраторов являются попытки совместного изпользования разнообразных окружений. Мы имеем в виду смешивание разных серверных операционных систем (Обычно Microsoft Windows & Unix/Linux). Управление пользователями и аутентификацией на данный момент является наиболее сложной задачей. Популярнейший способ решения это задачи - Directory Server. Существует много открытых и коммерческих решений для разный типов *NIX; однако, только немногие решают проблему взаимодействия с Windows. Активный Каталог (AD) - служба каталогов созданная Microsoft для доменных сетей Windows. Он входит в большинство операционных систем Windows Server. Сервера,на которых запущен AD, называются контроллерами доменов(domain controllers)\n\nАктивный каталог используется как главное средство администрирования сети и безопасности.Он отвечает за аутентификацию и авторизацию все пользователей и компьютеров в доменной сети Windows, назначая и следя за правилами безопасности для всех компьютеров в сети, также устанавливая и обновляя ПО на компьютерах в этой сети. Например,когда пользователь авторизуется в компьютер,который является частью доменной сети, AD проверяет его пароль и яляется он обычным пользователем или же системным администратором.\n\nАктивный католог использует Lightweight Directory Access Protocol (LDAP) версий 2 и 3, Kerberos и DNS. Эти же стандарты доступны в Linux, но их комбинирование - непростая задача. Эта статья поможет вам настроить хост Arch Linux для аутентификация в домене AD.\n\nЭта статья объясняет, как интегрировать хост Arch Linux в сущестующий домен AD. Перед продолжением у вас должен быть существующий домен AD, и пользователь с правами на добавление пользователей и компьютерных аккаунтов. Эта сатья не предназначена ни как полное описание AD,ни как полно описание работы с Samba. Обратитесь к разделу ресурсов для дополнительной информации.\n\n"
    },
    {
      "title": "Терминология",
      "level": 2,
      "content": "Если вы не знакомы с AD, здесь приведены некоторые ключевые слова, которые будет полезно знать.\n\n- Домен(Domain) : Имя,используемое для группы компьютеров и аккаунтов.\n- SID : Каждый компьютер,присоединяющийся к сети должен иметь уникальный SID / Системный идентификатор.\n- SMB : Блок сообщения сервера.\n- NETBIOS: Network naming protocol used as an alternative to DNS. Mostly legacy, but still used in Windows Networking.\n- WINS: Windows Information Naming Service. Used for resolving Netbios names to windows hosts.\n- Winbind: Protocol for windows authentication. Протокол для авторизации windows.\n\n"
    },
    {
      "title": "Обновление GPO",
      "level": 4,
      "content": "Возможно, нужно будет отключить Digital Sign Communication (Always) в настройках групп AD. А именно:\n\nЕсли вы используете Windows Server 2008 R2, то вам нужно настроить GPO в GPO for Default Domain Controller Policy -> Computer Setting -> Policies -> Windows Setting -> Security Setting -> Local Policies -> Security Option -> Microsoft network client: Digitally sign communications (always)\n\n"
    },
    {
      "title": "Настройка Linux хоста",
      "level": 3,
      "content": "Следующие несколько шагов - начало конфигурации хоста. Вам понадобиться root или sudo доступ.\n\n"
    },
    {
      "title": "Установка",
      "level": 3,
      "content": "Установите следующие пакеты:\n\n- samba, см. Samba\n- pam-krb5\n- ntp или openntpd, см. также NTPd или OpenNTPD\n\n"
    },
    {
      "title": "Обновление DNS",
      "level": 3,
      "content": "AD сильно зависит от DNS. Вам нужно будет обновить /etc/resolv.conf, чтобы использовать контроллеры доменов AD:\n\n```\n/etc/resolv.conf\n```\n\n```\nnameserver <IP1>\nnameserver <IP2>\n```\n\nЗамените <IP1> и <IP2> IP адресами для сервера AD.Есили ваши AD домены не позволяют использовать DNS форвардинг или рекурсию,возможно,придётся добавить некоторые вещи. Если ваша машина имеет дуалбут Windows и Linux, стоит использовать разные имена DNS и netbios для linux,если обе операционные системы будут членами одного домена.\n\n"
    },
    {
      "title": "Настройка NTP",
      "level": 3,
      "content": "См. NTPd или OpenNTPD для инструкции по настройке NTP. Стоит отметить, что OpenNTPD больше не поддерживается.\n\nПри настройке используйте IP адреса серверов AD.Как альтернативу можно использовать другие NTP сервера,которые обеспечат синхронизацию AD в то же место.Тем не менее,AD обычно запускают NTP в качестве службы.\n\nУбедитесь,что демон настроен на sync automatically on startup.\n\n"
    },
    {
      "title": "Kerberos",
      "level": 3,
      "content": "Допустим,что ваша AD называется example.com. Далее допустим что ваша AD управляется двумя доменными контроллерами, главным и вторичным, которые называются PDC и BDS, pdc.example.com и bdc.example.com соответственно. Их адреса будут,например, 192.168.1.2 и 192.168.1.3. Следите за написанием,верхний регистр очень важен.\n\n```\n/etc/krb5.conf\n```\n\n```\n[libdefaults]\n        default_realm \t= \tEXAMPLE.COM\n\tclockskew \t= \t300\n\tticket_lifetime\t=\t1d\n        forwardable     =       true\n        proxiable       =       true\n        dns_lookup_realm =      true\n        dns_lookup_kdc  =       true\n\t\n[realms]\n\tEXAMPLE.COM = {\n\t\tkdc \t= \tPDC.EXAMPLE.COM\n                admin_server = PDC.EXAMPLE.COM\n\t\tdefault_domain = EXAMPLE.COM\n\t}\n\t\n[domain_realm]\n        .kerberos.server = EXAMPLE.COM\n\t.example.com = EXAMPLE.COM\n\texample.com = EXAMPLE.COM\n\texample\t= EXAMPLE.COM\n\n[appdefaults]\n\tpam = {\n\tticket_lifetime \t= 1d\n\trenew_lifetime \t\t= 1d\n\tforwardable \t\t= true\n\tproxiable \t\t= false\n\tretain_after_close \t= false\n\tminimum_uid \t\t= 0\n\tdebug \t\t\t= false\n\t}\n\n[logging]\n\tdefault \t\t= FILE:/var/log/krb5libs.log\n\tkdc \t\t\t= FILE:/var/log/kdc.log\n        admin_server            = FILE:/var/log/kadmind.log\n```\n\n```\nallow_weak_crypto = true\n```\n\n"
    },
    {
      "title": "Создание ключа Kerberos",
      "level": 4,
      "content": "Теперь во можете запросить ключи для AD (верхний регистр необходим):\n\n```\nkinit administrator@EXAMPLE.COM\n```\n\nМожно использовать любое имя пользователя,у которого есть права администратора домена.\n\n"
    },
    {
      "title": "Подтверждение ключа",
      "level": 4,
      "content": "Запустите klist чтобы проверить,получили ли вы токен,должно быть нечто подобное:\n\n```\n# klist\n```\n\n```\nTicket cache: FILE:/tmp/krb5cc_0\n Default principal: administrator@EXAMPLE.COM\n \n Valid starting    Expires           Service principal \n 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM\n         renew until 02/05/12 21:27:47\n```\n\n"
    },
    {
      "title": "pam_winbind.conf",
      "level": 3,
      "content": "Если вы получаете ошибки \"/etc/security/pam_winbind.conf не найден\",создайте этот файл и отредактируйте его следующим образом:\n\n```\n/etc/security/pam_winbind.conf\n```\n\n```\ndebug=no\ndebug_state=no\ntry_first_pass=yes\nkrb5_auth=yes\nkrb5_cache_type=FILE\ncached_login=yes\nsilent=no\nmkhomedir=yes\n```\n\n"
    },
    {
      "title": "Samba",
      "level": 3,
      "content": "Samba — бесплатная реализация протокола SMB/CIFS. Также она включает инструменты для Linux машин,которые заставляют их вести себя будто Windows сервера и клиенты.\n\nВ этом разделе мы сначала сфокусируемся на работе аутентификации с помощью изменения секции 'Global'. Далее, мы вернёмся к остальным.\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[Global]\n  netbios name = MYARCHLINUX\n  workgroup = EXAMPLE\n  realm = EXAMPLE.COM\n  server string = %h Arch Linux Host\n  security = ads\n  encrypt passwords = yes\n  password server = pdc.example.com\n\n  idmap config * : backend = rid\n  idmap config * : range = 10000-20000\n\n  winbind use default domain = Yes\n  winbind enum users = Yes\n  winbind enum groups = Yes\n  winbind nested groups = Yes\n  winbind separator = +\n  winbind refresh tickets = yes\n\n  template shell = /bin/bash\n  template homedir = /home/%D/%U\n   \n  preferred master = no\n  dns proxy = no\n  wins server = pdc.example.com\n  wins proxy = no\n\n  inherit acls = Yes\n  map acl inherit = Yes\n  acl group control = yes\n\n  load printers = no\n  debug level = 3\n  use sendfile = no\n```\n\nТеперь надо \"объяснить\" Samba, что мы будет использовать базы даннх PDC для аутенификации.Будем использовать winbindd, который входит в поставку Samba.Winbind указывает UID и GID Linux машины для AD. Winbind использует UNIX реализацию RPC вызовов, Pluggable Authentication Modules (aka PAM) и Name Service Switch (NSS), чтобы разрешить допуск пользователей и Windows AD на Linux-машинах. Лучшая часть winbindd то,что вам не нужно размечать самому, от вас требуется только указать диапазон UID и GID! Именно их мы объявили в smb.conf.\n\nОбновите файл настроек samba чтобы включить демона winbind\n\n```\n/etc/conf.d/samba\n```\n\n```\n##### /etc/conf.d/samba #####\n #SAMBA_DAEMONS=(smbd nmbd)\n SAMBA_DAEMONS=(smbd nmbd winbindd)\n```\n\nДалее, настройте samba так, для запуска вместе со стартом системы. См. Daemons для подробностей.\n\n"
    },
    {
      "title": "Запуск Samba",
      "level": 3,
      "content": "Надеемся,вы ещё не перезагрузились! Хорошо. Если у вас запущена X-сессия - выходите из неё,чтобы проверить вход в другой терминал не выходя из своей сессии.\n\nЗапуск Samba (включая smbd, nmbd и winbindd):\n\nЕсли вы проверите список процессов,то заметите,что на самом деле winbind не запустился. Быстрый осмотр логов говорит,что SID для этого хоста может быть получен от домена:\n\n```\n# tail /var/log/samba/log.winbindd\n```\n\n```\n[2012/02/05 21:51:30.085574,  0] winbindd/winbindd_cache.c:3147(initialize_winbindd_cache)\n  initialize_winbindd_cache: clearing cache and re-creating with version number 2\n[2012/02/05 21:51:30.086137,  2] winbindd/winbindd_util.c:233(add_trusted_domain)\n  Added domain BUILTIN  S-1-5-32\n[2012/02/05 21:51:30.086223,  2] winbindd/winbindd_util.c:233(add_trusted_domain)\n  Added domain MYARCHLINUX  S-1-5-21-3777857242-3272519233-2385508432\n[2012/02/05 21:51:30.086254,  0] winbindd/winbindd_util.c:635(init_domain_list)\n  Could not fetch our SID - did we join?\n[2012/02/05 21:51:30.086408,  0] winbindd/winbindd.c:1105(winbindd_register_handlers)\n  unable to initialize domain list\n```\n\n"
    },
    {
      "title": "Присоединение к Домену",
      "level": 3,
      "content": "Вам нужен аккаунт администратора AD чтобы сделать это. Пусть наш логин: Administrator. Комана - 'net ads join'\n\n```\n# net ads join -U Administrator\n```\n\n```\nAdministrator's password: xxx\nUsing short domain name -- EXAMPLE\nJoined 'MYARCHLINUX' to realm 'EXAMPLE.COM'\n```\n\n"
    },
    {
      "title": "Перезапуск Samba",
      "level": 3,
      "content": "winbindd не смог запуститься потому,что пока что мы не домен.\n\nПерезапустите сервис Samba и winbind тоже должен запуститься.\n\nNSSwitch говорит Linux хосту как получить игформацию из различных источников и к каком порядке это сделать. В нашем случае мы добаим AD как дополнительный источник для пользователей, групп и хостов.\n\n```\n/etc/nsswitch.conf\n```\n\n```\npasswd:            files winbind\n shadow:            files winbind\n group:             files winbind \n \n hosts:             files dns wins\n```\n\n"
    },
    {
      "title": "Проверка Winbind",
      "level": 3,
      "content": "Проверим, может ли winbind получить доступ к AD. Следующие команды возвращают список пользователей AD:\n\n```\n# wbinfo -u\n```\n\n```\nadministrator\nguest\nkrbtgt\ntest.user\n```\n\n- Note мы создали пользователя AD 'test.user' в домменом контоллере.\n\nМожно сделать то же самое для групп AD:\n\n```\n# wbinfo -g\n```\n\n```\ndomain computers\ndomain controllers\nschema admins\nenterprise admins\ncert publishers\ndomain admins\ndomain users\ndomain guests\ngroup policy creator owners\nras and ias servers\nallowed rodc password replication group\ndenied rodc password replication group\nread-only domain controllers\nenterprise read-only domain controllers\ndnsadmins\ndnsupdateproxy\n```\n\n"
    },
    {
      "title": "Проверка nsswitch",
      "level": 3,
      "content": "Дабы убедиться,что наш хост имеет доступ к домену для пользователей и групп, мы проверим настройки nsswitch, используя 'getent'. Следующий вывод показывает,как оно дожно выглядеть на нетронутом Arch Linux:\n\n```\n# getent passwd\n```\n\n```\nroot:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/bin/false\ndaemon:x:2:2:daemon:/sbin:/bin/false\nmail:x:8:12:mail:/var/spool/mail:/bin/false\nftp:x:14:11:ftp:/srv/ftp:/bin/false\nhttp:x:33:33:http:/srv/http:/bin/false\nnobody:x:99:99:nobody:/:/bin/false\ndbus:x:81:81:System message bus:/:/bin/false\nntp:x:87:87:Network Time Protocol:/var/empty:/bin/false\navahi:x:84:84:avahi:/:/bin/false\nadministrator:*:10001:10006:Administrator:/home/EXAMPLE/administrator:/bin/bash\nguest:*:10002:10007:Guest:/home/EXAMPLE/guest:/bin/bash\nkrbtgt:*:10003:10006:krbtgt:/home/EXAMPLE/krbtgt:/bin/bash\ntest.user:*:10000:10006:Test User:/home/EXAMPLE/test.user:/bin/bash\n```\n\nДля групп:\n\n```\n# getent group\n```\n\n```\nroot:x:0:root\nbin:x:1:root,bin,daemon\ndaemon:x:2:root,bin,daemon\nsys:x:3:root,bin\nadm:x:4:root,daemon\ntty:x:5:\ndisk:x:6:root\nlp:x:7:daemon\nmem:x:8:\nkmem:x:9:\nwheel:x:10:root\nftp:x:11:\nmail:x:12:\nuucp:x:14:\nlog:x:19:root\nutmp:x:20:\nlocate:x:21:\nrfkill:x:24:\nsmmsp:x:25:\nhttp:x:33:\ngames:x:50:\nnetwork:x:90:\nvideo:x:91:\naudio:x:92:\noptical:x:93:\nfloppy:x:94:\nstorage:x:95:\nscanner:x:96:\npower:x:98:\nnobody:x:99:\nusers:x:100:\ndbus:x:81:\nntp:x:87:\navahi:x:84:\ndomain computers:x:10008:\ndomain controllers:x:10009:\nschema admins:x:10010:administrator\nenterprise admins:x:10011:administrator\ncert publishers:x:10012:\ndomain admins:x:10013:test.user,administrator\ndomain users:x:10006:\ndomain guests:x:10007:\ngroup policy creator owners:x:10014:administrator\nras and ias servers:x:10015:\nallowed rodc password replication group:x:10016:\ndenied rodc password replication group:x:10017:krbtgt\nread-only domain controllers:x:10018:\nenterprise read-only domain controllers:x:10019:\ndnsadmins:x:10020:\ndnsupdateproxy:x:10021:\n```\n\n"
    },
    {
      "title": "Проверка команд Samba",
      "level": 3,
      "content": "Попробуйте некоторые команды,чтобу увидеть,может ли Samba взаимодействовать с AD:\n\n```\n# net ads info\n```\n\n```\n[2012/02/05 20:21:36.473559,  0] param/loadparm.c:7599(lp_do_parameter)\n  Ignoring unknown parameter \"idmapd backend\"\nLDAP server: 192.168.1.2\nLDAP server name: PDC.example.com\nRealm: EXAMPLE.COM\nBind Path: dc=EXAMPLE,dc=COM\nLDAP port: 389\nServer time: Sun, 05 Feb 2012 20:21:33 CST\nKDC server: 192.168.1.2\nServer time offset: -3\n```\n\n```\n# net ads lookup\n```\n\n```\n[2012/02/05 20:22:39.298823,  0] param/loadparm.c:7599(lp_do_parameter)\n  Ignoring unknown parameter \"idmapd backend\"\nInformation for Domain Controller: 192.168.1.2\n\nResponse Type: LOGON_SAM_LOGON_RESPONSE_EX\nGUID: 2a098512-4c9f-4fe4-ac22-8f9231fabbad\nFlags:\n        Is a PDC:                                   yes\n        Is a GC of the forest:                      yes\n        Is an LDAP server:                          yes\n        Supports DS:                                yes\n        Is running a KDC:                           yes\n        Is running time services:                   yes\n        Is the closest DC:                          yes\n        Is writable:                                yes\n        Has a hardware clock:                       yes\n        Is a non-domain NC serviced by LDAP server: no\n        Is NT6 DC that has some secrets:            no\n        Is NT6 DC that has all secrets:             yes\nForest:                 example.com\nDomain:                 example.com\nDomain Controller:      PDC.example.com\nPre-Win2k Domain:       EXAMPLE\nPre-Win2k Hostname:     PDC\nServer Site Name :              Office\nClient Site Name :              Office\nNT Version: 5\nLMNT Token: ffff\nLM20 Token: ffff\n```\n\n```\n# net ads status -U administrator | less\n```\n\n```\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: user\nobjectClass: computer\ncn: myarchlinux\ndistinguishedName: CN=myarchlinux,CN=Computers,DC=leafscale,DC=inc\ninstanceType: 4\nwhenCreated: 20120206043413.0Z\nwhenChanged: 20120206043414.0Z\nuSNCreated: 16556\nuSNChanged: 16563\nname: myarchlinux\nobjectGUID: 2c24029c-8422-42b2-83b3-a255b9cb41b3\nuserAccountControl: 69632\nbadPwdCount: 0\ncodePage: 0\ncountryCode: 0\nbadPasswordTime: 0\nlastLogoff: 0\nlastLogon: 129729780312632000\nlocalPolicyFlags: 0\npwdLastSet: 129729764538848000\nprimaryGroupID: 515\nobjectSid: S-1-5-21-719106045-3766251393-3909931865-1105\n...<snip>...\n```\n\n"
    },
    {
      "title": "Настройка PAM",
      "level": 2,
      "content": "Теперь мы будем менять разные правила в PAM, чтобы допустить пользователей AD к использованию системы для входа и к sudo доступу. Когда вы меняете правила, запоминание их порядка и помечены ли они как required или как sufficient критически важно,если вы хотите,чтобы всё работало,как вы задумали.Вам не стоит отклоняться от этих правил,если только вы не знаете как писать правила для PAM\n\nВ случае со входом,PAM следует сначала запросить аккаунт AD и проверять локальные аккаунты только если аккаунту AD не соответствует локальный аккаунт.Поэтому, мы добавим записи,которые включат pam_winbindd.so в процесс аутентификации.\n\nГлавный процесс аутентификации в конфигурации PAM Arch Linux находится в /etc/pam.d/system-auth. Начав со стандартной конфигурации из pambase, измените её следующим образом:\n\n"
    },
    {
      "title": "Раздел \"auth\"",
      "level": 4,
      "content": "Найдите строку:\n\n```\nauth required pam_unix.so ...\n```\n\nУдалите её, и замените следующим:\n\n```\nauth [success=1 default=ignore] pam_localuser.so\nauth [success=2 default=die] pam_winbind.so\nauth [success=1 default=die] pam_unix.so nullok\nauth requisite pam_deny.so\n```\n\n"
    },
    {
      "title": "Раздел \"account\"",
      "level": 4,
      "content": "Найдите строку:\n\n```\naccount required pam_unix.so\n```\n\nПод ней допишите следующее:\n\n```\naccount [success=1 default=ignore] pam_localuser.so\naccount required pam_winbind.so\n```\n\n"
    },
    {
      "title": "Раздел \"session\"",
      "level": 4,
      "content": "Найдите строку:\n\n```\nsession required pam_unix.so\n```\n\nПод ней допишите следующее:\n\n```\nsession required pam_mkhomedir.so umask=0022 skel=/etc/skel\nsession [success=1 default=ignore] pam_localuser.so\nsession required pam_winbind.so\n```\n\n"
    },
    {
      "title": "Раздел \"password\"",
      "level": 4,
      "content": "Найдите строку:\n\n```\npassword required pam_unix.so ...\n```\n\nУдалите её и замените следующими:\n\n```\npassword [success=1 default=ignore] pam_localuser.so\npassword [success=2 default=die] pam_winbind.so\npassword [success=1 default=die] pam_unix.so sha512 shadow\npassword requisite pam_deny.so\n```\n\n"
    },
    {
      "title": "Проверка входа",
      "level": 3,
      "content": "Теперь запустите новую сессию/войдите через ssh и попробуйте войти,использую данные аккаунта AD. Имя домена опционально, так как это было задано в настройках Winbind как 'default realm'. Заметьте,что в случае с ssh, вам нужно изменить /etc/ssh/sshd_config, чтобы он разрешал аутентификацию через kerberos: (KerberosAuthentication yes).\n\n```\ntest.user\nEXAMPLE+test.user\n```\n\nОба должны работать. Стоит подметить,что /home/example/test.user будет создан автоматически.\n\nВойдите в другую сессию использую аккаунт Linux. Удостоверьтесь,что всё ещё можете войти как root - запомните,что вы должны быть под аккаунтом root как минимум в одной сессии!\n\n"
    },
    {
      "title": "Настройка общих файлов",
      "level": 2,
      "content": "Ранее мы пропустили настройку общих файлов. Теперь,когда всё работает, вернитесь к /etc/smb.conf и добавьте эксопрт для хостов,которые вы желаете сделать доступными в Windows\n\n```\n/etc/smb.conf\n```\n\n```\n[MyShare]\n  comment = Example Share\n  path = /srv/exports/myshare\n  read only = no\n  browseable = yes\n  valid users = @NETWORK+\"Domain Admins\" NETWORK+test.user\n```\n\nВ примере выше, ключевое слово NETWORK. Не путайте его с именем домена. Для добавления групп,добавьте символ '@' к группе. Заметьте, Domain Admins заключается в \"цитаты\", чтобы Samba корректно считывала их,когда просматривает файл конфигурации.\n\n"
    },
    {
      "title": "Добавление файла keytab и включение беспарольного входа на машину через Kerber и ssh",
      "level": 2,
      "content": "Это объясняет,как сгенерировать keytab файл,который вам нужен,например,чтобы включить беспарольный вход на машину через Kerber и ssh с другой машины в том же домене. Допустим, что у вас много компьютеров в домене и вы только что добавили сервер/рабочую станцию использую описание выше в ваш домен, в котором пользователям нужен ssh для работы - например рабочаю станция GPU или вычислительный узел OpenMP и т.д. В этом случае вам, наверное, не захочется вводить пароль каждый раз при входе. С другой стороны аутентификация с помощью ключа используется множеством пользователей, в этом случае нужных полномочий для,например,монтирования общего NFSv4 с Kerberos. Так что это поможет включить беспарольные входы на машины используя \"kerberos ticket forwarding\".\n\n"
    },
    {
      "title": "Создание key tab файла",
      "level": 3,
      "content": "Запустите 'net ads keytab create -U administrator' как суперпользователь дабы создать keytab файл в '/etc/krb5.keytab'. Она напишет ваи,что необходимо включить аутентификацию с помощью keytab в файле конфигурации, чтобы мы могли совершить следующий шаг. Иногда возникают проблемы, если файл krb5.keytab уже существует,в таком случае нужно переименовать его и запустить команду ещё раз, это должно помочь.\n\n```\n# net ads keytab create -U administrator\n```\n\nПроверьте содержание файла следующим образом:\n\n```\n# klist -k /etc/krb5.keytab\n```\n\n```\nKeytab name: FILE:/etc/krb5.keytab\nKVNO Principal\n---- --------------------------------------------------------------------------\n   4 host/myarchlinux.example.com@EXAMPLE.COM\n   4 host/myarchlinux.example.com@EXAMPLE.COM\n   4 host/myarchlinux.example.com@EXAMPLE.COM\n   4 host/myarchlinux.example.com@EXAMPLE.COM\n   4 host/myarchlinux.example.com@EXAMPLE.COM\n   4 host/MYARCHLINUX@EXAMPLE.COM\n   4 host/MYARCHLINUX@EXAMPLE.COM\n   4 host/MYARCHLINUX@EXAMPLE.COM\n   4 host/MYARCHLINUX@EXAMPLE.COM\n   4 host/MYARCHLINUX@EXAMPLE.COM\n   4 MYARCHLINUX$@EXAMPLE.COM\n   4 MYARCHLINUX$@EXAMPLE.COM\n   4 MYARCHLINUX$@EXAMPLE.COM\n   4 MYARCHLINUX$@EXAMPLE.COM\n   4 MYARCHLINUX$@EXAMPLE.COM\n```\n\n"
    },
    {
      "title": "Включение входа через keytab",
      "level": 3,
      "content": "Теперь вам нужно указать winbind,что он должен использовать keytab файлы,добавив следующий строки в /etc/samba/smb.conf:\n\n```\n/etc/samba/smb.conf\n```\n\n```\nkerberos method = system keytab\n dedicated keytab file = /etc/krb5.keytab\n```\n\nВ итоге всё должно выглядеть примерно так:\n\n```\n/etc/samba/smb.conf\n```\n\n```\n[Global]\n  netbios name = MYARCHLINUX\n  workgroup = EXAMPLE\n  realm = EXAMPLE.COM\n  server string = %h Arch Linux Host\n  security = ads\n  encrypt passwords = yes\n  password server = pdc.example.com\n  kerberos method = system keytab\n  dedicated keytab file = /etc/krb5.keytab\n\n  idmap config * : backend = tdb\n  idmap config * : range = 10000-20000\n\n  winbind use default domain = Yes\n  winbind enum users = Yes\n  winbind enum groups = Yes\n  winbind nested groups = Yes\n  winbind separator = +\n  winbind refresh tickets = yes\n\n  template shell = /bin/bash\n  template homedir = /home/%D/%U\n   \n  preferred master = no\n  dns proxy = no\n  wins server = pdc.example.com\n  wins proxy = no\n\n  inherit acls = Yes\n  map acl inherit = Yes\n  acl group control = yes\n\n  load printers = no\n  debug level = 3\n  use sendfile = no\n```\n\nПерезапустите winbind.service с помощью 'systemctl restart winbind.service' с привелегиями суперпользователя.\n\n```\n# systemctl restart winbind.service\n```\n\nПроверьте,всё ли работает,получив тикет для вашей системы и запустив\n\n```\n# kinit MYARCHLINUX$ -kt /etc/krb5.keytab\n```\n\nЭта команда не должна написать ничего в консоль,ондако 'klist' должен показать что-то вроде этого:\n\n```\n# klist\n```\n\n```\nTicket cache: FILE:/tmp/krb5cc_0\n Default principal: MYARCHLINUX$@EXAMPLE.COM\n \n Valid starting    Expires           Service principal \n 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM\n         renew until 02/05/12 21:27:47\n```\n\nНекоторые частые ошибки : a)забывают поставить $ или b) игнорируют чувствительный регистр - он должен быть точно таким же,как записьв keytab\n\n"
    },
    {
      "title": "Подготовка sshd на сервере",
      "level": 3,
      "content": "Всё,что нам нужно сделать - это добавить некоторые опции в sshd_config и перезапустить sshd.service.\n\nИзмените '/etc/ssh/sshd_config' чтобы он выглядел так в нужных местах:\n\n```\n# /etc/ssh/sshd_config\n```\n\n```\n...\n\n# Изсенить на no чтобы выключить s/key пароли\nChallengeResponseAuthentication no\n\n# Опции Kerberos \nKerberosAuthentication yes\n#KerberosOrLocalPasswd yes\nKerberosTicketCleanup yes\nKerberosGetAFSToken yes\n\n# Опции GSSAPI\nGSSAPIAuthentication yes\nGSSAPICleanupCredentials yes\n\n...\n```\n\nПерезапустите sshd.service:\n\n```\n# systemctl restart sshd.service\n```\n\n"
    },
    {
      "title": "Добавление опций, нужных для клиента",
      "level": 3,
      "content": "Для начала нам нужно убедиться в том, что тикеты доступны для клиента. Обычно всё работает, но, на всякий случай, используйте следующий параметр:\n\n```\nforwardable = true\n```\n\nДалее надо добавить опции:\n\n```\nGSSAPIAuthentication yes\nGSSAPIDelegateCredentials yes\n```\n\nв наш файл .ssh/config, который говорит ssh использовать эту опцию, как альтернативу: можно использовать 'ssh -o' (смотрите страницу справочного руководства ssh(1)).\n\n"
    },
    {
      "title": "Проверка установки",
      "level": 3,
      "content": "Клиент:\n\nУбедитесь,что у вас правильный тикет, используя 'kinit'. Затем подключитесь к своем машине через ssh\n\n```\nssh myarchlinux.example.com\n```\n\nВы должны подключится без просьбы ввести пароль\n\nЕсли у вас также включна аутентификация ключем,нужно выполнить\n\n```\nssh -v myarchlinux.example.com\n```\n\nчтобы увидеть,какой метод аутентификации используется на самом деле.\n\nДля дебага вы можете включить DEBUG3 на сервере и посмотреть лог через 'journalctl'\n\n"
    },
    {
      "title": "Настройка для полной аутентификации Kerberos без пароля.",
      "level": 3,
      "content": "Если ваши клиенты не используют доменные аккаунты на их локальных машинах (по какой бы то не было причине),довольно сложно будет научить их использовать 'kinit' перед тем,как ssh подключится к рабочей станции.Так что есть классный способ это решить:\n\n"
    },
    {
      "title": "Генерирование keytab, которые будет принимать AD",
      "level": 2,
      "content": "Пользователь должен выполнить:\n\n```\nktutil\naddent -password -p username@EXAMPLE.COM -k 1 -e RC4-HMAC\n- enter password for username -\nwkt username.keytab\nq\n```\n\nТеперь провертьте файл:\n\n```\nkinit -kt username.keytab\n```\n\nОно не должно спросить пароль, теперь просто скопируйте это в '~/.bashrc', это позволит не вводит пароль каждый раз.\n\n"
    },
    {
      "title": "Интересно знать",
      "level": 3,
      "content": "Файл 'username.keytab' не спецефичен для машины,и,следовательно,может быть скопирован на другие машины. Например,мы создали файл на Linux машине и скопировали на Mac клиента так как команды в неё другие...\n\n"
    },
    {
      "title": "Смотрите также",
      "level": 2,
      "content": "- Wikipedia: Active Directory\n- Wikipedia: Samba\n- Wikipedia: Kerberos\n- Samba: Documentation\n- Samba Wiki - Samba, Active Directory & LDAP\n- smb.conf(5)\n\n"
    },
    {
      "title": "Коммерческие решения",
      "level": 3,
      "content": "- Centrify\n- Likewise\n\n"
    }
  ]
}