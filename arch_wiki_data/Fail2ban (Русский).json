{
  "title": "Fail2ban (Русский)",
  "url": "https://wiki.archlinux.org/title/Fail2ban_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Fail2ban (англ.) сканирует лог-файлы (например, /var/log/httpd/error_log) и блокирует IP-адреса, которые ведут себя подозрительно, к примеру, делая слишком много попыток входа с неверным паролем в попытках найти уязвимости и т.п. Обычно Fail2ban используется для обновления правил с целью блокировки IP-адресов на определённое время, но можно настроить и другие действия — например, отправку письма по электронной почте.\n\n"
    },
    {
      "title": "Установка",
      "level": 2,
      "content": "Установите пакет fail2ban.\n\n"
    },
    {
      "title": "Использование",
      "level": 2,
      "content": "Настройте Fail2ban, после чего включите и запустите службу fail2ban.service.\n\n"
    },
    {
      "title": "fail2ban-client",
      "level": 3,
      "content": "Утилита fail2ban-client позволяет следить за \"клетками\" (jails) (reload, restart, status и т.д.). Чтобы увидеть список всех доступных команд, введите:\n\n```\n$ fail2ban-client\n```\n\nПросмотр включённых \"клеток\" (jails):\n\n```\n# fail2ban-client status\n```\n\nПроверка статуса \"клетки\" на примере таковой для sshd:\n\n```\n# fail2ban-client status sshd\n```\n\n```\nStatus for the jail: sshd\n|- Filter\n|  |- Currently failed: 1\n|  |- Total failed:     9\n|  `- Journal matches:  _SYSTEMD_UNIT=sshd.service + _COMM=sshd\n`- Actions\n   |- Currently banned: 1\n   |- Total banned:     1\n   `- Banned IP list:   0.0.0.0\n```\n\n"
    },
    {
      "title": "Настройка",
      "level": 2,
      "content": "Рекомендуется создать файл /etc/fail2ban/jail.local, так как /etc/fail2ban/jail.conf может быть перезаписан во время обновления системы. К примеру, задать время блокировки в 1 день можно следующим образом:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\nbantime = 1d\n```\n\nТакже можно создавать отдельные файлы name.local в каталоге /etc/fail2ban/jail.d, например, /etc/fail2ban/jail.d/sshd.local.\n\nПерезапустите службу fail2ban.service для применения изменений.\n\n"
    },
    {
      "title": "Включение \"клеток\"",
      "level": 3,
      "content": "По умолчанию все \"клетки\" отключены. Добавьте строку enabled = true к конфигурации той \"клетки\", которую необходимо включить. Например, включение \"клетки\" OpenSSH выглядит следующим образом:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[sshd]\nenabled = true\n```\n\nСм. #Пользовательская \"клетка\" SSH.\n\n"
    },
    {
      "title": "Почтовые уведомления",
      "level": 3,
      "content": "Для получения электронных писем при блокировке IP-адресов следует настроить SMTP-клиент (например, msmtp (англ.)) и изменить действие по умолчанию:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\ndestemail = вашеимя@example.com\nsender = вашеимя@example.com\n\n# для блокировки и отправки электронного письма на destemail с whois-отчётом\naction = %(action_mw)s\n\n# то же, что и action_mw, но включает в себя ещё и связанные строки из лога\n#action = %(action_mwl)s\n```\n\n"
    },
    {
      "title": "Межсетевой экран и службы",
      "level": 3,
      "content": "По умолчанию Fail2ban использует iptables. Однако, настройка большинства и служб не представляет трудности. Пример использования nftables:\n\n```\n/etc/fail2ban/jail.local\n```\n\n```\n[DEFAULT]\nbanaction = nftables\nbanaction_allports = nftables[type=allports]\n```\n\nСм. содержимое директории /etc/fail2ban/action.d/ для получения других примеров, например, ufw.conf.\n\n"
    },
    {
      "title": "Пользовательская \"клетка\" SSH",
      "level": 3,
      "content": "Отредактируйте файл /etc/fail2ban/jail.d/sshd.local, добавив эту секцию и обновив список доверенных IP-адресов в ignoreip:\n\n```\n/etc/fail2ban/jail.d/sshd.local\n```\n\n```\n[sshd]\nenabled   = true\nfilter    = sshd\nbanaction = iptables\nbackend   = systemd\nmaxretry  = 5\nfindtime  = 1d\nbantime   = 2w\nignoreip  = 127.0.0.1/8\n```\n\n- Может понадобиться задать LogLevel VERBOSE в файле /etc/ssh/sshd_config, чтобы разрешить Fail2ban полноценный мониторинг. В противном случае, ошибки ввода пароля могут быть неправильно зарегистрированы.\n- Fail2ban поддерживает IPv6 с версии 0.10. Настройте межсетевой экран соответственно, например, запустите и включите службу ip6tables.service.\n- Fail2ban поддерживает работу с пространствами имён журнала (которые задаются с помощью LogNamespace=ваше_пространство_имён в файлах юнитов). Задайте параметру backend, к примеру, значение backend = systemd[journalfiles=\"/var/log/journal/*.ваше_пространство_имён/system.journal\"], чтобы активировать эту возможность.\n\n- При использовании фронтендов iptables, например, ufw (англ.), можно использовать banaction = ufw вместо iptables.\n- При использовании Shorewall (англ.) можно прописать banaction = shorewall и также задать значение ALL параметру BLACKLIST в файле /etc/shorewall/shorewall.conf. В противном случае, правила, добавленные для блокировки IP-адреса, будут влиять только на новые соединения.\n\n"
    },
    {
      "title": "Защита службы",
      "level": 3,
      "content": "Поскольку Fail2ban следует запускать от имени суперпользователя, можно дополнительно защитить службу с помощью systemd.\n\nСоздайте конфигурационный drop-in файл для службы fail2ban.service:\n\n```\n/etc/systemd/system/fail2ban.service.d/override.conf\n```\n\n```\n[Service]\nPrivateDevices=yes\nPrivateTmp=yes\nProtectHome=read-only\nProtectSystem=strict\nReadWritePaths=-/var/run/fail2ban\nReadWritePaths=-/var/lib/fail2ban\nReadWritePaths=-/var/log/fail2ban\nReadWritePaths=-/var/spool/postfix/maildrop\nReadWritePaths=-/run/xtables.lock\nCapabilityBoundingSet=CAP_AUDIT_READ CAP_DAC_READ_SEARCH CAP_NET_ADMIN CAP_NET_RAW\n```\n\nПараметр CAP_DAC_READ_SEARCH (в строке CapabilityBoundingSet) позволяет Fail2ban читать любые файлы и каталоги, а CAP_NET_ADMIN и CAP_NET_RAW позволяют Fail2ban управлять любым межсетевым экраном c командной оболочкой. См. capabilities(7) для получения более подробной информации.\n\nПри использовании параметра ProtectSystem=strict иерархия файловой системы будет доступна только для чтения, а ReadWritePaths позволит Fail2ban также вести запись в заданные каталоги.\n\nОт имени суперпользователя создайте каталог /var/log/fail2ban/ и пропишите в файл /etc/fail2ban/fail2ban.local корректный путь logtarget:\n\n```\n/etc/fail2ban/fail2ban.local\n```\n\n```\n[Definition]\nlogtarget = /var/log/fail2ban/fail2ban.log\n```\n\nДля применения изменений в файлах юнитов перезагрузите демон systemd и перезапустите службу fail2ban.service.\n\n"
    },
    {
      "title": "Смотрите также",
      "level": 2,
      "content": "- Using a Fail2Ban Jail to Whitelist a User (англ.)\n- Optimising your Fail2Ban filters (англ.)\n- Fail2Ban and sendmail (англ.)\n- Fail2Ban and iptables (англ.)\n- Fail2Ban 0.8.3 Howto (англ.)\n- Monitoring the fail2ban log (англ.)\n\n"
    }
  ]
}