{
  "title": "Подмена MAC-адреса",
  "url": "https://wiki.archlinux.org/title/%D0%9F%D0%BE%D0%B4%D0%BC%D0%B5%D0%BD%D0%B0_MAC-%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%B0",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "В статье описаны способы подмены адреса Media Access Control (MAC).\n\n"
    },
    {
      "title": "Вручную",
      "level": 2,
      "content": "Существует два способа подменить MAC-адрес \"вручную\": установить и настроить либо iproute2, либо macchanger. Оба способа изложены ниже.\n\n"
    },
    {
      "title": "iproute2",
      "level": 3,
      "content": "Сперва проверьте ваш текущий MAC-адрес:\n\n```\n# ip link show интерфейс\n```\n\nЗдесь интерфейс — имя вашего сетевого интерфейса.\n\nНеобходимая нам в данный момент информация расположена в строке, начинающейся со слов \"link/ether\", за которыми следует 6-байтный номер:\n\n```\nlink/ether 00:1d:98:5a:d1:3a\n```\n\nОтключите интерфейс:\n\n```\n# ip link set dev интерфейс down\n```\n\nПереходим к собственно подмене MAC-адреса. В качестве нового адреса подойдет любое шестнадцатеричное число, однако имейте в виду, что некоторые сети могут отказаться присваивать IP-адрес клиенту, чей MAC-адрес не принадлежат ни одному из производителей оборудования. Поэтому, если вы не контролируете сеть(и), к которой подключены, используйте префикс MAC (первые три байта) реального производителя, а для оставшихся трех укажите произвольные значения. Подробнее см. Википедия:Уникальный идентификатор организации.\n\nЧтобы сменить MAC, выполните:\n\n```\n# ip link set dev интерфейс address XX:XX:XX:XX:XX:XX\n```\n\nгде вместо XX:XX:XX:XX:XX:XX необходимо указать любое 6-байтное значение.\n\nПоследний шаг — включить интерфейс обратно:\n\n```\n# ip link set dev интерфейс up\n```\n\nЧтобы убедиться, что подмена MAC-адреса действительно произошла, снова выполните команду ip link show интерфейс и проверьте значение \"link/ether\". Если подмена сработала, \"link/ether\" будет иметь то значение, которое вы ему присвоили.\n\n"
    },
    {
      "title": "macchanger",
      "level": 3,
      "content": "В этом способе используется macchanger (GNU MAC Changer). Он предоставляет набор функций для смены адреса на, например, соответствующий конкретному производителю или полностью случайный.\n\nУстановите пакет macchanger.\n\nПодмена осуществляется для конкретного интерфейса: в каждой из следующих команд заменяйте интерфейс на имя вашего сетевого интерфейса.\n\nВы можете сгенерировать полностью случайный адрес:\n\n```\n# macchanger -r интерфейс\n```\n\nЧтобы изменить только байты, которые являются уникальными для конкретного устройства (благодаря чему при проверке MAC-адрес будет по-прежнему считаться принадлежащим тому же производителю), выполните:\n\n```\n# macchanger -e интерфейс\n```\n\nДля задания конкретного MAC-адреса выполните:\n\n```\n# macchanger --mac=XX:XX:XX:XX:XX:XX интерфейс\n```\n\nгде XX:XX:XX:XX:XX:XX — MAC, который вы хотите присвоить.\n\nНаконец, для восстановления исходного значения MAC-адреса:\n\n```\n# macchanger -p интерфейс\n```\n\n"
    },
    {
      "title": "systemd-networkd",
      "level": 3,
      "content": "systemd-networkd поддерживает подмену MAC-адреса при помощи файлов link (подробнее см. systemd.link(5)).\n\nДля подмены статическим адресом:\n\n```\n/etc/systemd/network/00-default.link\n```\n\n```\n[Match]\nMACAddress=оригинальный MAC\n\n[Link]\nMACAddress=новый MAC\nNamePolicy=kernel database onboard slot path\n```\n\nДля случайной генерации MAC-адреса при каждой загрузке, установите MACAddressPolicy=random вместо MACAddress=новый MAC.\n\n"
    },
    {
      "title": "systemd-udevd",
      "level": 3,
      "content": "udev позволяет подменять MAC-адреса с помощью правил. Атрибут address позволяет udev найти нужное устройство по MAС-адресу производителя, после чего выполняется команда ip для его замены:\n\n```\n/etc/udev/rules.d/81-mac-spoof.rules\n```\n\n```\nACTION==\"add\", SUBSYSTEM==\"net\", ATTR{address}==\"XX:XX:XX:XX:XX:XX\", RUN+=\"/usr/bin/ip link set dev %k address YY:YY:YY:YY:YY:YY\"\n```\n\nгде XX:XX:XX:XX:XX:XX — оригинальный MAC-адрес, а YY:YY:YY:YY:YY:YY — новый. Для адреса необходимо использовать буквы в нижнем регистре.\n\n"
    },
    {
      "title": "Создание юнита",
      "level": 4,
      "content": "Ниже приведены примеры юнитов systemd для изменения MAC-адреса во время загрузки системы: первый устанавливает MAC утилитой ip, а второй использует macchanger для присвоения случайного адреса. Цель network-pre.target используется для задания очерёдности действий: MAC-адрес должен изменяться до запуска сетевых менеджеров вроде netctl, NetworkManager, systemd-networkd или dhcpcd.\n\nЮнит systemd, устанавливающий указанный MAC-адрес:\n\n```\n/etc/systemd/system/macspoof@.service\n```\n\n```\n[Unit]\nDescription=MAC Address Change %I\nWants=network-pre.target\nBefore=network-pre.target\nBindsTo=sys-subsystem-net-devices-%i.device\nAfter=sys-subsystem-net-devices-%i.device\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/ip link set dev %i address 36:aa:88:c8:75:3a\nExecStart=/usr/bin/ip link set dev %i up\n\n[Install]\nWantedBy=multi-user.target\n```\n\nЮнит systemd, устанавливающий случайный адрес с сохранением префикса производителя. Удостоверьтесь, пакет macchanger установлен:\n\n```\n/etc/systemd/system/macspoof@.service\n```\n\n```\n[Unit]\nDescription=macchanger on %I\nWants=network-pre.target\nBefore=network-pre.target\nBindsTo=sys-subsystem-net-devices-%i.device\nAfter=sys-subsystem-net-devices-%i.device\n\n[Service]\nExecStart=/usr/bin/macchanger -e %I\nType=oneshot\n\n[Install]\nWantedBy=multi-user.target\n```\n\nЕсли вы хотите, чтобы адрес изменялся целиком, включая префикс производителя (первые три байта), используйте опцию -r вместо -e (см. #macchanger).\n\n"
    },
    {
      "title": "Включение службы",
      "level": 4,
      "content": "Добавьте имя интерфейса в название службы (например, eth0; в итоге служба будет назваться как-то вроде macspoof@eth0.service) и включите её.\n\nПерезагрузитесь либо перезапустите необходимые службы в правильном порядке. Если вы являетесь администратором сети, в которой находится машина с изменяемым MAC-адресом, то изучите таблицу статических/динамических адресов на маршрутизаторе на предмет того, был ли MAC дествительно изменён.\n\n"
    },
    {
      "title": "netctl",
      "level": 3,
      "content": "Вы можете использовать хуки netctl для выполнения команд при каждом (пере)запуске профиля netctl на определённом сетевом интерфейсе. Замените интерфейс на необходимый:\n\n```\n/etc/netctl/interfaces/интерфейс\n```\n\n```\n#!/usr/bin/env sh\n/usr/bin/macchanger -r интерфейс\n```\n\nСделайте скрипт исполняемым:\n\n```\nchmod +x /etc/netctl/interfaces/интерфейс\n```\n\nИсточник: akendo.eu (archive)\n\n"
    },
    {
      "title": "NetworkManager",
      "level": 3,
      "content": "См. NetworkManager#Configuring MAC address randomization.\n\n"
    },
    {
      "title": "wpa_supplicant",
      "level": 3,
      "content": "wpa_supplicant может использовать случайный MAC-адрес для каждого ESS-соединения [1].\n\nДобавьте следующие строки в файл настроек:\n\n```\n/etc/wpa_supplicant/wpa_supplicant-wlan0.conf\n```\n\n```\nmac_addr=1\npreassoc_mac_addr=1\ngas_rand_mac_addr=1\n```\n\n"
    },
    {
      "title": "iwd",
      "level": 3,
      "content": "Со следующими настройками iwd будет генерировать случайный MAC-адрес при каждом запуске (подробнее см. iwd.config(5)):\n\n```\n/etc/iwd/main.conf\n```\n\n```\n[General]\nAddressRandomization=once\nAddressRandomizationRange=nic\n```\n\nПараметр AddressRandomizationRange определяет, какая часть адреса будет сгенерирована. При значении nic изменяться будут последние три октета, относящиеся непосредственно к сетевому интерфейсу; первые три октета останутся прежними. При значении full сгенерирован будет весь адрес целиком.\n\n"
    },
    {
      "title": "Не удается подключиться к сети DHCPv4",
      "level": 3,
      "content": "Если вы используете dhcpcd (в NetworkManager используется по умолчанию) и не можете подключиться к сети DHCPv4, необходимо изменить настройки dhcpcd, чтобы арендовать адрес.\n\n"
    },
    {
      "title": "Смотрите также",
      "level": 2,
      "content": "- Википедия:MAC-спуфинг\n- Macchanger на GitHub\n- Статья на debianadmin.com с большим количеством опций для macchanger\n\n"
    }
  ]
}