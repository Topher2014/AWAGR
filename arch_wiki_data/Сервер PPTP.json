{
  "title": "Сервер PPTP",
  "url": "https://wiki.archlinux.org/title/%D0%A1%D0%B5%D1%80%D0%B2%D0%B5%D1%80_PPTP",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Point-to-Point Tunneling Protocol (PPTP) — метод реализации виртуальной частной сети. PPTP использует канал контроля над туннелями TCP и GRE для инкапсуляции PPP-пакетов.\n\nДалее будет показано, как создать сервер PPTP в Arch.\n\n"
    },
    {
      "title": "Установка",
      "level": 2,
      "content": "Установите пакет pptpd.\n\n"
    },
    {
      "title": "Настройка",
      "level": 2,
      "content": "Настройка производится в файле /etc/pptpd.conf. Пример:\n\n```\n/etc/pptpd.conf\n```\n\n```\n# Обратитесь к man pptpd.conf для получения подробной информации о настройке\n\n# Файл опций, который будет передан в pppd вместо стандартного /etc/ppp/options\n# В данном примере: /etc/ppp/options.pptpd\noption /etc/ppp/options.pptpd\n\n# IP-адрес сервера в локальной сети (замените своим)\n# В данном примере: 192.168.1.2\nlocalip 192.168.1.2\n\n# Диапазон адресов для клиентов PPTP-сервера (замените по своему усмотрению)\n# В данном примере клиенты будут получать IP-адреса в диапазоне 192.168.1.234-238 и 192.168.1.245\nremoteip 192.168.1.234-238,192.168.1.245\n```\n\nПосле чего создайте файл опций /etc/ppp/options.pptpd. Пример:\n\n```\n/etc/ppp/options.pptpd\n```\n\n```\n# Обратитесь к man pppd чтобы увидеть полный список доступных опций и их описание.\n\nname pptpd         # Название локальной системы для целей авторизации\nrefuse-pap         # Отказывать авторизацию пирам, использующим PAP\nrefuse-chap        # Отказывать авторизацию пирам, использующим CHAP\nrefuse-mschap      # Отказывать авторизацию пирам, использующим MS-CHAP\nrequire-mschap-v2  # Требовать авторизацию с использованием MS-CHAPv2\nrequire-mppe-128   # Требовать использование MPPE с 128-битным шифрованием\nproxyarp           # Добавлять запись в системную таблицу ARP\nlock               # Обеспечить блокирование для монопольного доступа к последовательному устройству\nnobsdcomp          # Отключить сжатие BSD-Compress\nnovj               # Отключить сжатие Вана Якобсона для заголовков\nnovjccomp          # Отключить сжатие идентификатора соединения\nnolog              # Отличить логирование в файл\nms-dns 8.8.8.8     # Указываем первичный адрес DNS-сервера для клиентов Microsoft Windows\nms-dns 8.8.4.4     # Указываем вторичный адрес DNS-сервера для клиентов Microsoft Windows\n```\n\nДалее вам необходимо создать пользователей для аутентификации в файле /etc/ppp/chap-secrets:\n\n```\n/etc/ppp/chap-secrets\n```\n\n```\n# <Имя> <Название сервера> <Пароль> <IP-адреса>\nuser2    pptpd    123    *\n```\n\nТеперь вы сможете авторизоваться, используя имя \"user2\" и пароль \"123\" под любым IP-адресом.\n\nДалее необходимо включить форвардинг пакетов (это можно сделать несколькими способами, больше информации доступно на странице Internet sharing (Русский)#Разрешите пересылку пакетов):\n\n```\n/etc/sysctl.d/30-ipforward.conf\n```\n\n```\nnet.ipv4.ip_forward=1\n```\n\nТеперь примените все изменения, сделанные в конфигурационных файлах sysctl:\n\n```\n# sysctl --system\n```\n\n"
    },
    {
      "title": "Настройка межсетевого экрана iptables",
      "level": 3,
      "content": "Ниже представлен пример конфигурации iptables для настройки межсетевого экрана.\n\n```\n# Пропускать все пакеты с интерфейсов ppp*, например ppp0\niptables -A INPUT -i ppp+ -j ACCEPT\niptables -A OUTPUT -o ppp+ -j ACCEPT\n\n# Пропускать входящие соединения на порт 1723 (PPTP)\niptables -A INPUT -p tcp --dport 1723 -j ACCEPT\n\n# Пропускать все пакеты GRE\niptables -A INPUT -p 47 -j ACCEPT\niptables -A OUTPUT -p 47 -j ACCEPT\n\n# Включить форвардинг IP\niptables -F FORWARD\niptables -A FORWARD -j ACCEPT\n\n# Включить NAT для интерфейсов eth0 и ppp*\niptables -A POSTROUTING -t nat -o eth0 -j MASQUERADE\niptables -A POSTROUTING -t nat -o ppp+ -j MASQUERADE\n```\n\nПосле чего сохраните новые правила iptables в файл командой:\n\n```\n# iptables-save > /etc/iptables/iptables.rules\n```\n\nЧтобы файл /etc/iptables/iptables.rules применялся автоматически при загрузке системы, включите службу iptables.service.\n\n```\n# systemctl enable iptables.service\n```\n\nБольше информации доступно на странице Iptables.\n\n"
    },
    {
      "title": "Настройка межсетевого экрана UFW",
      "level": 3,
      "content": "Настройте UFW так, чтобы предоставить доступ клиентам PPTP.\n\nВам необходимо изменить правило переадресации по умолчанию в файле /etc/default/ufw:\n\n```\n/etc/default/ufw\n```\n\n```\nDEFAULT_FORWARD_POLICY=\"ACCEPT\"\n```\n\nТеперь отредактируйте файл /etc/ufw/before.rules, добавив следующий код после заголовка и перед строкой *filter:\n\n```\n/etc/ufw/before.rules\n```\n\n```\n# Правила для таблицы NAT\n*nat\n:POSTROUTING ACCEPT [0:0]\n\n# Пропускать пакеты от клиентов на интерфейс eth0\n-A POSTROUTING -s 172.16.36.0/24 -o eth0 -j MASQUERADE\n\n# Коммит, чтобы изменения вступили в силу\nCOMMIT\n```\n\nРазрешаем пакеты GRE (протокол 47) в /etc/ufw/before.rules, найдите строку: # drop INVALID packets и добавьте правило:\n\n```\n/etc/ufw/before.rules\n```\n\n```\n# drop INVALID packets (logs these in loglevel medium and higher)\n-A ufw-before-input -p 47 -i $iface -j ACCEPT\n-A ufw-before-input -m conntrack --ctstate INVALID -j ufw-logging-deny\n-A ufw-before-input -m conntrack --ctstate INVALID -j DROP\n```\n\nОткрываем PPTP порт 1723:\n\n```\nufw allow 1723\n```\n\nПерезапустите ufw:\n\n```\nufw disable\nufw enable\n```\n\n"
    },
    {
      "title": "Запуск сервера",
      "level": 2,
      "content": "Для запуска сервера PPTP, запустите службу pptpd.service.\n\n"
    },
    {
      "title": "Решение проблем",
      "level": 2,
      "content": "Информация о решении проблем со службами доступна на странице Systemd (Русский)#Решение проблем.\n\n"
    },
    {
      "title": "Ошибка 619 на стороне клиента",
      "level": 3,
      "content": "Найдите и удалите (или закомментируйте) опцию logwtmp в файле /etc/pptpd.conf. С включенной опцией используется wtmp для записи лога подключений и отключений клиента.\n\n```\n# logwtmp\n```\n\n"
    },
    {
      "title": "pptpd[xxxxx]: Long config file line ignored",
      "level": 3,
      "content": "Добавьте пустую строку в конец файла /etc/pptpd.conf.[1]\n\n"
    },
    {
      "title": "ppp0: ppp: compressor dropped pkt",
      "level": 3,
      "content": "Если при подключении клиента выводится это сообщение, добавьте скрипт /etc/ppp/ip-up.d/mppefixmtu.sh со следующим содержимым:\n\n```\n#!/bin/sh\nCURRENT_MTU=\"`ip link show $1 | grep -Po '(?<=mtu )([0-9]+)'`\"\nFIXED_MTU=\"`expr $CURRENT_MTU + 4`\"\nip link set $1 mtu $FIXED_MTU\n```\n\nПосле чего не забудьте сделать его исполняемым:\n\n```\n# chmod 755 /etc/ppp/ip-up.d/mppefixmtu.sh\n```\n\nСмотрите также отчет об ошибке: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=330973.\n\n"
    }
  ]
}