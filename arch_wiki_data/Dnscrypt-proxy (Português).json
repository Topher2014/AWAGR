{
  "title": "Dnscrypt-proxy (Português)",
  "url": "https://wiki.archlinux.org/title/Dnscrypt-proxy_(Portugu%C3%AAs)",
  "sections": [
    {
      "title": "Introduction",
      "level": 1,
      "content": "Artigos relacionados\n\n- Resolução de nome de domínio\n\nO dnscrypt-proxy é um proxy DNS com suporte para os protocolos DNS criptografados DNS sobre HTTPS e DNSCrypt, que pode ser usado para prevenir ataques do tipo man-in-the-middle e espionagem. O dnscrypt-proxy também é compatível com DNSSEC.\n\n"
    },
    {
      "title": "Instalação",
      "level": 2,
      "content": "Instale o pacote dnscrypt-proxy.\n\n"
    },
    {
      "title": "Inicialização",
      "level": 3,
      "content": "O serviço pode ser iniciado de duas formas mutuamente exclusivas (ou seja, apenas um dos dois pode estar ativado):\n\n- Com o arquivo .service.\n\n- Por meio de ativação de .socket.\n\n"
    },
    {
      "title": "Selecionar resolvedor",
      "level": 3,
      "content": "Ao deixar server_names comentado no arquivo de configuração /etc/dnscrypt-proxy/dnscrypt-proxy.toml, o dnscrypt-proxy escolherá o servidor mais rápido a partir das fontes já configurado em [sources] [1]. As listas serão baixadas, verificadas e atualizadas automaticamente [2]. Assim, a configuração de um conjunto específico de servidores é opcional.\n\nPara definir manualmente qual servidor é usado, edite /etc/dnscrypt-proxy/dnscrypt-proxy.toml e descomente a variável server_names, selecionando um ou mais dos servidores. Por exemplo, para usar os servidores da Cloudflare:\n\n```\nserver_names = ['cloudflare', 'cloudflare-ipv6']\n```\n\nUma lista completa de resolvedores está localizada na página do upstream ou no Github. Se o dnscrypt-proxy já tiver sido executado com sucesso no sistema antes, /var/cache/dnscrypt-proxy/public-resolvers.md também conterá uma lista. Olhe a descrição dos servidores que validam DNSSEC (Português), não registram e não são censurados. Esses requisitos podem ser configurados globalmente com as opções require_dnssec, require_nolog, require_nofilter.\n\n"
    },
    {
      "title": "Desabilitar quaisquer serviços na porta 53",
      "level": 3,
      "content": "Para ver se algum programa está usando a porta 53, execute:\n\n```\n$ ss -lp 'sport = :domain'\n```\n\nSe a saída contiver mais do que a primeira linha de nomes de coluna, será necessário desabilitar qualquer serviço que esteja usando a porta 53. Um culpado comum é systemd-resolved.service(NetworkManager (Português)#Unit dbus-org.freedesktop.resolve1.service não encontrado), mas outros gerentes de rede podem ter componentes análogos. Você está pronto para prosseguir, uma vez que o comando acima não produz nada além da seguinte linha:\n\n```\nNetid               State                 Recv-Q                Send-Q                                 Local Address:Port                                   Peer Address:Port\n```\n\n"
    },
    {
      "title": "Modificar resolv.conf",
      "level": 3,
      "content": "Modifique o arquivo resolv.conf e substitua o conjunto atual de endereços do resolvedor pelo endereço para localhost e opções [3]:\n\n```\nnameserver ::1\nnameserver 127.0.0.1\noptions edns0 single-request-reopen\n```\n\nOutros programas sobrescrevem essa configuração. Veja resolv.conf (Português)#Sobrescrita do /etc/resolv.conf para detalhes.\n\n"
    },
    {
      "title": "Iniciar o serviço systemd",
      "level": 3,
      "content": "Finalmente, inicie/habilite a unit dnscrypt-proxy.service ou dnscrypt-proxy.socket, dependendo de qual método você escolheu.\n\n"
    },
    {
      "title": "Configuração de cache de DNS local",
      "level": 3,
      "content": "É recomendado executar o dnscrypt-proxy como um encaminhador para um cache DNS local, se não estiver usando o recurso de cache dnscrypt-proxy; caso contrário, todas as consultas farão um retorno para o resolvedor upstream. Qualquer programa de cache DNS local deve funcionar. Além de configurar o dnscrypt-proxy, você deve configurar o seu programa de cache DNS local.\n\n"
    },
    {
      "title": "Alterar a porta",
      "level": 4,
      "content": "Para encaminhar consultas de um cache DNS local, o dnscrypt-proxy deve escutar em uma porta diferente do padrão 53, já que o próprio cache DNS precisa escutar 53 e consultar dnscrypt-proxy em uma porta diferente. O número de porta 53000 é usado como um exemplo nesta seção. Neste exemplo, o número da porta é maior que 1024, portanto, o dnscrypt-proxy não precisa ser executado pelo root.\n\nExistem dois métodos para alterar a porta padrão:\n\nMétodo do soquete\n\nEdite dnscrypt-proxy.socket como o seguinte conteúdo:\n\n```\n[Socket]\nListenStream=\nListenDatagram=\nListenStream=127.0.0.1:53000\nListenStream=[::1]:53000\nListenDatagram=127.0.0.1:53000\nListenDatagram=[::1]:53000\n```\n\nQuando as consultas são encaminhadas do cache DNS local para 53000, dnscrypt-proxy.socket vai iniciar dnscrypt-proxy.service.\n\nMétodo do serviço\n\nEdite a opção listen_addresses em /etc/dnscrypt-proxy/dnscrypt-proxy.toml com o seguinte:\n\n```\nlisten_addresses = ['127.0.0.1:53000', '[::1]:53000']\n```\n\n"
    },
    {
      "title": "Exemplo de configurações de cache de DNS local",
      "level": 4,
      "content": "As seguintes configurações devem funcionar com dnscrypt-proxy e assumir que ele está escutando na porta 53000.\n\nConfigure Unbound ao seu gosto (em particular, veja Unbound#Local DNS server) e adicione as seguintes linhas ao final da seção server em /etc/unbound/unbound.conf:\n\n```\ndo-not-query-localhost: no\nforward-zone:\n  name: \".\"\n  forward-addr: ::1@53000\n  forward-addr: 127.0.0.1@53000\n```\n\nReinicie unbound.service para aplicar as alterações.\n\nConfigure o dnsmasq como um cache DNS local. A configuração básica para trabalhar com dnscrypt-proxy:\n\n```\n/etc/dnsmasq.conf\n```\n\n```\nno-resolv\nserver=::1#53000\nserver=127.0.0.1#53000\nlisten-address=::1,127.0.0.1\n```\n\nSe você configurou o dnscrypt-proxy para usar um resolvedor com a validação DNSSEC ativada, certifique-se de ativá-lo também no dnsmasq:\n\n```\n/etc/dnsmasq.conf\n```\n\n```\nconf-file=/usr/share/dnsmasq/trust-anchors.conf\ndnssec\n```\n\nReinicie dnsmasq.service para aplicar as configurações.\n\nInstale o pdnsd. Uma configuração básica para trabalhar com o dnscrypt-proxy é:\n\n```\n/etc/pdnsd.conf\n```\n\n```\nglobal {\n    perm_cache = 1024;\n    cache_dir = \"/var/cache/pdnsd\";\n    run_as = \"pdnsd\";\n    server_ip = 127.0.0.1;\n    status_ctl = on;\n    query_method = udp_tcp;\n    min_ttl = 15m;       # Retain cached entries at least 15 minutes.\n    max_ttl = 1w;        # One week.\n    timeout = 10;        # Global timeout option (10 seconds).\n    neg_domain_pol = on;\n    udpbufsize = 1024;   # Upper limit on the size of UDP messages.\n}\n\nserver {\n    label = \"dnscrypt-proxy\";\n    ip = 127.0.0.1;\n    port = 53000;\n    timeout = 4;\n    proxy_only = on;\n}\n\nsource {\n    owner = localhost;\n    file = \"/etc/hosts\";\n}\n```\n\nReinicie pdnsd.service para aplicar as configurações.\n\n"
    },
    {
      "title": "Sandboxing",
      "level": 3,
      "content": "Edite o dnscrypt-proxy.service para incluir as seguintes linhas:\n\n```\n[Service]\nCapabilityBoundingSet=CAP_IPC_LOCK CAP_SETGID CAP_SETUID CAP_NET_BIND_SERVICE\nProtectSystem=strict\nProtectHome=true\nProtectKernelTunables=true\nProtectKernelModules=true\nProtectControlGroups=true\nPrivateTmp=true\nPrivateDevices=true\nMemoryDenyWriteExecute=true\nNoNewPrivileges=true\nRestrictRealtime=true\nRestrictAddressFamilies=AF_INET AF_INET6\nSystemCallArchitectures=native\nSystemCallFilter=~@clock @cpu-emulation @debug @keyring @ipc @module @mount @obsolete @raw-io\n```\n\nVeja systemd.exec(5) e Systemd (Português)#Usando ambientes de aplicativos em sandbox para mais informações.\n\n"
    },
    {
      "title": "Habilitar EDNS0",
      "level": 3,
      "content": "Extension Mechanisms for DNS que, junto com outras coisas, permitem que um cliente especifique quão grande uma resposta por UDP pode ser.\n\nAdicione a linha a seguir ao /etc/resolv.conf:\n\n```\noptions edns0\n```\n\nVocê também pode querer acrescentar o seguinte ao /etc/dnscrypt-proxy.conf:\n\n```\nEDNSPayloadSize bytes\n```\n\nsendo bytes um número de bytes, com valor padrão de 1252 e com valores máximos até 4096 bytes sendo supostamente seguros. Um valor abaixo ou igual a 512 bytes desativará este mecanismo, a menos que um cliente envie um pacote com uma seção OPT fornecendo um tamanho de carga útil.\n\n"
    },
    {
      "title": "Testar EDNS0",
      "level": 4,
      "content": "Use o Servidor de teste de tamanho de resposta do DNS, use a ferramenta de linha de comando drill para emitir uma consulta TXT para o nome rs.dns-oarc.net:\n\n```\n$ drill rs.dns-oarc.net TXT\n```\n\nCaso haja suporte a EDNS0, a \"answer section\" da saída deve ser parecer com isso:\n\n```\nrst.x3827.rs.dns-oarc.net.\nrst.x4049.x3827.rs.dns-oarc.net.\nrst.x4055.x4049.x3827.rs.dns-oarc.net.\n\"2a00:d880:3:1::a6c1:2e89 DNS reply size limit is at least 4055 bytes\"\n\"2a00:d880:3:1::a6c1:2e89 sent EDNS buffer size 4096\"\n```\n\n"
    }
  ]
}